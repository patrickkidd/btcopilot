{% extends "therapist_base.html" %}
{% block content %}
<div class="level">
    <div class="level-left">
        <div class="level-item">
            <div>
                <h1 class="title">Admin: All Audit Feedback</h1>
                <p class="subtitle">Complete overview of auditor feedback</p>
            </div>
        </div>
    </div>
    <div class="level-right">
        <div class="level-item">
            <div class="field is-grouped">
                <p class="control">
                    <button class="button is-light" onclick="location.reload()">
                        <span class="icon"><i class="fas fa-refresh"></i></span>
                        <span>Refresh</span>
                    </button>
                </p>
            </div>
        </div>
    </div>
</div>

{% if not datapoints %}
<div class="notification is-warning">
    <strong>No feedback submitted yet.</strong><br>
    Auditors need to review AI responses before feedback will appear here.
</div>
{% else %}

<!-- Summary Cards -->
<div class="columns">
    <div class="column">
        <div class="box has-text-centered">
            <p class="heading">Total Datapoints</p>
            <p class="title">{{ datapoints|length }}</p>
        </div>
    </div>
    <div class="column">
        <div class="box has-text-centered">
            <p class="heading">Conversation Reviews</p>
            <p class="title">{{ datapoints|selectattr('data_type', 'equalto', 'conversation')|list|length }}</p>
        </div>
    </div>
    <div class="column">
        <div class="box has-text-centered">
            <p class="heading">Extraction Datapoints</p>
            <p class="title">{{ datapoints|rejectattr('data_type', 'equalto', 'conversation')|list|length }}</p>
        </div>
    </div>
    <div class="column">
        <div class="box has-text-centered">
            <p class="heading">Issues Flagged</p>
            <p class="title has-text-danger">{{ datapoints|selectattr('thumbs_down', 'equalto', true)|list|length }}</p>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="box has-background-light">
    <h2 class="subtitle">Filters</h2>
    <div class="columns is-multiline">
        <!-- Basic Filters - Reordered to match table columns -->
        <div class="column is-3">
            <div class="field">
                <label class="label is-small">User</label>
                <div class="control">
                    <input class="input" type="text" id="userFilter" placeholder="Search username..." onkeyup="filterTable()">
                </div>
            </div>
        </div>
        
        <div class="column is-3">
            <div class="field">
                <label class="label is-small">Auditor</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id="auditorFilter" onchange="filterTable()">
                            <option value="">All Auditors</option>
                            {% for auditor in datapoints|map(attribute='auditor_id')|unique|sort %}
                            <option value="{{ auditor }}">{{ auditor }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="column is-3">
            <div class="field">
                <label class="label is-small">Data Type</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id="dataTypeFilter" onchange="filterTable()">
                            <option value="">All Types</option>
                            <option value="conversation">Conversation</option>
                            <option value="person">Person</option>
                            <option value="symptom">Symptom</option>
                            <option value="anxiety">Anxiety</option>
                            <option value="functioning">Functioning</option>
                            <option value="relationship">Relationship</option>
                            <option value="deletion">Deletion</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="column is-3">
            <div class="field">
                <label class="label is-small">Rating</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id="thumbsFilter" onchange="filterTable()">
                            <option value="">All Ratings</option>
                            <option value="true">Issues Only (üëé)</option>
                            <option value="false">No Issues (üëç)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Person-specific filters -->
        <div class="column is-3" id="personFilters" style="display: none;">
            <div class="field">
                <label class="label is-small">Person Details</label>
                <div class="control">
                    <label class="checkbox">
                        <input type="checkbox" id="hasOffspringFilter" onchange="filterTable()">
                        Has Offspring
                    </label>
                </div>
                <div class="control">
                    <label class="checkbox">
                        <input type="checkbox" id="hasSpousesFilter" onchange="filterTable()">
                        Has Spouses
                    </label>
                </div>
                <div class="control">
                    <label class="checkbox">
                        <input type="checkbox" id="hasParentsFilter" onchange="filterTable()">
                        Has Parents
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Variable shift filters -->
        <div class="column is-3" id="shiftFilters" style="display: none;">
            <div class="field">
                <label class="label is-small">Shift Direction</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id="shiftFilter" onchange="filterTable()">
                            <option value="">Any</option>
                            <option value="up">Up</option>
                            <option value="down">Down</option>
                            <option value="same">Same</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Relationship type filter -->
        <div class="column is-3" id="relationshipFilters" style="display: none;">
            <div class="field">
                <label class="label is-small">Relationship Type</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id="relationshipTypeFilter" onchange="filterTable()">
                            <option value="">Any</option>
                            <option value="triangle">Triangle</option>
                            <option value="distance">Distance</option>
                            <option value="conflict">Conflict</option>
                            <option value="reciprocity">Reciprocity</option>
                            <option value="child-focus">Child Focus</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Deletion filter -->
        <div class="column is-3" id="deletionFilters" style="display: none;">
            <div class="field">
                <label class="label is-small">Deletions</label>
                <div class="control">
                    <label class="checkbox">
                        <input type="checkbox" id="hasDeletionsFilter" onchange="filterTable()">
                        Has Deletions
                    </label>
                </div>
            </div>
        </div>
        
        <div class="column is-12">
            <div class="field is-grouped">
                <p class="control">
                    <button class="button is-light" onclick="clearFilters()">
                        <span class="icon"><i class="fas fa-times"></i></span>
                        <span>Clear Filters</span>
                    </button>
                </p>
                <p class="control is-expanded"></p>
                <p class="control">
                    <button class="button is-success" onclick="downloadFilteredData()">
                        <span class="icon"><i class="fas fa-download"></i></span>
                        <span>Download JSON</span>
                    </button>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Datapoints Table -->
<div class="table-container">
    <table class="table is-fullwidth is-striped is-hoverable" id="datapointsTable">
        <thead>
            <tr>
                <th>Discussion</th>
                <th>User</th>
                <th>Auditor</th>
                <th>Data Type</th>
                <th>Details</th>
                <th>Rating</th>
                <th>Comment</th>
                <th>Submitted</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for dp in datapoints %}
            <tr data-username="{{ dp.user.username or 'User #' + dp.user.id|string }}"
                data-auditor="{{ dp.auditor_id }}" 
                data-thumbs-down="{{ dp.thumbs_down|lower }}" 
                data-data-type="{{ dp.data_type }}"
                data-shift="{{ dp.get('shift', '') }}"
                data-relationship-type="{{ dp.get('relationship_type', '') }}"
                data-has-offspring="{{ dp.get('has_offspring', false)|lower }}"
                data-has-spouses="{{ dp.get('has_spouses', false)|lower }}"
                data-has-parents="{{ dp.get('has_parents', false)|lower }}"
                data-has-deletions="{{ (dp.data_type == 'deletion')|lower }}">
                <td>
                    <a href="{{ url_for('training.discussions.audit', discussion_id=dp.discussion_id) }}" class="has-text-link">
                        #{{ dp.discussion_id }}
                    </a>
                </td>
                <td>
                    <span class="tag is-light">
                        {{ dp.user.username or 'User #' + dp.user.id|string }}
                    </span>
                </td>
                <td>
                    <span class="tag is-light">{{ dp.auditor_id }}</span>
                </td>
                <td>
                    {% if dp.data_type == 'conversation' %}
                        <span class="tag is-info">Conversation</span>
                    {% elif dp.data_type == 'person' %}
                        <span class="tag is-primary">Person</span>
                    {% elif dp.data_type == 'symptom' %}
                        <span class="tag is-danger">Symptom</span>
                    {% elif dp.data_type == 'anxiety' %}
                        <span class="tag is-warning">Anxiety</span>
                    {% elif dp.data_type == 'functioning' %}
                        <span class="tag is-success">Functioning</span>
                    {% elif dp.data_type == 'relationship' %}
                        <span class="tag is-info">Relationship</span>
                    {% elif dp.data_type == 'deletion' %}
                        <span class="tag is-dark">Deletion</span>
                    {% endif %}
                </td>
                <td>
                    {% if dp.data_type == 'person' %}
                        <strong>{{ dp.person_name }}</strong><br>
                        <div class="tags">
                            {% if dp.has_offspring %}
                                <span class="tag is-small">Offspring</span>
                            {% endif %}
                            {% if dp.has_spouses %}
                                <span class="tag is-small">Spouses</span>
                            {% endif %}
                            {% if dp.has_parents %}
                                <span class="tag is-small">Parents</span>
                            {% endif %}
                        </div>
                    {% elif dp.data_type in ['symptom', 'anxiety', 'functioning'] %}
                        <span class="tag {% if dp.shift == 'up' %}is-success{% elif dp.shift == 'down' %}is-danger{% elif dp.shift == 'same' %}is-light{% else %}is-dark{% endif %}">
                            {{ dp.shift|upper }}
                        </span>
                        {% if dp.event_description %}
                            <br><small class="has-text-grey">{{ dp.event_description }}</small>
                        {% endif %}
                    {% elif dp.data_type == 'relationship' %}
                        <span class="tag is-link">{{ dp.relationship_type|replace('-', ' ')|title }}</span>
                        {% if dp.event_description %}
                            <br><small class="has-text-grey">{{ dp.event_description }}</small>
                        {% endif %}
                    {% elif dp.data_type == 'deletion' %}
                        <span class="tag is-dark">{{ dp.deletion_count }} items</span>
                    {% elif dp.data_type == 'conversation' %}
                        <span class="has-text-grey">Full conversation review</span>
                    {% endif %}
                </td>
                <td>
                    {% if dp.thumbs_down %}
                        <span class="tag is-danger">üëé Issue</span>
                    {% else %}
                        <span class="tag is-success">üëç OK</span>
                    {% endif %}
                </td>
                <td>
                    {% if dp.comment %}
                        <div class="content is-small">
                            {{ dp.comment|truncate(100) }}
                            {% if dp.comment|length > 100 %}
                            <button class="button is-small is-text" onclick="showFullComment('{{ dp.feedback.id }}')">
                                Show more...
                            </button>
                            <div id="full-comment-{{ dp.feedback.id }}" style="display: none;">
                                <hr>
                                <strong>Full comment:</strong><br>
                                {{ dp.comment }}
                            </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <span class="has-text-grey">-</span>
                    {% endif %}
                </td>
                <td>
                    <small>{{ dp.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                </td>
                <td>
                    <a class="button is-small is-light" 
                       href="{{ url_for('training.discussions.audit', discussion_id=dp.discussion_id) }}#message-{{ dp.statement_id }}"
                       title="View message">
                        <span class="icon is-small"><i class="fas fa-eye"></i></span>
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endif %}

<script>
// Show/hide dynamic filters based on data type selection
document.getElementById('dataTypeFilter').addEventListener('change', function() {
    const value = this.value;
    
    // Hide all dynamic filters
    document.getElementById('personFilters').style.display = 'none';
    document.getElementById('shiftFilters').style.display = 'none';
    document.getElementById('relationshipFilters').style.display = 'none';
    document.getElementById('deletionFilters').style.display = 'none';
    
    // Show relevant filters
    if (value === 'person') {
        document.getElementById('personFilters').style.display = 'block';
    } else if (['symptom', 'anxiety', 'functioning'].includes(value)) {
        document.getElementById('shiftFilters').style.display = 'block';
    } else if (value === 'relationship') {
        document.getElementById('relationshipFilters').style.display = 'block';
    } else if (value === 'deletion') {
        document.getElementById('deletionFilters').style.display = 'block';
    }
});

function filterTable() {
    const userFilter = document.getElementById('userFilter').value.toLowerCase();
    const auditorFilter = document.getElementById('auditorFilter').value;
    const thumbsFilter = document.getElementById('thumbsFilter').value;
    const dataTypeFilter = document.getElementById('dataTypeFilter').value;
    const shiftFilter = document.getElementById('shiftFilter').value;
    const relationshipTypeFilter = document.getElementById('relationshipTypeFilter').value;
    const hasOffspringFilter = document.getElementById('hasOffspringFilter').checked;
    const hasSpousesFilter = document.getElementById('hasSpousesFilter').checked;
    const hasParentsFilter = document.getElementById('hasParentsFilter').checked;
    const hasDeletionsFilter = document.getElementById('hasDeletionsFilter').checked;
    
    const table = document.getElementById('datapointsTable');
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        let show = true;
        
        // Basic filters
        if (userFilter && !row.dataset.username.toLowerCase().includes(userFilter)) {
            show = false;
        }
        
        if (auditorFilter && row.dataset.auditor !== auditorFilter) {
            show = false;
        }
        
        if (thumbsFilter && row.dataset.thumbsDown !== thumbsFilter) {
            show = false;
        }
        
        if (dataTypeFilter && row.dataset.dataType !== dataTypeFilter) {
            show = false;
        }
        
        // Dynamic filters
        if (dataTypeFilter === 'person') {
            if (hasOffspringFilter && row.dataset.hasOffspring !== 'true') {
                show = false;
            }
            if (hasSpousesFilter && row.dataset.hasSpouses !== 'true') {
                show = false;
            }
            if (hasParentsFilter && row.dataset.hasParents !== 'true') {
                show = false;
            }
        } else if (['symptom', 'anxiety', 'functioning'].includes(dataTypeFilter)) {
            if (shiftFilter && row.dataset.shift !== shiftFilter) {
                show = false;
            }
        } else if (dataTypeFilter === 'relationship') {
            if (relationshipTypeFilter && row.dataset.relationshipType !== relationshipTypeFilter) {
                show = false;
            }
        } else if (dataTypeFilter === 'deletion') {
            if (hasDeletionsFilter && row.dataset.hasDeletions !== 'true') {
                show = false;
            }
        }
        
        row.style.display = show ? '' : 'none';
    });
}

function clearFilters() {
    document.getElementById('userFilter').value = '';
    document.getElementById('auditorFilter').value = '';
    document.getElementById('thumbsFilter').value = '';
    document.getElementById('dataTypeFilter').value = '';
    document.getElementById('shiftFilter').value = '';
    document.getElementById('relationshipTypeFilter').value = '';
    document.getElementById('hasOffspringFilter').checked = false;
    document.getElementById('hasSpousesFilter').checked = false;
    document.getElementById('hasParentsFilter').checked = false;
    document.getElementById('hasDeletionsFilter').checked = false;
    
    // Hide all dynamic filters
    document.getElementById('personFilters').style.display = 'none';
    document.getElementById('shiftFilters').style.display = 'none';
    document.getElementById('relationshipFilters').style.display = 'none';
    document.getElementById('deletionFilters').style.display = 'none';
    
    filterTable();
}

function showFullComment(id) {
    const element = document.getElementById('full-comment-' + id);
    element.style.display = element.style.display === 'none' ? 'block' : 'none';
}

function downloadFilteredData() {
    // Collect current filter values
    const filters = {};
    
    // Basic filters
    const userFilter = document.getElementById('userFilter').value;
    const auditorFilter = document.getElementById('auditorFilter').value;
    const thumbsFilter = document.getElementById('thumbsFilter').value;
    const dataTypeFilter = document.getElementById('dataTypeFilter').value;
    
    if (userFilter) filters.user = userFilter;
    if (auditorFilter) filters.auditor = auditorFilter;
    if (thumbsFilter) filters.thumbs_down = thumbsFilter;
    if (dataTypeFilter) filters.data_type = dataTypeFilter;
    
    // Dynamic filters based on data type
    if (dataTypeFilter === 'person') {
        if (document.getElementById('hasOffspringFilter').checked) {
            filters.has_offspring = 'true';
        }
        if (document.getElementById('hasSpousesFilter').checked) {
            filters.has_spouses = 'true';
        }
        if (document.getElementById('hasParentsFilter').checked) {
            filters.has_parents = 'true';
        }
    } else if (['symptom', 'anxiety', 'functioning'].includes(dataTypeFilter)) {
        const shiftFilter = document.getElementById('shiftFilter').value;
        if (shiftFilter) filters.shift = shiftFilter;
    } else if (dataTypeFilter === 'relationship') {
        const relationshipTypeFilter = document.getElementById('relationshipTypeFilter').value;
        if (relationshipTypeFilter) filters.relationship_type = relationshipTypeFilter;
    } else if (dataTypeFilter === 'deletion') {
        if (document.getElementById('hasDeletionsFilter').checked) {
            filters.has_deletions = 'true';
        }
    }
    
    // Count visible rows to show user what will be downloaded
    const table = document.getElementById('datapointsTable');
    const visibleRows = table.querySelectorAll('tbody tr:not([style*="display: none"])');
    const visibleCount = visibleRows.length;
    
    // Build query string
    const queryParams = new URLSearchParams(filters);
    const downloadUrl = `{{ url_for('training.feedback.download') }}?${queryParams.toString()}`;
    
    // Show loading state with count
    const downloadBtn = event.target.closest('button');
    const originalContent = downloadBtn.innerHTML;
    downloadBtn.innerHTML = `<span class="icon"><i class="fas fa-spinner fa-spin"></i></span><span>Downloading ${visibleCount} items...</span>`;
    downloadBtn.disabled = true;
    
    // Create a temporary link to trigger download
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.style.display = 'none';
    document.body.appendChild(link);
    
    // Trigger download and restore button state after a delay
    link.click();
    document.body.removeChild(link);
    
    setTimeout(() => {
        downloadBtn.innerHTML = originalContent;
        downloadBtn.disabled = false;
        
        // Show success notification
        const notification = document.createElement('div');
        notification.className = 'notification is-success is-light';
        notification.innerHTML = `
            <button class="delete" onclick="this.parentElement.remove()"></button>
            <strong>Download Complete!</strong><br>
            Successfully downloaded ${visibleCount} datapoints as JSON.
        `;
        
        // Insert notification at the top of the page
        const firstBox = document.querySelector('.box');
        firstBox.parentNode.insertBefore(notification, firstBox);
        
        // Auto-remove notification after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }, 2000);
}

// Add Font Awesome for icons
if (!document.querySelector('link[href*="font-awesome"]')) {
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css';
    document.head.appendChild(link);
}
</script>
{% endblock %}