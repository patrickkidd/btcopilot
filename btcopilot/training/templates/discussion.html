{% extends "base.html" %}
{% block content %}

<script>
// Make diagram people data available to JavaScript
// NOTE: Only includes base diagram people, NOT cumulative PDP people
// Cumulative PDP people come from cumulativePdp which is filtered by selected auditor
window.diagramPeople = [
{% if discussion.diagram %}
    {% set database = discussion.diagram.get_diagram_data() %}
    {% for person in database.people %}
    {
        id: {{ person.id }},
        name: {{ person.name | tojson }}
    }{{ "," if not loop.last else "" }}
    {% endfor %}
{% endif %}
];

// Make diagram events data available to JavaScript
window.diagramEvents = [
{% if discussion.diagram %}
    {% set database = discussion.diagram.get_diagram_data() %}
    {% for event in database.events %}
    {
        id: {{ event.id }},
        description: {{ event.description | tojson }}
    }{{ "," if not loop.last else "" }}
    {% endfor %}
{% endif %}
];

// User and auditor info for access control
window.isAdmin = {{ 'true' if current_user.has_role(btcopilot.ROLE_ADMIN) else 'false' }};
window.selectedAuditor = {{ selected_auditor | tojson }};
window.currentUsername = {{ current_user.username | tojson }};

// Server-side configuration for external JavaScript
window.discussionConfig = {
    discussionId: {{ discussion.id }},
    isExtracting: {{ 'true' if discussion.extracting else 'false' }},
    currentAuditor: {{ current_auditor | tojson }},
    urls: {
        speakersUpdate: "{{ url_for('training.speakers.update', speaker_id=0) }}"
    }
};
</script>

<style>
/* Speaker-specific color variations - iPhone Messages app theme with more noticeable differences */

/* User message bubbles - Striking blue variations while staying in blue spectrum */
.user-message-bubble.speaker-1 { background: #007AFF; color: white; } /* iPhone Messages blue (base) */
.user-message-bubble.speaker-2 { background: #ADD8E6; color: black; } /* Light blue - pastel with black text */
.user-message-bubble.speaker-3 { background: #001F3F; color: white; } /* Navy blue - very dark */
.user-message-bubble.speaker-4 { background: #89CFF0; color: black; } /* Baby blue - very light with black text */
.user-message-bubble.speaker-5 { background: #0047AB; color: white; } /* Cobalt blue - rich dark */
.user-message-bubble.speaker-6 { background: #66B3FF; color: black; } /* Sky blue - bright light with black text */
.user-message-bubble.speaker-7 { background: #191970; color: white; } /* Midnight blue - darkest */
.user-message-bubble.speaker-8 { background: #87CEEB; color: black; } /* Sky blue - medium light with black text */

/* AI message bubbles - iPhone grey with more distinct variations */
.ai-message-bubble.speaker-1 { background: #E9E9EB; border-color: #D1D1D6; } /* iPhone Messages grey (base) */
.ai-message-bubble.speaker-2 { background: #F2F2F7; border-color: #E5E5EA; } /* Lighter grey */
.ai-message-bubble.speaker-3 { background: #E5E5EA; border-color: #D1D1D6; } /* Medium grey */
.ai-message-bubble.speaker-4 { background: #F0F0F5; border-color: #E0E0E5; } /* Off-white grey */
.ai-message-bubble.speaker-5 { background: #EBEBF0; border-color: #D6D6DB; } /* Cool grey */
.ai-message-bubble.speaker-6 { background: #F5F5F8; border-color: #E8E8ED; } /* Warm grey */
.ai-message-bubble.speaker-7 { background: #EFEFF4; border-color: #DCDCE1; } /* Neutral grey */
.ai-message-bubble.speaker-8 { background: #E8E8ED; border-color: #CFCFD4; } /* Darker grey */

/* Expanded AI message bubbles - maintain iPhone style with green highlight */
.ai-message-bubble.expanded.speaker-1 { background: #FFFFFF; border-color: #34C759; } /* iPhone green */
.ai-message-bubble.expanded.speaker-2 { background: #FEFEFF; border-color: #34C759; }
.ai-message-bubble.expanded.speaker-3 { background: #FDFDFE; border-color: #34C759; }
.ai-message-bubble.expanded.speaker-4 { background: #FCFCFD; border-color: #34C759; }
.ai-message-bubble.expanded.speaker-5 { background: #FAFAFB; border-color: #34C759; }
.ai-message-bubble.expanded.speaker-6 { background: #F9F9FA; border-color: #34C759; }
.ai-message-bubble.expanded.speaker-7 { background: #F8F8F9; border-color: #34C759; }
.ai-message-bubble.expanded.speaker-8 { background: #F7F7F8; border-color: #34C759; }

/* Relationship field horizontal layout - Override Bulma CSS with high specificity */
.mechanism-details,
.triangle-details {
    display: flex !important;
    flex-direction: column !important;
    gap: 0.5rem;
}

.mechanism-field,
.triangle-field {
    display: flex !important;
    align-items: center !important;
    gap: 0.5rem !important;
    flex-wrap: nowrap !important;
}

.field-label {
    flex-shrink: 0 !important;
    min-width: fit-content !important;
    color: #666;
    display: inline-block !important;
}

.relationship-people-container {
    display: flex !important;
    align-items: center !important;
    gap: 0.25rem !important;
    flex-wrap: wrap !important;
    flex: 1 !important;
}

/* Critical: Ensure template elements don't break layout */
.relationship-people-container template {
    display: contents !important;
}

/* Admin-only statement ID styling - matches PDP delta ID styling */
.admin-statement-id {
    background: #ddd;
    color: #444444;
    padding: 1px 4px;
    font-size: 0.65rem;
    border-radius: 2px;
    font-family: monospace;
    opacity: 0.7;
    margin-left: 4px;
}

[data-theme="dark"] .admin-statement-id {
    background: #282625;
    color: #e0e0e0;
}

/* Override any Bulma div defaults that might cause stacking */
.mechanism-field > div,
.triangle-field > div {
    display: flex !important;
    align-items: center !important;
    gap: 0.25rem !important;
}

.person-tag {
    display: inline-flex !important;
    align-items: center !important;
    gap: 0.25rem !important;
    padding: 0.125rem 0.5rem !important;
    background: #e8f4ff !important;
    border: 1px solid #b3d9ff !important;
    border-radius: 4px !important;
    font-size: 0.85rem !important;
    white-space: nowrap !important;
    margin: 0 !important;
    max-width: 100% !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}

.person-tag.editable {
    cursor: pointer !important;
}

.person-tag.editable:hover {
    background: #d1e9ff !important;
    border-color: #80bfff !important;
}

.person-tag .delete-person {
    margin-left: 0.25rem !important;
    color: #ff4444 !important;
    cursor: pointer !important;
    font-size: 0.75rem !important;
}

.person-tag .delete-person:hover {
    color: #ff0000 !important;
}

/* Ensure each mechanism field is on its own row but content within is horizontal */
.mechanism-details .mechanism-field,
.triangle-details .triangle-field {
    margin-bottom: 0.25rem !important;
    width: 100% !important;
}

/* Remove all borders from extracted data tables */
.extracted-data-component table,
.extracted-data-component table td,
.extracted-data-component table tr {
    border: none !important;
}

/* Compact date input styling */
input[type="date"].input.is-small {
    padding-right: 0.5rem !important;
}

input[type="date"].input.is-small::-webkit-calendar-picker-indicator {
    margin-left: 0 !important;
    padding: 0 !important;
}

/* Refresh Warning Badge */
.refresh-warning-badge {
    position: fixed;
    top: 80px;
    right: 20px;
    background-color: hsl(44, 100%, 77%);
    color: rgba(0, 0, 0, 0.7);
    padding: 12px 20px;
    border-radius: 6px;
    box-shadow: 0 2px 3px rgba(10, 10, 10, 0.1), 0 0 0 1px rgba(10, 10, 10, 0.1);
    z-index: 1000;
    cursor: pointer;
    display: none;
    font-weight: 500;
    font-size: 14px;
    transition: all 0.2s ease;
    border: 1px solid hsl(44, 100%, 70%);
}

.refresh-warning-badge:hover {
    background-color: hsl(44, 100%, 72%);
    box-shadow: 0 4px 6px rgba(10, 10, 10, 0.15), 0 0 0 1px rgba(10, 10, 10, 0.1);
    transform: translateY(-1px);
}

.refresh-warning-badge .icon {
    margin-right: 8px;
}

/* Dark mode styling - Family Diagram style */
[data-theme="dark"] .field-label {
    color: var(--color-fg-muted) !important;
}

[data-theme="dark"] .data-cell,
[data-theme="dark"] .chat-cell {
    border-color: var(--color-border-default);
    background-color: var(--color-card-bg);
}

[data-theme="dark"] .audit-messages-table td {
    border-color: var(--color-border-default);
}

/* Softer button colors for dark mode */
[data-theme="dark"] .button.is-outlined.is-danger {
    border-color: rgba(255, 107, 107, 0.5);
    color: rgba(255, 107, 107, 0.9);
}

[data-theme="dark"] .button.is-outlined.is-danger:hover {
    background-color: rgba(255, 107, 107, 0.1);
    border-color: rgba(255, 107, 107, 0.7);
}

[data-theme="dark"] .button.is-outlined.is-info {
    border-color: rgba(76, 175, 237, 0.5);
    color: rgba(76, 175, 237, 0.9);
}

[data-theme="dark"] .button.is-outlined.is-info:hover {
    background-color: rgba(76, 175, 237, 0.1);
    border-color: rgba(76, 175, 237, 0.7);
}

[data-theme="dark"] .button.is-outlined.is-primary {
    border-color: rgba(252, 245, 201, 0.5);
    color: var(--color-accent-fg);
}

[data-theme="dark"] .button.is-outlined.is-primary:hover {
    background-color: rgba(252, 245, 201, 0.1);
    border-color: rgba(252, 245, 201, 0.7);
}

/* Softer tag colors for dark mode */
[data-theme="dark"] .tag.is-success {
    background-color: rgba(144, 238, 144, 0.25);
    color: rgb(144, 238, 144);
}

/* Person tags for dark mode */
[data-theme="dark"] .person-tag {
    background: rgba(232, 244, 255, 0.15) !important;
    border-color: rgba(179, 217, 255, 0.3) !important;
    color: var(--color-accent-fg) !important;
}

[data-theme="dark"] .person-tag.editable:hover {
    background: rgba(209, 233, 255, 0.25) !important;
    border-color: rgba(128, 191, 255, 0.5) !important;
}

</style>

<!-- Refresh Warning Badge -->
<div id="refresh-warning-badge" class="refresh-warning-badge" onclick="refreshPagePreservingScroll()">
    <span class="icon"><i class="fas fa-sync-alt"></i></span>
    <span>Pending changes requiring refresh</span>
</div>

<div class="is-flex is-justify-content-space-between is-align-items-stretch is-flex-wrap-wrap mb-4" style="gap: 0.75rem;">
    <!-- Left side: Date, tags, and action buttons -->
    <div class="is-flex is-flex-direction-column is-justify-content-space-between" style="gap: 0.5rem;">
        <div class="is-flex is-align-items-center is-flex-wrap-wrap" style="gap: 0.75rem;">
            <div class="field has-addons mb-0">
                <p class="control">
                    <a class="button is-small is-static">
                        Discussion Date
                    </a>
                </p>
                <p class="control">
                    <input type="date"
                           class="input is-small"
                           id="discussion-date-input"
                           value="{{ discussion.discussion_date.isoformat() if discussion.discussion_date else '' }}"
                           onchange="saveDiscussionDate({{ discussion.id }}, this.value)"
                           style="width: 150px;">
                </p>
            </div>
            <div class="tags mb-0">
                {% if discussion.synthetic %}
                <span class="tag is-warning" title="Persona: {{ discussion.synthetic_persona.name if discussion.synthetic_persona else 'Unknown' }}">
                    <span class="icon is-small"><i class="fas fa-robot"></i></span>
                    <span>Synthetic</span>
                </span>
                {% endif %}
                {% set ai_messages = statements|selectattr('statement.speaker.type', 'equalto', 'expert')|list %}
                <span class="tag is-success">{{ ai_messages|length }} AI responses</span>
            </div>
            {% if has_approved_gt %}
            <a href="{{ url_for('training.analysis.discussion_analysis', discussion_id=discussion.id) }}"
               class="button is-small is-outlined is-info">
                <span class="icon"><i class="fas fa-chart-line"></i></span>
                <span>View Analysis</span>
            </a>
            {% endif %}
        </div>
        <div class="buttons has-addons mb-0">
            <button id="expand-all-btn" class="button is-small is-outlined" onclick="expandAllMessages()">
                <span class="icon"><i class="fas fa-expand"></i></span>
                <span>Expand All</span>
            </button>
            <button id="collapse-all-btn" class="button is-small is-outlined is-hidden" onclick="collapseAllMessages()">
                <span class="icon"><i class="fas fa-compress"></i></span>
                <span>Collapse All</span>
            </button>
            <div class="dropdown is-hoverable">
                <div class="dropdown-trigger">
                    <button class="button is-small is-outlined is-info" aria-haspopup="true" aria-controls="export-dropdown">
                        <span class="icon"><i class="fas fa-download"></i></span>
                        <span>Export</span>
                        <span class="icon is-small"><i class="fas fa-angle-down"></i></span>
                    </button>
                </div>
                <div class="dropdown-menu" id="export-dropdown" role="menu">
                    <div class="dropdown-content">
                        <a href="{{ url_for('training.discussions.export', discussion_id=discussion.id, mode='statements') }}"
                           class="dropdown-item"
                           title="Export statements only (no extracted data)">
                            <span class="icon"><i class="fas fa-comments"></i></span>
                            <span>Statements Only</span>
                        </a>
                        <a href="{{ url_for('training.discussions.export', discussion_id=discussion.id, mode='full') }}"
                           class="dropdown-item"
                           title="Export with AI extractions and user corrections">
                            <span class="icon"><i class="fas fa-database"></i></span>
                            <span>With Extractions</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Right side: Auditor controls -->
    {% if current_user.has_role(btcopilot.ROLE_ADMIN) and auditor_options %}
    <div class="auditor-controls box p-3 mb-0">
        <div class="select is-fullwidth mb-2">
            <select id="auditor-filter" class="is-small" onchange="handleAuditorChange(this.value)">
                {% for option in auditor_options %}
                <option value="{{ option.id }}" {% if selected_auditor == option.id %}selected{% endif %}>
                    {{ option.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="is-flex is-justify-content-space-between" style="gap: 0.5rem;">
            <button class="button is-small is-outlined is-danger" onclick="clearExtractedData({{ discussion.id }})" style="flex: 1;">
                <span class="icon"><i class="fas fa-trash-alt"></i></span>
                <span>Clear</span>
            </button>
            {% if selected_auditor and selected_auditor != "AI" %}
            <button class="button is-small is-success" onclick="bulkApproveDiscussion()" style="flex: 1;">
                <span class="icon"><i class="fas fa-check-double"></i></span>
                <span>Approve</span>
            </button>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- {% if discussion.summary %}
<div class="notification is-info is-light">
    <strong>Discussion Summary:</strong> {{ discussion.summary }}
</div>
{% endif %} -->

<!-- Speaker mappings are now computed in Python and passed to template -->
{% if unique_speakers %}
<div class="card mb-4">
    <div class="card-header is-clickable" onclick="toggleSpeakerMapping()">
        <h5 class="card-header-title">
            <span class="icon"><i class="fas fa-users"></i></span>
            Speaker Mapping ({{ unique_speakers|length }} speakers detected)
        </h5>
        <button class="card-header-icon">
            <span class="icon" id="speaker-toggle-icon">
                <i class="fas fa-angle-down"></i>
            </span>
        </button>
    </div>
    <div id="speaker-mapping-content" class="card-content" style="display: none;">
        <div class="content">
            <p class="has-text-grey mb-3">Map detected speakers to people in the user's database:</p>
            <table class="table is-fullwidth">
                <thead>
                    <tr>
                        <th>Transcription Speaker</th>
                        <th>Type</th>
                        <th>Person</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for speaker in unique_speakers %}
                    <tr class="speaker-mapping-row" data-speaker-id="{{ speaker.id }}">
                        <td>
                            <strong>{{ speaker.name }}</strong>
                        </td>
                        <td>
                            <div class="select">
                                <select id="speaker-type-{{ speaker.id }}" onchange="updateSpeakerType({{ speaker.id }})">
                                    <option value="subject" {% if speaker.type == 'subject' %}selected{% endif %}>Subject</option>
                                    <option value="expert" {% if speaker.type == 'expert' %}selected{% endif %}>Expert</option>
                                </select>
                            </div>
                        </td>
                        <td>
                            <div class="field has-addons" style="margin-bottom: 0;">
                                <div class="control">
                                    <div class="select">
                                        <select id="person-select-{{ speaker.id }}" onchange="updateSpeakerMapping({{ speaker.id }})">
                                            <option value="">Select a person...</option>
                                            
                                            {# Always show default User and Assistant options #}
                                            <option value="1" {% if speaker.person_id == 1 %}selected{% endif %}>User</option>
                                            <option value="2" {% if speaker.person_id == 2 %}selected{% endif %}>Assistant</option>
                                            
                                            {# Show other people from database (excluding defaults to avoid duplicates) #}
                                            {% if discussion.diagram %}
                                                {% set database = discussion.diagram.get_diagram_data() %}
                                                {% for person in database.people %}
                                                    {% if person.id != 1 and person.id != 2 %}
                                                    <option value="{{ person.id }}" 
                                                            {% if speaker.person_id == person.id %}selected{% endif %}>
                                                        {{ person.name }}
                                                    </option>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                            <option value="new">+ Create new person</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="control">
                                    <button class="button is-info" onclick="showNewPersonModal({{ speaker.id }}, '{{ speaker.name }}')" 
                                            title="Create new person">
                                        <span class="icon is-small">
                                            <i class="fas fa-plus"></i>
                                        </span>
                                    </button>
                                </div>
                            </div>
                            <div id="speaker-status-{{ speaker.id }}" class="help"></div>
                        </td>
                        <td></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Extraction Button -->
        {% if current_user and current_user.has_role(btcopilot.ROLE_ADMIN) %}
        <div class="has-text-centered mt-4 pt-3" style="border-top: 1px solid #dbdbdb;">
            <button id="trigger-extraction-btn" 
                    class="button is-primary" 
                    onclick="triggerExtractionForDiscussion({{ discussion.id }})"
                    disabled>
                <span class="icon">
                    <i class="fas fa-play"></i>
                </span>
                <span>Extract Data</span>
            </button>
            
            <button id="export-test-cases-btn" 
                    class="button is-info ml-2" 
                    onclick="exportTestCases()">
                <span class="icon">
                    <i class="fas fa-download"></i>
                </span>
                <span>Export Test Cases</span>
            </button>
            
            <p class="help has-text-grey mt-2">
                Extract: Only available when all speakers are mapped to people<br>
                Export: Exports all approved test cases to ./model_tests/data/
            </p>
            
            <!-- Progress display (hidden by default) -->
            <div id="extraction-progress" style="display: none;" class="mt-3">
                <div class="extraction-progress-container" style="padding: 2rem; text-align: center;">
                    <div class="icon is-large has-text-primary">
                        <i class="fas fa-cogs fa-pulse fa-3x"></i>
                    </div>
                    <h3 class="title is-5 mt-3">Extracting Data</h3>
                    <progress class="progress is-primary" max="100" id="extraction-progress-bar" value="0"></progress>
                    <p class="subtitle is-6 mt-2" id="extraction-progress-text">Processing statements...</p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Extraction Progress Bar -->
<div id="progress-container" data-discussion-id="{{ discussion.id }}" data-extracting="{{ 'true' if discussion.extracting else 'false' }}"></div>

<!-- New Person Modal -->
<div class="modal" id="new-person-modal">
    <div class="modal-background" onclick="closeNewPersonModal()"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Create New Person</p>
            <button class="delete" onclick="closeNewPersonModal()"></button>
        </header>
        <section class="modal-card-body">
            <div class="field">
                <label class="label">Name</label>
                <div class="control">
                    <input class="input" type="text" id="new-person-name" placeholder="Enter person's name">
                </div>
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" onclick="createNewPerson()">Create Person</button>
            <button class="button" onclick="closeNewPersonModal()">Cancel</button>
        </footer>
    </div>
</div>

<!-- Relationship Person Selector Modal -->
<div class="modal" id="relationship-person-modal">
    <div class="modal-background" onclick="closeRelationshipPersonModal()"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title" id="relationship-person-modal-title">Select Person</p>
            <button class="delete" onclick="closeRelationshipPersonModal()"></button>
        </header>
        <section class="modal-card-body">
            <div class="field">
                <label class="label">Person</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id="relationship-person-select">
                            <!-- Options dynamically populated by showRelationshipPersonModal() -->
                        </select>
                    </div>
                </div>
            </div>
            <div class="field" id="new-person-name-field" style="display: none;">
                <label class="label">New Person Name</label>
                <div class="control">
                    <input class="input" type="text" id="relationship-new-person-name" placeholder="Enter person's name">
                </div>
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" onclick="confirmRelationshipPersonSelection()">Select</button>
            <button class="button" onclick="closeRelationshipPersonModal()">Cancel</button>
        </footer>
    </div>
</div>

<!-- Pair Bond Selector Modal -->
<div class="modal" id="pair-bond-modal">
    <div class="modal-background" onclick="closePairBondModal()"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Select Parents (Pair Bond)</p>
            <button class="delete" onclick="closePairBondModal()"></button>
        </header>
        <section class="modal-card-body">
            <div class="field">
                <label class="label">Existing Pair Bond</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id="pair-bond-select" onchange="togglePairBondMode()">
                            <option value="">-- Select existing pair bond --</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="or-divider" style="text-align: center; margin: 1rem 0; color: #999;">
                OR
            </div>
            <div id="new-pair-bond-fields">
                <div class="field">
                    <label class="label">Create New Pair Bond</label>
                </div>
                <div class="field">
                    <label class="label">Parent A</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="pair-bond-person-a-select">
                                <option value="">-- Select person --</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Parent B</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="pair-bond-person-b-select">
                                <option value="">-- Select person --</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" onclick="confirmPairBondSelection()">Select</button>
            <button class="button" onclick="closePairBondModal()">Cancel</button>
        </footer>
    </div>
</div>

<!-- Add Person Delta Modal -->

<!-- Audit Table Layout -->
<div class="audit-table-container">
    <table class="table is-fullwidth audit-messages-table">
        <thead>
            <tr>
                <th class="audit-header">üí¨ Conversational Flow</th>
                <th class="audit-header">üìä Changes to Notes</th>
                <th class="audit-header">üìù Cumulative Notes</th>
            </tr>
        </thead>
        <tbody>
            {% for item in statements %}
            <tr class="message-row" id="statement-{{ item.statement.id }}" data-message-id="{{ item.statement.id }}">
                
                {% if item.statement.speaker and item.statement.speaker.type == 'subject' %}
                <!-- User Message Row -->
                <td class="chat-cell">
                    <!-- Speaker name above message bubble -->
                    <div class="speaker-name has-text-grey-light is-size-7 mb-1" style="font-size: 10px; text-align: right; font-weight: 500; opacity: 0.7;">
                        {{ item.person_name if item.person_name else item.statement.speaker.name }}
                    </div>
                    <div class="chat-message-container user-message-container">
                        <div class="timestamp-left">
                            <small class="has-text-grey is-size-7">
                                {{ item.statement.created_at.strftime('%H:%M') if item.statement.created_at else '--:--' }}
                                {% if current_user and current_user.has_role(btcopilot.ROLE_ADMIN) %}
                                <span class="admin-statement-id" title="Statement ID">{{ item.statement.id }}</span>
                                {% endif %}
                            </small>
                        </div>
                        <div class="user-message-bubble speaker-{{ subject_speaker_map[item.statement.speaker.id] if item.statement.speaker and item.statement.speaker.type == 'subject' and item.statement.speaker.id in subject_speaker_map else 1 }}">
                            {{ item.statement.text }}
                        </div>
                    </div>
                </td>
                
                <!-- Data cell for Subject statements (where extracted data is stored) -->
                <td class="data-cell">
                    {% set data = item.pdp_deltas %}
                    {% set cumulative_pdp = item.cumulative_pdp %}
                    {% set collapsed = false %}
                    {% set show_feedback = true %}
                    {% set message_id = item.statement.id %}
                    {% set feedback_data = item.ext_feedback %}
                    {% set component_id = item.statement.id %}
                    {% set editable_mode = true %}
                    {% set all_ext_feedback = item.all_ext_feedback or [] %}
                    {% set all_ext_feedback_dict = item.all_ext_feedback_dict or [] %}
                    {% set admin_ext_feedback = item.admin_ext_feedback %}
                    {% set approved = item.approved %}
                    {% set approved_by = item.approved_by %}
                    {% set approved_at = item.approved_at %}
                    {% include "components/sarf_editor.html" %}
                </td>
                
                <!-- Cumulative Notes column for Subject statements -->
                <td class="data-cell">
                    {% if item.cumulative_pdp %}
                        {% set data = item.cumulative_pdp %}
                        {% set cumulative_pdp = item.cumulative_pdp %}
                        {% set collapsed = true %}
                        {% set show_feedback = false %}
                        {% set component_id = item.statement.id %}
                        {% set is_cumulative = true %}
                        {% set editable_mode = false %}
                        {% set onclick_function = 'toggleCumulativeSection' %}
                        {% set id_prefix = 'cumulative' %}
                        {% set feedback_data = none %}
                        {% set all_ext_feedback = [] %}
                        {% set all_ext_feedback_dict = [] %}
                        {% set admin_ext_feedback = none %}
                        {% set approved = false %}
                        {% set approved_by = none %}
                        {% set approved_at = none %}
                        {% include "components/sarf_editor.html" %}
                    {% else %}
                        <div class="user-data-placeholder">
                            <small class="has-text-grey">No cumulative data yet</small>
                        </div>
                    {% endif %}
                </td>
                
                {% else %}
                <!-- AI Message Row -->
                <td class="chat-cell">
                    <!-- Collapsed View -->
                    <div class="collapsed-ai-message" id="chat-collapsed-{{ item.statement.id }}" {% if item.has_conv_feedback or item.has_ext_feedback %}style="display: none;"{% endif %}>
                        <!-- Speaker name above message bubble -->
                        <div class="speaker-name has-text-grey-light is-size-7 mb-1" style="font-size: 10px; text-align: left; font-weight: 500; opacity: 0.7;">
                            {{ item.person_name if item.person_name else (item.statement.speaker.name if item.statement.speaker else 'AI') }}
                        </div>
                        <div class="chat-message-container ai-message-container">
                            <div class="ai-message-bubble speaker-{{ expert_speaker_map[item.statement.speaker.id] if item.statement.speaker and item.statement.speaker.type == 'expert' and item.statement.speaker.id in expert_speaker_map else 1 }} is-clickable" onclick="toggleAIMessage({{ item.statement.id }})">
                                <div class="ai-message-content">
                                    {{ item.statement.text }}
                                    {% if item.has_conv_feedback %}
                                    <span class="tag is-success is-light is-small float-right ml-2">‚úì</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="timestamp-right">
                                <div class="is-flex is-align-items-center">
                                    {% if item.get('is_last_ai', False) %}
                                    <button class="button is-small is-ghost mr-2" 
                                            onclick="event.stopPropagation(); openPromptEditor({{ item.statement.id }})"
                                            title="Edit prompts for this message">
                                        <span class="icon is-small"><i class="fas fa-edit"></i></span>
                                    </button>
                                    {% endif %}
                                    {% if item.statement.custom_prompts %}
                                    <span class="tag is-warning is-small mr-2" 
                                          onclick="event.stopPropagation(); viewPromptDiff({{ item.statement.id }})"
                                          title="Custom prompts used - click to view changes"
                                          style="cursor: pointer;">üìù</span>
                                    {% endif %}
                                    <small class="has-text-grey is-size-7">
                                        {{ item.statement.created_at.strftime('%H:%M') if item.statement.created_at else '--:--' }}
                                        {% if current_user and current_user.has_role(btcopilot.ROLE_ADMIN) %}
                                        <span class="admin-statement-id" title="Statement ID">{{ item.statement.id }}</span>
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Expanded View -->
                    <div class="expanded-ai-message is-clickable" id="chat-expanded-{{ item.statement.id }}" {% if item.has_conv_feedback or item.has_ext_feedback %}style="display: block;"{% else %}style="display: none;"{% endif %} onclick="toggleAIMessage({{ item.statement.id }})">
                        <!-- Speaker name above message bubble -->
                        <div class="speaker-name has-text-grey-light is-size-7 mb-1" style="font-size: 10px; text-align: left; font-weight: 500; opacity: 0.7;">
                            {{ item.person_name if item.person_name else (item.statement.speaker.name if item.statement.speaker else 'AI') }}
                        </div>
                        <div class="chat-message-container ai-message-container">
                            <div class="ai-message-bubble expanded speaker-{{ expert_speaker_map[item.statement.speaker.id] if item.statement.speaker and item.statement.speaker.type == 'expert' and item.statement.speaker.id in expert_speaker_map else 1 }}">
                                <div class="ai-message-content">
                                    {{ item.statement.text }}
                                    <!-- <div class="has-text-right mt-2">
                                        <small class="has-text-grey is-size-7">(click anywhere to collapse)</small>
                                    </div> -->
                                </div>
                            </div>
                            <div class="timestamp-right">
                                <div class="is-flex is-align-items-center">
                                    {% if item.get('is_last_ai', False) %}
                                    <button class="button is-small is-ghost mr-2" 
                                            onclick="event.stopPropagation(); openPromptEditor({{ item.statement.id }})"
                                            title="Edit prompts for this message">
                                        <span class="icon is-small"><i class="fas fa-edit"></i></span>
                                    </button>
                                    {% endif %}
                                    {% if item.statement.custom_prompts %}
                                    <span class="tag is-warning is-small mr-2" 
                                          onclick="event.stopPropagation(); viewPromptDiff({{ item.statement.id }})"
                                          title="Custom prompts used - click to view changes"
                                          style="cursor: pointer;">üìù</span>
                                    {% endif %}
                                    <small class="has-text-grey is-size-7">
                                        {{ item.statement.created_at.strftime('%H:%M') if item.statement.created_at else '--:--' }}
                                        {% if current_user and current_user.has_role(btcopilot.ROLE_ADMIN) %}
                                        <span class="admin-statement-id" title="Statement ID">{{ item.statement.id }}</span>
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Conversation Feedback Controls (Outside bubble) -->
                        <div class="conversation-feedback mt-3 p-3 {% if item.has_conv_feedback %}feedback-submitted{% endif %}" onclick="event.stopPropagation()">
                                    <div x-data="{ 
                                        thumbsDown: false, 
                                        comment: '', 
                                        submitted: {{ 'true' if item.has_conv_feedback else 'false' }} 
                                    }">
                                        {% if item.has_conv_feedback and item.conv_feedback %}
                                        <div class="notification is-success is-light is-small">
                                            <strong>Your feedback:</strong>
                                            {{ 'üëé Needs work' if item.conv_feedback.thumbs_down else '' }}<br>
                                            {% if item.conv_feedback.comment %}
                                            <small>{{ item.conv_feedback.comment }}</small>
                                            {% endif %}
                                            <div class="mt-2 has-text-right">
                                                <button class="button is-small is-danger is-outlined" 
                                                        onclick="deleteFeedback({{ item.conv_feedback.id }}, 'conversation', {{ item.statement.id }})">
                                                    <span class="icon is-small"><i class="fas fa-trash"></i></span>
                                                    <span>Delete</span>
                                                </button>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="field">
                                            <div class="control">
                                                <button class="thumbs-button is-small" 
                                                        :class="{ 'is-active': thumbsDown }"
                                                        @click="thumbsDown = !thumbsDown"
                                                        :disabled="submitted">
                                                    üëé Needs work
                                                </button>
                                            </div>
                                        </div>
                                        <div class="field">
                                            <div class="control">
                                                <textarea class="textarea is-small" 
                                                          x-model="comment"
                                                          placeholder="Comments on conversation flow..."
                                                          rows="2"
                                                          :disabled="submitted"></textarea>
                                            </div>
                                        </div>
                                        <div class="field">
                                            <button class="button is-primary is-small"
                                                    @click="submitFeedback({{ item.statement.id }}, 'conversation', thumbsDown, comment)"
                                                    x-show="!submitted">
                                                Submit
                                            </button>
                                        </div>
                                        {% endif %}
                                    </div>
                        </div>
                    </div>
                </td>
                
                <!-- Data column for Expert statements (Empty placeholder - they don't generate data) -->
                <td class="data-cell"></td>
                
                <!-- Cumulative Notes column for Expert statements (Empty placeholder - they don't generate data) -->
                <td class="data-cell"></td>
                
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Discussion page JavaScript -->
<script src="{{ url_for('training.audit.static', filename='js/discussion.js') }}"></script>

<!-- Data Editor Modal -->
<!-- Prompt Editor Modal -->
<div class="modal" id="promptEditorModal">
    <div class="modal-background" onclick="closePromptEditor()"></div>
    <div class="modal-card" style="width: 95vw; max-width: none; height: 90vh;">
        <header class="modal-card-head">
            <p class="modal-card-title" id="promptModalTitle">Edit System Prompts</p>
            <button class="delete" onclick="closePromptEditor()"></button>
        </header>
        <section class="modal-card-body" style="max-height: none; overflow-y: auto; padding: 30px;">
            <div id="promptEditorContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" id="savePromptsBtn" onclick="saveCustomPrompts()">Save Custom Prompts</button>
            <button class="button is-warning" id="resetPromptsBtn" onclick="resetToDefaults()" style="display: none;">Reset to Defaults</button>
            <button class="button" onclick="closePromptEditor()">Cancel</button>
        </footer>
    </div>
</div>

<!-- Prompt Diff Viewer Modal -->
<div class="modal" id="promptDiffModal">
    <div class="modal-background" onclick="closePromptDiff()"></div>
    <div class="modal-card" style="width: 95vw; max-width: none; height: 90vh; display: flex; flex-direction: column;">
        <header class="modal-card-head">
            <p class="modal-card-title">Prompt Changes Used</p>
            <button class="delete" onclick="closePromptDiff()"></button>
        </header>
        <section class="modal-card-body" style="flex: 1; overflow-y: auto; padding: 30px; max-height: none;">
            <div id="promptDiffContent" style="height: 100%;">
                <!-- Content will be populated by JavaScript -->
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button" onclick="closePromptDiff()">Close</button>
        </footer>
    </div>
</div>

<div class="modal" id="dataEditorModal">
    <div class="modal-background" onclick="closeDataEditor()"></div>
    <div class="modal-card" style="width: 90vw; max-width: 1200px;">
        <header class="modal-card-head">
            <p class="modal-card-title">Improve Extracted Data</p>
            <button class="delete" onclick="closeDataEditor()"></button>
        </header>
        <section class="modal-card-body" style="max-height: 70vh; overflow-y: auto;">
            <div id="dataEditorContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" onclick="saveEditedData()">Save Changes</button>
            <button class="button" onclick="closeDataEditor()">Cancel</button>
        </footer>
    </div>
</div>


{% endblock %}