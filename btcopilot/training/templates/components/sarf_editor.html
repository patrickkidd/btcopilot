{#
SARF Editor Component

Usage:
{% include "components/sarf_editor.html" %}

Parameters:
- data: The extracted data object containing people, events, deletes
- collapsed: Boolean, whether to show collapsed view initially (default: true)
- show_feedback: Boolean, whether to show feedback controls (default: false)
- message_id: Required if show_feedback=true, message ID for feedback submission
- feedback_data: Existing feedback data if any
- component_id: Unique identifier for this component instance (default: random)
- is_cumulative: Boolean, whether this is cumulative data (affects styling) (default: false)
- onclick_function: String, JavaScript function to call on click (default: toggleExtractedData)
- id_prefix: String, prefix for collapsed/expanded IDs (default: data)
- editable_mode: Boolean, whether to enable in-place editing (default: false)
- lazy_init: Boolean, whether to defer Alpine initialization until visible (default: true)
#}


{% if not component_id %}
    {% set component_id = range(10000, 99999) | random %}
{% endif %}
{% if collapsed is not defined %}
    {% set collapsed = true %}
{% endif %}
{% if show_feedback is not defined %}
    {% set show_feedback = false %}
{% endif %}
{% if is_cumulative is not defined %}
    {% set is_cumulative = false %}
{% endif %}
{% if onclick_function is not defined %}
    {% set onclick_function = 'toggleExtractedData' %}
{% endif %}
{% if id_prefix is not defined %}
    {% set id_prefix = 'data' %}
{% endif %}
{% if editable_mode is not defined %}
    {% set editable_mode = false %}
{% endif %}
{% if lazy_init is not defined %}
    {% set lazy_init = true %}
{% endif %}

{# Loading placeholder styles for lazy-loaded SARF editors #}
<style>
.sarf-editor-lazy[x-ignore] .sarf-loading-placeholder {
    display: flex;
}
.sarf-editor-lazy:not([x-ignore]) .sarf-loading-placeholder {
    display: none;
}
.sarf-editor-lazy[x-ignore] .sarf-editor-content {
    display: none;
}
.sarf-loading-placeholder {
    align-items: center;
    justify-content: center;
    padding: 1rem;
    color: var(--bulma-text-weak);
}
.sarf-loading-placeholder .icon {
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Unified field row layout using CSS Grid for consistent alignment */
.sarf-field-row {
    display: grid;
    grid-template-columns: 80px 1fr auto;
    gap: 35px;
    align-items: center;
    min-height: 24px;
    font-size: 0.75rem;
    padding: 2px 0;
}
.sarf-field-row .sarf-label {
    color: var(--color-fg-muted, #666);
    white-space: nowrap;
}
.sarf-field-row .sarf-value {
    min-width: 0;
}
.sarf-field-row .sarf-actions {
    justify-self: end;
}
.sarf-divider {
    border-top: 1px solid var(--color-border, #3c3c3cff);
    margin: 6px 15px;
}
</style>

{# Pre-compute Alpine component parameters for lazy initialization #}
{% set alpine_params = {
    'data': data,
    'cumulative_pdp': cumulative_pdp if cumulative_pdp else none,
    'thumbs_down': (feedback_data and feedback_data.thumbs_down)|default(false),
    'submitted': false,
    'component_id': component_id,
    'editable_mode': editable_mode,
    'message_id': message_id if message_id else none,
    'edited_extraction': (feedback_data.edited_extraction if feedback_data and feedback_data.edited_extraction else none),
    'feedback_id': (feedback_data.id if feedback_data and feedback_data.id else none),
    'all_feedback': all_ext_feedback_dict if all_ext_feedback_dict else [],
    'approved': approved if approved else false,
    'approved_by': approved_by if approved_by else none,
    'approved_at': approved_at if approved_at else none,
    'admin_feedback_id': (admin_ext_feedback.id if admin_ext_feedback and admin_ext_feedback.id else none)
} %}

<div class="extracted-data-component" id="extracted-data-{{ component_id }}">
    {% if data or editable_mode %}
    <!-- Collapsed Data View -->
    <div class="collapsed-data-section is-clickable" id="{{ id_prefix }}-collapsed-{{ component_id }}" onclick="{{ onclick_function }}('{{ component_id }}')" style="display: {% if collapsed %}block{% else %}none{% endif %}">
        {% if show_feedback and feedback_data %}
        <div class="data-header">
            <span class="tag is-success is-light is-small">âœ“ Reviewed</span>
        </div>
        {% endif %}
        
        <div class="data-summary">
            {% if editable_mode and not data %}
            <small class="has-text-grey">Click to start coding</small>
            {% else %}
            <div class="tags are-small mt-1">
                {% if data and data.people %}
                <span class="tag {{ 'is-warning' if is_cumulative else 'is-success' }} is-light">
                    {{ data.people|length }} People
                </span>
                {% endif %}
                {% if data and data.events %}
                <span class="tag {{ 'is-link' if is_cumulative else 'is-info' }} is-light">
                    {{ data.events|length }} Events
                </span>
                {% endif %}
            </div>
            {% endif %}
            
            {% if is_cumulative %}
            <div class="has-text-centered mt-2">
                <small class="has-text-grey is-size-7">Click to view cumulative notes</small>
            </div>
            {% endif %}
            
            <!-- Quick Variable Summary -->
            {% if not is_cumulative and data and data.events %}
            {% for event in data.events[:2] %}
            <div class="variable-summary is-size-7 mt-1">
                <div class="event-header mb-1">
                    <strong>Event #{{ event.id }}</strong>
                    {% if event.confidence %}
                    <span class="has-text-grey ml-1">({{ (event.confidence * 100)|round }}%)</span>
                    {% endif %}
                </div>
                <div class="variable-indicators">
                    {% if event.symptom %}<span class="shift-indicator shift-{{ event.symptom }}">S:{{ event.symptom }}</span>{% endif %}
                    {% if event.anxiety %}<span class="shift-indicator shift-{{ event.anxiety }} ml-1">A:{{ event.anxiety }}</span>{% endif %}
                    {% if event.functioning %}<span class="shift-indicator shift-{{ event.functioning }} ml-1">F:{{ event.functioning }}</span>{% endif %}
                    {% if event.relationship %}<span class="shift-indicator shift-relationship ml-1">R:{{ event.relationship }}</span>{% endif %}
                </div>
            </div>
            {% endfor %}
            {% endif %}
        </div>
        
    </div>

    <!-- Expanded Data Interface (with tabs for admins, simple view for regular auditors) -->
    {% if editable_mode and not is_cumulative %}
    <div class="admin-tabbed-data{% if lazy_init %} sarf-editor-lazy{% endif %}" id="{{ id_prefix }}-expanded-{{ component_id }}" style="display: {% if collapsed %}none{% else %}block{% endif %}"{% if lazy_init %} x-ignore data-alpine-params='{{ alpine_params|tojson }}'{% else %} x-data='componentExtractedDataWithReview({{ data|tojson }}, {{ cumulative_pdp|tojson if cumulative_pdp else "null" }}, {{ "true" if feedback_data and feedback_data.thumbs_down else "false" }}, false, "{{ component_id }}", {{ "true" if editable_mode else "false" }}, {{ message_id|tojson if message_id else "null" }}, {{ feedback_data.edited_extraction|tojson if feedback_data and feedback_data.edited_extraction else "null" }}, {{ feedback_data.id|tojson if feedback_data and feedback_data.id else "null" }}, {{ all_ext_feedback_dict|tojson if all_ext_feedback_dict else "[]" }}, {{ approved|tojson if approved else "false" }}, {{ approved_by|tojson if approved_by else "null" }}, {{ approved_at|tojson if approved_at else "null" }}, {{ admin_ext_feedback.id|tojson if admin_ext_feedback and admin_ext_feedback.id else "null" }})'{% endif %}>
        {% if lazy_init %}
        <div class="sarf-loading-placeholder">
            <span class="icon"><i class="fas fa-spinner"></i></span>
            <span class="ml-2">Loading...</span>
        </div>
        {% endif %}
        <div class="sarf-editor-content">
        <!-- Navigation Tabs (admin only, hidden when single auditor selected) -->
        {% if current_user and current_user.has_role(btcopilot.ROLE_ADMIN) and all_ext_feedback_dict|length > 1 %}
        <div class="tabs is-small is-boxed mb-0">
            <ul>
                <li :class="{ 'is-active': selectedIndex === -1 }">
                    <a @click.stop="selectFeedback(-1, null)">
                        <span class="icon is-small">
                            <i class="fas fa-robot"></i>
                        </span>
                        <span>AI</span>
                    </a>
                </li>
                {% for feedback in all_ext_feedback_dict %}
                <li :class="{ 'is-active': selectedIndex === {{ loop.index0 }} }">
                    <a @click.stop="selectFeedback({{ loop.index0 }}, allFeedback[{{ loop.index0 }}])">
                        <span class="icon is-small">
                            <i class="fas fa-user"></i>
                        </span>
                        <span>{{ auditor_user_map.get(feedback.auditor_id, feedback.auditor_id) }}{% if feedback.approved %} âœ“{% endif %}</span>
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Tab Content Area -->
        <div class="tab-content-area">
            <!-- Feedback Comments (shown when correction is selected) -->
            <div x-show="selectedIndex >= 0 && selectedFeedback && selectedFeedback.comment" class="p-3" @click.stop>
                <p class="is-size-7 has-text-weight-semibold">Comment:</p>
                <p class="is-size-7" x-text="selectedFeedback ? selectedFeedback.comment : ''"></p>
            </div>

            <!-- Data Content -->
            <div class="expanded-data-section">
                <div class="data-content" style="position: relative;" @click.stop>
                        {% if editable_mode %}
                        {% endif %}

                <!-- Data Display -->
                <div class="data-details">
                    <!-- People Section -->
                    <template x-if="extractedData && ((extractedData.people && extractedData.people.length > 0) || {{ 'true' if editable_mode else 'false' }} || {{ 'true' if is_cumulative else 'false' }})">
                        <div class="people-section mb-2">
                            <div class="section-header is-size-7 has-text-weight-bold {{ 'has-text-warning' if is_cumulative else '' }}" style="position: relative;">
                                {% if not is_cumulative %}<span class="icon is-small"><i class="fas fa-users"></i></span>{% endif %}
                                People
                                {% if editable_mode %}
                                <span x-show="canEdit" style="display: inline-flex; gap: 4px; position: relative;">
                                    <span class="add-element" style="opacity: 1;" @click.stop="createPerson()" title="Create New Person">
                                        <i class="fas fa-plus-circle"></i>
                                    </span>
                                    <span class="add-element edit-person-button" style="opacity: 1;" @click.stop="editPerson($event)" title="Edit Existing Person">
                                        <i class="fas fa-edit"></i>
                                    </span>
                                </span>
                                {% endif %}

                                <!-- Meta Controls (positioned absolutely in header) -->
                                <div class="meta-controls" style="position: absolute; right: 0; top: -2px; display: flex; align-items: center; gap: 4px;">
                                    <!-- Approval Controls (Admin only) -->
                                    {% if current_user and current_user.has_role(btcopilot.ROLE_ADMIN) and message_id and not is_cumulative %}
                                    
                                                                        <!-- Copy Debug Context Button -->
                                    <button class="button is-link is-small"
                                            style="padding: 2px 6px; height: 20px; margin-right: 4px;"
                                            @click.stop="copyDebugContext({{ message_id }})"
                                            title="Copy debug context for Claude Code">
                                        <i class="fas fa-copy" style="font-size: 10px;"></i>
                                    </button>

                                    <!-- Re-extract Button -->
                                    <button class="button is-warning is-small"
                                            style="padding: 2px 6px; height: 20px; margin-right: 4px;"
                                            @click.stop="reextractStatement({{ message_id }}, '{{ component_id }}')"
                                            title="Re-extract with current prompts">
                                        <i class="fas fa-sync" style="font-size: 10px;"></i>
                                    </button>

<!-- Test Prompts Button -->
                                    <button class="button is-info is-small" 
                                            style="padding: 2px 6px; height: 20px; margin-right: 4px;" 
                                            @click.stop="window.open('/training/prompts/?statement_id={{ message_id }}', '_blank')" 
                                            title="Test prompts with this extraction">
                                        <i class="fas fa-flask" style="font-size: 10px;"></i>
                                    </button>
                                    
                                    {# AI Original Approval - HIDDEN: No current use case for approving AI extractions directly.
                                       May be re-enabled in future if we want to approve AI output without human edits. #}
                                    {#
                                    <template x-if="selectedIndex === -1 || typeof selectedIndex === 'undefined'">
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            <template x-if="approved">
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <span class="is-size-7 has-text-success" style="font-weight: 500;">Approved</span>
                                                    <button class="tag is-success is-small approval-button"
                                                            style="padding: 2px 6px; height: 20px; border: none; cursor: pointer; transition: background-color 0.2s;"
                                                            @click.stop="unapproveStatement({{ message_id }})"
                                                            @mouseenter="$el.style.backgroundColor = '#f14668'; $el.style.color = '#fff'; $el.querySelector('i').className = 'fas fa-times'"
                                                            @mouseleave="$el.style.backgroundColor = '#48c78e'; $el.style.color = '#fff'; $el.querySelector('i').className = 'fas fa-check'"
                                                            title="Click to unapprove AI extraction">
                                                        <i class="fas fa-check" style="font-size: 10px;"></i>
                                                    </button>
                                                </div>
                                            </template>
                                            <template x-if="!approved">
                                                <button class="button is-success is-small" style="padding: 2px 6px; height: 20px;" @click.stop="approveStatement({{ message_id }})" title="Approve extraction">
                                                    <i class="fas fa-check" style="font-size: 10px;"></i>
                                                </button>
                                            </template>
                                        </div>
                                    </template>
                                    #}

                                    <!-- Approval status (read-only). Use "Approve All" button to manage approvals. -->
                                    <template x-if="selectedIndex >= 0 && selectedFeedback && selectedFeedback.approved">
                                        <span class="is-size-7 has-text-success" style="font-weight: 500;">Approved</span>
                                    </template>
                                    {% endif %}
                                    
                                    <!-- Delete button (Editable mode only, for non-AI auditor codes) -->
                                    {% if editable_mode and current_auditor %}
                                    <template x-if="editedExtraction && (editedExtraction.people?.length > 0 || editedExtraction.events?.length > 0) && !submitted && (typeof selectedIndex === 'undefined' || selectedIndex === -1 || (selectedFeedback && selectedFeedback.auditor_id === '{{ current_auditor }}'))">
                                        <button class="button is-danger is-small" style="padding: 2px 6px; height: 20px;" @click.stop="clearCorrections()" title="Delete my codes for this statement">
                                            <i class="fas fa-times" style="font-size: 10px;"></i>
                                        </button>
                                    </template>
                                    {% endif %}
                                </div>
                                
                            </div>
                            {% if editable_mode %}
                            <!-- <template x-if="!extractedData.people || extractedData.people.length === 0">
                                <div class="has-text-centered has-text-grey-light py-3">
                                    <p class="is-size-7">No people yet.</p>
                                </div>
                            </template> -->
                            {% endif %}
                            <template x-if="extractedData.people && extractedData.people.length > 0">
                                <template x-for="(person, index) in extractedData.people" :key="index">
                                <div class="person-item mb-1 p-2"
                                     :class="{
                                         'has-background-warning-light': {{ 'true' if is_cumulative else 'false' }},
                                         'has-background-light': {{ 'true' if not is_cumulative else 'false' }}
                                     }"
                                     style="position: relative;">
                                    <!-- Person ID for debugging - floating in lower-right -->
                                    <span class="person-id-debug" x-show="person.id" x-text="person.id"></span>

                                    <!-- System Person Badge -->
                                    <template x-if="person.id === 2">
                                        <span class="system-person-badge is-success">ðŸ¤– Assistant</span>
                                    </template>

                                    <!-- Person Name Row -->
                                    <div class="is-flex is-align-items-center mb-2">
                                        {% if editable_mode %}
                                        <!-- User name is editable, Assistant is read-only -->
                                        <template x-if="person.id === 1">
                                            <strong class="is-size-7 editable-field person-name"
                                                    @mouseenter="hoveredField = 'person-' + index + '-name'"
                                                    @mouseleave="hoveredField = null"
                                                    @click.stop="startEdit('person-' + index + '-name', person.name || 'User')">
                                                <span x-show="!isEditing('person-' + index + '-name')" x-text="person.name || 'User'"></span>
                                                <input x-show="isEditing('person-' + index + '-name')" 
                                                       :value="editingValue"
                                                       @input="editingValue = $event.target.value"
                                                       @blur="savePersonName(index, $event.target.value)"
                                                       @keydown.enter="savePersonName(index, $event.target.value); $event.target.blur()"
                                                       @keydown.escape="cancelEdit(); $event.target.blur()"
                                                       class="inline-edit-input"
                                                       type="text">
                                            </strong>
                                        </template>
                                        <template x-if="person.id === 2">
                                            <strong class="is-size-7 has-text-grey-dark" title="Assistant name cannot be changed" x-text="person.name || 'Assistant'"></strong>
                                        </template>
                                        <!-- Regular person (not system) -->
                                        <template x-if="![1, 2].includes(person.id)">
                                            <strong class="is-size-7 editable-field person-name"
                                                    @mouseenter="hoveredField = 'person-' + index + '-name'"
                                                    @mouseleave="hoveredField = null"
                                                    @click.stop="startEdit('person-' + index + '-name', person.name || 'Unnamed')">
                                                <span x-show="!isEditing('person-' + index + '-name')" x-text="person.name || 'Unnamed'"></span>
                                                <input x-show="isEditing('person-' + index + '-name')" 
                                                       :value="editingValue"
                                                       @input="editingValue = $event.target.value"
                                                       @blur="savePersonName(index, $event.target.value)"
                                                       @keydown.enter="savePersonName(index, $event.target.value); $event.target.blur()"
                                                       @keydown.escape="cancelEdit(); $event.target.blur()"
                                                       class="inline-edit-input"
                                                       type="text">
                                            </strong>
                                        </template>
                                        {% else %}
                                        <strong class="is-size-7" x-text="person.name || 'Unnamed'"></strong>
                                        {% endif %}
                                        {% if editable_mode %}
                                        <span x-show="canEdit" class="delete-variable ml-auto" @click.stop="removePerson(index)" title="Remove delta">
                                            <i class="fas fa-times"></i>
                                        </span>
                                        {% endif %}
                                    </div>

                                    <!-- Person Kind -->
                                    <div class="sarf-field-row">
                                        <span class="sarf-label">Kind:</span>
                                        <span class="sarf-value">
                                            {% if editable_mode %}
                                            <select x-show="canEdit"
                                                    :value="person.gender || ''"
                                                    @change="savePersonGender(index, $event.target.value)"
                                                    class="inline-select-visible">
                                                <option value="">-</option>
                                                <option value="male">male</option>
                                                <option value="female">female</option>
                                                <option value="abortion">abortion</option>
                                                <option value="miscarriage">miscarriage</option>
                                                <option value="unknown">unknown</option>
                                            </select>
                                            <span x-show="!canEdit" class="event-kind-indicator" x-text="person.gender || '-'"></span>
                                            {% else %}
                                            <span class="event-kind-indicator" x-text="person.gender || '-'"></span>
                                            {% endif %}
                                        </span>
                                    </div>

                                    <!-- Confidence Row -->
                                    <div class="sarf-field-row" x-show="person.confidence && person.confidence < 0.999">
                                        <span class="sarf-label">Confidence:</span>
                                        <span class="sarf-value" x-text="(person.confidence * 100).toFixed(0) + '%'"></span>
                                    </div>

                                    <!-- Person Parents -->
                                    <template x-if="person.parents || {{ 'true' if editable_mode else 'false' }}">
                                        <div class="sarf-field-row">
                                            <span class="sarf-label">Parents:</span>
                                            <span class="sarf-value">
                                                <template x-if="person.parents">
                                                    <span class="person-tag"
                                                          :style="{ cursor: canEdit ? 'pointer' : 'default' }"
                                                          :class="{'editable': {{ 'true' if editable_mode else 'false' }} && canEdit}"
                                                          @click="{{ 'canEdit && editPairBond(index)' if editable_mode else '' }}">
                                                        <span x-text="getPairBondName(person.parents, personDataVersion)"></span>
                                                        {% if editable_mode %}
                                                        <span x-show="canEdit" style="margin-left: 4px; color: #ff4444; cursor: pointer; font-weight: bold;"
                                                              @click.stop="removePairBond(index)">Ã—</span>
                                                        {% endif %}
                                                    </span>
                                                </template>
                                                <template x-if="!person.parents && {{ 'true' if editable_mode else 'false' }} && canEdit">
                                                    <span class="add-element"
                                                          @click.stop="selectPairBond(index)"
                                                          title="Add parents">
                                                        <i class="fas fa-plus-circle"></i>
                                                    </span>
                                                </template>
                                                <template x-if="!person.parents && !canEdit">
                                                    <span>-</span>
                                                </template>
                                            </span>
                                        </div>
                                    </template>
                                </div>
                                </template>
                            </template>
                        </div>
                    </template>
                    
                    <!-- Events Section -->
                    <template x-if="extractedData && ((extractedData.events && extractedData.events.length > 0) || {{ 'true' if editable_mode else 'false' }} || {{ 'true' if is_cumulative else 'false' }})">
                        <div class="events-section mb-2">
                            <div class="section-header is-size-7 has-text-weight-bold {{ 'has-text-link' if is_cumulative else '' }}">
                                {% if not is_cumulative %}<span class="icon is-small"><i class="fas fa-calendar-alt"></i></span>{% endif %}
                                Events
                                {% if editable_mode %}
                                <span x-show="canEdit" style="display: inline-flex; gap: 4px; position: relative;">
                                    <span class="add-element create-event-button" style="opacity: 1;" @click.stop="showCreateEventMenu($event)" title="Create New Event">
                                        <i class="fas fa-plus-circle"></i>
                                    </span>
                                    <span class="add-element edit-event-button" style="opacity: 1;" @click.stop="editEvent($event)" title="Edit Existing Event">
                                        <i class="fas fa-edit"></i>
                                    </span>
                                </span>
                                {% endif %}
                            </div>
                            {% if editable_mode %}
                            <!-- <template x-if="!extractedData.events || extractedData.events.length === 0">
                                <div class="has-text-centered has-text-grey-light py-3">
                                    <p class="is-size-7">No events yet. Click <i class="fas fa-plus-circle"></i> above to add.</p>
                                </div>
                            </template> -->
                            {% endif %}
                                <template x-for="(event, index) in (extractedData.events || [])" :key="index">
                                <div class="event-item mb-2 p-2 {{ 'has-background-link-light' if is_cumulative else 'has-background-light' }}" style="position: relative;">
                                    {% if editable_mode %}
                                    <span x-show="canEdit" class="delete-event" @click.stop="removeEvent(index)" title="Remove event">
                                        <i class="fas fa-times"></i>
                                    </span>
                                    {% endif %}
                                    <!-- Event ID for debugging - floating in lower-right -->
                                    <span class="event-id-debug" x-show="event.id" x-text="event.id"></span>
                                    <div class="event-header">
                                        <div class="event-metadata is-size-7 has-text-grey mt-1 mb-1">
                                            <span x-show="event.confidence && event.confidence < 0.999">
                                                Confidence: <span x-text="(event.confidence * 100).toFixed(0) + '%'"></span>
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Event Kind -->
                                    <div class="sarf-field-row">
                                        <span class="sarf-label">Event Kind:</span>
                                        <span class="sarf-value">
                                            {% if editable_mode %}
                                            <select x-show="canEdit"
                                                    :value="event.kind || 'shift'"
                                                    @change="saveEventKind(index, $event.target.value)"
                                                    class="inline-select-visible">
                                                <option value="shift">shift</option>
                                                <option value="birth">birth</option>
                                                <option value="adopted">adopted</option>
                                                <option value="bonded">bonded</option>
                                                <option value="married">married</option>
                                                <option value="separated">separated</option>
                                                <option value="divorced">divorced</option>
                                                <option value="moved">moved</option>
                                                <option value="death">death</option>
                                            </select>
                                            <span x-show="!canEdit" class="event-kind-indicator" x-text="event.kind || 'shift'"></span>
                                            {% else %}
                                            <span class="event-kind-indicator" x-text="event.kind || 'shift'"></span>
                                            {% endif %}
                                        </span>
                                    </div>

                                    <div class="sarf-divider"></div>

                                    <!-- Event Person -->
                                    <template x-if="event.person || {{ 'true' if editable_mode else 'false' }}">
                                        <div class="sarf-field-row">
                                            <span class="sarf-label" x-text="getPersonLabel(event.kind, event.relationship)"></span>
                                            <span class="sarf-value">
                                                <template x-if="event.person">
                                                    <span class="person-tag"
                                                          :style="{ cursor: canEdit ? 'pointer' : 'default' }"
                                                          :class="{'editable': {{ 'true' if editable_mode else 'false' }} && canEdit}"
                                                          @click="{{ 'canEdit && editEventPerson(index, event.person)' if editable_mode else '' }}">
                                                        <span x-text="getPersonName(event.person, personDataVersion)"></span>
                                                        {% if editable_mode %}
                                                        <span x-show="canEdit" style="margin-left: 4px; color: #ff4444; cursor: pointer; font-weight: bold;"
                                                              @click.stop="clearEventPerson(index)">Ã—</span>
                                                        {% endif %}
                                                    </span>
                                                </template>
                                                <template x-if="!event.person && {{ 'true' if editable_mode else 'false' }} && canEdit">
                                                    <span class="add-element edit-event-person-button" style="opacity: 1;" @click.stop="editEventPerson($event, index)" title="Select Existing Person for Event">
                                                        <i class="fas fa-edit"></i>
                                                    </span>
                                                </template>
                                            </span>
                                        </div>
                                    </template>

                                    <!-- Event Spouse -->
                                    <template x-if="(['bonded', 'married', 'separated', 'divorced', 'moved', 'birth', 'adopted'].includes(event.kind) && (event.spouse || {{ 'true' if editable_mode else 'false' }})) || (event.spouse && {{ 'true' if editable_mode else 'false' }})">
                                        <div class="sarf-field-row">
                                            <span class="sarf-label" x-text="(event.kind === 'birth' || event.kind === 'adopted') ? 'Parent 2:' : (event.kind === 'moved') ? 'Partner:' : 'Partner 2:'"></span>
                                            <span class="sarf-value">
                                                <template x-if="event.spouse">
                                                    <span class="person-tag"
                                                          :style="{ cursor: canEdit ? 'pointer' : 'default' }"
                                                          :class="{'editable': {{ 'true' if editable_mode else 'false' }} && canEdit}"
                                                          @click="{{ 'canEdit && editEventSpouse(index, event.spouse)' if editable_mode else '' }}">
                                                        <span x-text="getPersonName(event.spouse, personDataVersion)"></span>
                                                        {% if editable_mode %}
                                                        <span x-show="canEdit" style="margin-left: 4px; color: #ff4444; cursor: pointer; font-weight: bold;"
                                                              @click.stop="clearEventSpouse(index)">Ã—</span>
                                                        {% endif %}
                                                    </span>
                                                </template>
                                                <template x-if="!event.spouse && {{ 'true' if editable_mode else 'false' }} && canEdit">
                                                    <span class="add-element edit-event-spouse-button" style="opacity: 1;" @click.stop="editEventSpouse($event, index)" title="Select Existing Spouse for Event">
                                                        <i class="fas fa-edit"></i>
                                                    </span>
                                                </template>
                                            </span>
                                        </div>
                                    </template>

                                    <!-- Event Child -->
                                    <template x-if="(['birth', 'adopted'].includes(event.kind) && (event.child || {{ 'true' if editable_mode else 'false' }})) || (event.child && {{ 'true' if editable_mode else 'false' }})">
                                        <div class="sarf-field-row">
                                            <span class="sarf-label">Child:</span>
                                            <span class="sarf-value">
                                                <template x-if="event.child">
                                                    <span class="person-tag"
                                                          :style="{ cursor: canEdit ? 'pointer' : 'default' }"
                                                          :class="{'editable': {{ 'true' if editable_mode else 'false' }} && canEdit}"
                                                          @click="{{ 'canEdit && editEventChild(index, event.child)' if editable_mode else '' }}">
                                                        <span x-text="getPersonName(event.child, personDataVersion)"></span>
                                                        {% if editable_mode %}
                                                        <span x-show="canEdit" style="margin-left: 4px; color: #ff4444; cursor: pointer; font-weight: bold;"
                                                              @click.stop="clearEventChild(index)">Ã—</span>
                                                        {% endif %}
                                                    </span>
                                                </template>
                                                <template x-if="!event.child && {{ 'true' if editable_mode else 'false' }} && canEdit">
                                                    <span class="add-element edit-event-child-button" style="opacity: 1;" @click.stop="editEventChild($event, index)" title="Select Existing Child for Event">
                                                        <i class="fas fa-edit"></i>
                                                    </span>
                                                </template>
                                            </span>
                                        </div>
                                    </template>

                                    <!-- Event Description (for shift and death events) -->
                                    <template x-if="!event.kind || event.kind === 'shift' || event.kind === 'death'">
                                        <div class="sarf-field-row">
                                            <span class="sarf-label" x-text="event.kind === 'death' ? 'Cause:' : 'Description:'"></span>
                                            <span class="sarf-value">
                                                {% if editable_mode %}
                                                <span class="event-description"
                                                      :class="{'editable-field': canEdit}"
                                                      @mouseenter="canEdit && (hoveredField = 'event-' + index + '-description')"
                                                      @mouseleave="hoveredField = null"
                                                      @click.stop="canEdit && startEdit('event-' + index + '-description', event.description || '')">
                                                    <span x-show="!isEditing('event-' + index + '-description')" x-text="event.description || 'Not set'"></span>
                                                    <input x-show="isEditing('event-' + index + '-description')"
                                                           :value="editingValue"
                                                           @input="editingValue = $event.target.value"
                                                           @blur="saveEventDescription(index, $event.target.value)"
                                                           @keydown.enter="saveEventDescription(index, $event.target.value); $event.target.blur()"
                                                           @keydown.escape="cancelEdit(); $event.target.blur()"
                                                           class="inline-edit-input"
                                                           type="text">
                                                </span>
                                                {% else %}
                                                <span x-text="event.description || 'Not specified'"></span>
                                                {% endif %}
                                            </span>
                                        </div>
                                    </template>

                                    <div class="sarf-divider"></div>

                                    <!-- Event DateTime -->
                                    <template x-if="(event.dateTime && event.dateTime.trim() !== '') || {{ 'true' if editable_mode else 'false' }}">
                                        <div class="sarf-field-row">
                                            <span class="sarf-label">Date/Time:</span>
                                            <span class="sarf-value">
                                                {% if editable_mode %}
                                                <span class="event-datetime"
                                                      :class="{'editable-field': canEdit}"
                                                      @mouseenter="canEdit && (hoveredField = 'event-' + index + '-dateTime')"
                                                      @mouseleave="hoveredField = null"
                                                      @click.stop="canEdit && startEdit('event-' + index + '-dateTime', event.dateTime || '')">
                                                    <span x-show="!isEditing('event-' + index + '-dateTime')" x-text="formatDate(event.dateTime) || 'Not set'"></span>
                                                    <input x-show="isEditing('event-' + index + '-dateTime')"
                                                           :value="editingValue"
                                                           @input="editingValue = $event.target.value"
                                                           @blur="saveEventDateTime(index, $event.target.value)"
                                                           @keydown.enter="saveEventDateTime(index, $event.target.value); $event.target.blur()"
                                                           @keydown.escape="cancelEdit(); $event.target.blur()"
                                                           class="inline-edit-input"
                                                           type="date"
                                                           style="width: 150px;">
                                                </span>
                                                {% else %}
                                                <span x-text="formatDate(event.dateTime) || 'Not specified'"></span>
                                                {% endif %}
                                            </span>
                                            <span class="sarf-actions">
                                                {% if editable_mode %}
                                                <select x-show="canEdit"
                                                        :value="event.dateCertainty || 'approximate'"
                                                        @change="saveDateCertainty(index, $event.target.value)"
                                                        class="inline-select-visible">
                                                    <option value="approximate">approximate</option>
                                                    <option value="certain">certain</option>
                                                    <option value="unknown">unknown</option>
                                                </select>
                                                <span x-show="!canEdit" class="date-certainty-indicator" x-text="event.dateCertainty || 'approximate'"></span>
                                                {% else %}
                                                <span class="date-certainty-indicator" x-text="event.dateCertainty || 'approximate'"></span>
                                                {% endif %}
                                            </span>
                                        </div>
                                    </template>

                                    <div class="sarf-divider" x-show="!event.kind || event.kind === 'shift'"></div>

                                    <!-- SARF Variables (only shown for 'shift' events) -->
                                    <div class="sarf-variables-section"
                                         x-show="!event.kind || event.kind === 'shift'"
                                         {% if editable_mode %}@click.stop{% endif %}>
                                        <!-- Symptom Variable -->
                                        <div class="sarf-field-row" :class="{ 'has-text-grey-light': !event.symptom }">
                                            <span class="sarf-label">Symptom:</span>
                                            <span class="sarf-value">
                                                <template x-if="event.symptom">
                                                    {% if editable_mode %}
                                                    <span class="shift-indicator is-small" :class="'shift-' + event.symptom">
                                                        <select x-show="canEdit"
                                                                :value="event.symptom"
                                                                @change="saveShift(index, 'symptom', $event.target.value)"
                                                                class="inline-select-visible">
                                                            <option value="up">up</option>
                                                            <option value="down">down</option>
                                                            <option value="same">same</option>
                                                        </select>
                                                        <span x-show="!canEdit" x-text="event.symptom"></span>
                                                    </span>
                                                    {% else %}
                                                    <span class="shift-indicator is-small" :class="'shift-' + event.symptom" x-text="event.symptom"></span>
                                                    {% endif %}
                                                </template>
                                                <template x-if="!event.symptom && {{ 'true' if editable_mode else 'false' }} && canEdit">
                                                    <span class="add-element" @click.stop="addVariable(index, 'symptom')" title="Add symptom variable">
                                                        <i class="fas fa-plus-circle"></i>
                                                    </span>
                                                </template>
                                                <template x-if="!event.symptom && !canEdit">
                                                    <span>-</span>
                                                </template>
                                            </span>
                                            <span class="sarf-actions">
                                                {% if editable_mode %}
                                                <span class="delete-variable"
                                                      x-show="canEdit && event.symptom"
                                                      @click.stop="removeVariable(index, 'symptom')"
                                                      title="Remove symptom">
                                                    <i class="fas fa-times"></i>
                                                </span>
                                                {% endif %}
                                            </span>
                                        </div>
                                        <!-- Anxiety Variable -->
                                        <div class="sarf-field-row" :class="{ 'has-text-grey-light': !event.anxiety }">
                                            <span class="sarf-label">Anxiety:</span>
                                            <span class="sarf-value">
                                                <template x-if="event.anxiety">
                                                    {% if editable_mode %}
                                                    <span class="shift-indicator is-small" :class="'shift-' + event.anxiety">
                                                        <select x-show="canEdit"
                                                                :value="event.anxiety"
                                                                @change="saveShift(index, 'anxiety', $event.target.value)"
                                                                class="inline-select-visible">
                                                            <option value="up">up</option>
                                                            <option value="down">down</option>
                                                            <option value="same">same</option>
                                                        </select>
                                                        <span x-show="!canEdit" x-text="event.anxiety"></span>
                                                    </span>
                                                    {% else %}
                                                    <span class="shift-indicator is-small" :class="'shift-' + event.anxiety" x-text="event.anxiety"></span>
                                                    {% endif %}
                                                </template>
                                                <template x-if="!event.anxiety && {{ 'true' if editable_mode else 'false' }} && canEdit">
                                                    <span class="add-element" @click.stop="addVariable(index, 'anxiety')" title="Add anxiety variable">
                                                        <i class="fas fa-plus-circle"></i>
                                                    </span>
                                                </template>
                                                <template x-if="!event.anxiety && !canEdit">
                                                    <span>-</span>
                                                </template>
                                            </span>
                                            <span class="sarf-actions">
                                                {% if editable_mode %}
                                                <span class="delete-variable"
                                                      x-show="canEdit && event.anxiety"
                                                      @click.stop="removeVariable(index, 'anxiety')"
                                                      title="Remove anxiety">
                                                    <i class="fas fa-times"></i>
                                                </span>
                                                {% endif %}
                                            </span>
                                        </div>
                                        <!-- Relationship Variable -->
                                        <div class="sarf-field-row" :class="{ 'has-text-grey-light': !event.relationship }">
                                            <span class="sarf-label">Relationship:</span>
                                            <span class="sarf-value">
                                                <template x-if="event.relationship">
                                                    {% if editable_mode %}
                                                    <span class="shift-indicator shift-relationship is-small">
                                                        <select x-show="canEdit"
                                                                :value="event.relationship"
                                                                @change="saveRelationshipKind(index, $event.target.value)"
                                                                class="inline-select-visible">
                                                            <option value="conflict">conflict</option>
                                                            <option value="distance">distance</option>
                                                            <option value="overfunctioning">overfunctioning</option>
                                                            <option value="underfunctioning">underfunctioning</option>
                                                            <option value="projection">projection</option>
                                                            <option value="defined-self">defined-self</option>
                                                            <option value="toward">toward</option>
                                                            <option value="away">away</option>
                                                            <option value="inside">inside</option>
                                                            <option value="outside">outside</option>
                                                            <option value="cutoff">cutoff</option>
                                                        </select>
                                                        <span x-show="!canEdit" x-text="event.relationship"></span>
                                                    </span>
                                                    {% else %}
                                                    <span class="shift-indicator shift-relationship is-small" x-text="event.relationship"></span>
                                                    {% endif %}
                                                </template>
                                                <template x-if="!event.relationship && {{ 'true' if editable_mode else 'false' }} && canEdit">
                                                    <span class="add-element" @click.stop="addVariable(index, 'relationship')" title="Add relationship variable">
                                                        <i class="fas fa-plus-circle"></i>
                                                    </span>
                                                </template>
                                                <template x-if="!event.relationship && !canEdit">
                                                    <span>-</span>
                                                </template>
                                            </span>
                                            <span class="sarf-actions">
                                                {% if editable_mode %}
                                                <span class="delete-variable"
                                                      x-show="canEdit && event.relationship"
                                                      @click.stop="removeVariable(index, 'relationship')"
                                                      title="Remove relationship">
                                                    <i class="fas fa-times"></i>
                                                </span>
                                                {% endif %}
                                            </span>
                                        </div>
                                        <!-- Relationship Details - Shown below the main variable row -->
                                        <template x-if="event.relationship">
                                            <div class="relationship-details-content" style="margin-left: 1em;">
                                                <!-- Relationship Targets - shown for all relationship types -->
                                                <template x-if="(event.relationshipTargets && event.relationshipTargets.length > 0) || {{ 'true' if editable_mode else 'false' }}">
                                                    <div class="sarf-field-row">
                                                        <span class="sarf-label" x-text="getTargetsLabel(event.relationship)"></span>
                                                        <span class="sarf-value">
                                                            <span style="display: inline-flex; flex-wrap: wrap; align-items: center; gap: 2px;">
                                                                <template x-for="(personId, idx) in (event.relationshipTargets || [])" :key="personId + '-' + idx">
                                                                    <span class="person-tag"
                                                                          :style="{ cursor: canEdit ? 'pointer' : 'default' }"
                                                                          :class="{'editable': {{ 'true' if editable_mode else 'false' }} && canEdit}"
                                                                          @click="{{ 'canEdit && editRelationshipPerson($event, index, \'targets\', idx)' if editable_mode else '' }}">
                                                                        <span x-text="getPersonName(personId, personDataVersion)"></span>
                                                                        {% if editable_mode %}
                                                                        <span x-show="canEdit" style="margin-left: 4px; color: #ff4444; cursor: pointer; font-weight: bold;"
                                                                              @click.stop="removeRelationshipPerson(index, 'targets', idx)">Ã—</span>
                                                                        {% endif %}
                                                                    </span>
                                                                </template>
                                                                {% if editable_mode %}
                                                                <span x-show="canEdit" class="add-element add-relationship-person-button"
                                                                      @click.stop="addRelationshipPerson($event, index, 'targets')"
                                                                      title="Select existing person"
                                                                      style="opacity: 1;">
                                                                    <i class="fas fa-edit"></i>
                                                                </span>
                                                                {% endif %}
                                                            </span>
                                                        </span>
                                                    </div>
                                                </template>

                                                <!-- Relationship Triangles - ONLY shown for inside/outside -->
                                                <template x-if="['inside', 'outside'].includes(event.relationship)">
                                                    <template x-if="(event.relationshipTriangles && event.relationshipTriangles.length > 0) || {{ 'true' if editable_mode else 'false' }}">
                                                        <div class="sarf-field-row">
                                                            <span class="sarf-label" x-text="getTrianglesLabel(event.relationship)"></span>
                                                            <span class="sarf-value">
                                                                <span style="display: inline-flex; flex-wrap: wrap; align-items: center; gap: 2px;">
                                                                    <template x-for="(personId, idx) in (event.relationshipTriangles || [])" :key="personId + '-' + idx">
                                                                        <span class="person-tag"
                                                                              style="display: inline-block; padding: 2px 8px; margin: 2px; background: #ffe8e8; border: 1px solid #ffb3b3; border-radius: 4px; font-size: 0.85rem; white-space: nowrap; cursor: pointer;"
                                                                              :class="{'editable': {{ 'true' if editable_mode else 'false' }} && canEdit}"
                                                                              @click="{{ 'canEdit && editRelationshipPerson($event, index, \'triangles\', idx)' if editable_mode else '' }}">
                                                                            <span x-text="getPersonName(personId, personDataVersion)"></span>
                                                                            {% if editable_mode %}
                                                                            <span x-show="canEdit" style="margin-left: 4px; color: #ff4444; cursor: pointer; font-weight: bold;"
                                                                                  @click.stop="removeRelationshipPerson(index, 'triangles', idx)">Ã—</span>
                                                                            {% endif %}
                                                                        </span>
                                                                    </template>
                                                                    {% if editable_mode %}
                                                                    <span x-show="canEdit" class="add-element add-relationship-person-button"
                                                                          @click.stop="addRelationshipPerson($event, index, 'triangles')"
                                                                          title="Select existing person"
                                                                          style="opacity: 1;">
                                                                        <i class="fas fa-edit"></i>
                                                                    </span>
                                                                    {% endif %}
                                                                </span>
                                                            </span>
                                                        </div>
                                                    </template>
                                                </template>
                                            </div>
                                        </template>

                                        <!-- Subtle divider before Functioning -->
                                        <div class="variable-divider"></div>

                                        <!-- Functioning Variable -->
                                        <div class="sarf-field-row" :class="{ 'has-text-grey-light': !event.functioning }">
                                            <span class="sarf-label">Functioning:</span>
                                            <span class="sarf-value">
                                                <template x-if="event.functioning">
                                                    {% if editable_mode %}
                                                    <span class="shift-indicator is-small" :class="'shift-functioning-' + event.functioning">
                                                        <select x-show="canEdit"
                                                                :value="event.functioning"
                                                                @change="saveShift(index, 'functioning', $event.target.value)"
                                                                class="inline-select-visible">
                                                            <option value="up">up</option>
                                                            <option value="down">down</option>
                                                            <option value="same">same</option>
                                                        </select>
                                                        <span x-show="!canEdit" x-text="event.functioning"></span>
                                                    </span>
                                                    {% else %}
                                                    <span class="shift-indicator is-small"
                                                          :class="'shift-functioning-' + event.functioning"
                                                          x-text="event.functioning"></span>
                                                    {% endif %}
                                                </template>
                                                <!-- Rationale display for Functioning -->
                                                <template x-if="event.functioning && event.functioning.rationale">
                                                    <span class="is-size-7 has-text-grey is-italic" x-text="'â†’ ' + event.functioning.rationale"></span>
                                                </template>
                                                <template x-if="!event.functioning && {{ 'true' if editable_mode else 'false' }} && canEdit">
                                                    <span class="add-element" @click.stop="addVariable(index, 'functioning')" title="Add functioning variable">
                                                        <i class="fas fa-plus-circle"></i>
                                                    </span>
                                                </template>
                                                <template x-if="!event.functioning && !canEdit">
                                                    <span>-</span>
                                                </template>
                                            </span>
                                            <span class="sarf-actions">
                                                {% if editable_mode %}
                                                <span class="delete-variable"
                                                      x-show="canEdit && event.functioning"
                                                      @click.stop="removeVariable(index, 'functioning')"
                                                      title="Remove functioning">
                                                    <i class="fas fa-times"></i>
                                                </span>
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                </template>
                        </div>
                    </template>

                    <!-- Deletes Section -->
                    <template x-if="extractedData && ((extractedData.delete && extractedData.delete.length > 0) || {{ 'true' if editable_mode else 'false' }})">
                        <div class="deletes-section mb-2">
                            <div class="section-header is-size-7 has-text-weight-bold has-text-danger">
                                <span class="icon is-small"><i class="fas fa-trash"></i></span>
                                Deletes
                                {% if editable_mode %}
                                <span x-show="canEdit" class="add-element add-delete-button" style="opacity: 1; margin-left: 8px; position: relative;" @click.stop="showDeleteDropdown($event)" title="Add Delete">
                                    <i class="fas fa-edit"></i>
                                </span>
                                {% endif %}
                            </div>
                            <template x-if="extractedData.delete && extractedData.delete.length > 0">
                                <template x-for="(deleteId, index) in extractedData.delete" :key="index">
                                <div class="delete-item mb-1 p-2 has-background-warning-light" style="position: relative;">
                                    <!-- Delete ID Row -->
                                    <div class="is-flex is-align-items-center">
                                        <strong class="is-size-7">ID: </strong>
                                        {% if editable_mode %}
                                        <select x-show="canEdit"
                                                :value="deleteId"
                                                @change="saveDeleteId(index, parseInt($event.target.value))"
                                                class="inline-select-visible ml-1">
                                            <template x-for="availableId in getAllAvailableIds()" :key="availableId.id">
                                                <option :value="availableId.id" x-text="availableId.label"></option>
                                            </template>
                                        </select>
                                        <span x-show="!canEdit" class="is-size-7 ml-1" x-text="deleteId"></span>
                                        <span x-show="canEdit" class="delete-variable ml-auto" @click.stop="removeDelete(index)" title="Remove delete">
                                            <i class="fas fa-times"></i>
                                        </span>
                                        {% else %}
                                        <span class="is-size-7 ml-1" x-text="deleteId"></span>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Show what this ID refers to -->
                                    <div class="is-size-7 has-text-grey mt-1">
                                        <span x-text="getItemDescription(deleteId)"></span>
                                    </div>
                                </div>
                                </template>
                            </template>
                        </div>
                    </template>
                </div>
                
                
                {% if show_feedback and not editable_mode %}
                <!-- Data Feedback Controls -->
                <div class="mt-3 p-3 {% if feedback_data %}feedback-submitted{% endif %}" onclick="event.stopPropagation()">                                    
                    {% if feedback_data %}
                    <div class="notification is-success is-light is-small">
                        <strong>Your feedback:</strong><br>
                        {{ 'ðŸ‘Ž Needs work' if feedback_data.thumbs_down else 'ðŸ‘ Good' }}<br>
                        {% if feedback_data.comment %}
                        <small>{{ feedback_data.comment }}</small>
                        {% endif %}
                        
                        {% if feedback_data.edited_extraction %}
                        <div class="mt-2">
                            <div class="has-text-weight-bold is-size-7 mb-1">Your Expected Extraction:</div>
                            <div class="auditor-corrected-data" x-data='{ correctedData: {{ feedback_data.edited_extraction|tojson }} }'>
                                {% include "components/extracted_data_corrected.html" %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <button class="button is-small is-danger is-outlined mt-2" @click="deleteFeedback(feedbackId)">
                            Delete feedback
                        </button>
                    </div>
                    {% else %}
                    <!-- Feedback Form -->
                    <div class="extraction-feedback" x-show="!submitted">
                        <div class="field">
                            <label class="label is-small">Data Extraction Quality</label>
                            <div class="control">
                                <button class="thumbs-button is-small" 
                                        :class="{ 'is-active': !thumbsDown }"
                                        @click="thumbsDown = false" type="button">
                                    ðŸ‘
                                </button>
                                <button class="thumbs-button is-small" 
                                        :class="{ 'is-active': thumbsDown }"
                                        @click="thumbsDown = true" type="button">
                                    ðŸ‘Ž
                                </button>
                            </div>
                        </div>
                        
                        <div class="field" x-show="thumbsDown">
                            <label class="label is-small">Comments (optional)</label>
                            <div class="control">
                                <textarea class="textarea is-small" 
                                          placeholder="Comments on data extraction..."
                                          rows="2"
                                          id="extraction-comment-{{ message_id }}"></textarea>
                            </div>
                        </div>
                        
                        <div class="field">
                            <button class="button is-primary is-small"
                                    @click="submitExtractionFeedback({{ message_id|tojson if message_id else 'null' }}, thumbsDown, null)">
                                Submit
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        </div>{# close sarf-editor-content #}
    {% else %}
    <!-- Regular Expanded Data View (non-admin or no corrections) -->
    <div class="expanded-data-section" id="{{ id_prefix }}-expanded-{{ component_id }}" style="display: {% if collapsed %}none{% else %}block{% endif %}">
        <div class="data-content" style="position: relative;">
            <div class="{% if lazy_init %}sarf-editor-lazy{% endif %}"{% if lazy_init %} x-ignore data-alpine-params='{{ alpine_params|tojson }}'{% else %} x-data='componentExtractedDataWithReview({{ data|tojson }}, {{ cumulative_pdp|tojson if cumulative_pdp else "null" }}, {{ "true" if feedback_data and feedback_data.thumbs_down else "false" }}, false, "{{ component_id }}", {{ "true" if editable_mode else "false" }}, {{ message_id|tojson if message_id else "null" }}, {{ feedback_data.edited_extraction|tojson if feedback_data and feedback_data.edited_extraction else "null" }}, {{ feedback_data.id|tojson if feedback_data and feedback_data.id else "null" }}, {{ all_ext_feedback_dict|tojson if all_ext_feedback_dict else "[]" }}, {{ approved|tojson if approved else "false" }}, {{ approved_by|tojson if approved_by else "null" }}, {{ approved_at|tojson if approved_at else "null" }}, {{ admin_ext_feedback.id|tojson if admin_ext_feedback and admin_ext_feedback.id else "null" }})'{% endif %} @click.stop>
                {% if lazy_init %}
                <div class="sarf-loading-placeholder">
                    <span class="icon"><i class="fas fa-spinner"></i></span>
                    <span class="ml-2">Loading...</span>
                </div>
                {% endif %}
                <div class="sarf-editor-content">
                <!-- Data Display -->
                <div class="data-details">
                    <!-- People Section -->
                    <template x-if="extractedData && ((extractedData.people && extractedData.people.length > 0) || {{ 'true' if editable_mode else 'false' }} || {{ 'true' if is_cumulative else 'false' }})">
                        <div class="people-section mb-2">
                            <div class="section-header is-size-7 has-text-weight-bold {{ 'has-text-warning' if is_cumulative else '' }}" style="position: relative;">
                                {% if not is_cumulative %}<span class="icon is-small"><i class="fas fa-users"></i></span>{% endif %}
                                People
                                {% if editable_mode %}
                                <span x-show="canEdit" style="display: inline-flex; gap: 4px; position: relative;">
                                    <span class="add-element" style="opacity: 1;" @click.stop="createPerson()" title="Create New Person">
                                        <i class="fas fa-plus-circle"></i>
                                    </span>
                                    <span class="add-element edit-person-button" style="opacity: 1;" @click.stop="editPerson($event)" title="Edit Existing Person">
                                        <i class="fas fa-edit"></i>
                                    </span>
                                </span>
                                {% endif %}

                                <!-- Meta Controls (positioned absolutely in header) -->
                                <div class="meta-controls" style="position: absolute; right: 0; top: -2px; display: flex; align-items: center; gap: 4px;">
                                    <!-- Approval Controls (Admin only) -->
                                    {% if current_user and current_user.has_role(btcopilot.ROLE_ADMIN) and message_id and not is_cumulative %}
                                    
                                                                        <!-- Copy Debug Context Button -->
                                    <button class="button is-link is-small"
                                            style="padding: 2px 6px; height: 20px; margin-right: 4px;"
                                            @click.stop="copyDebugContext({{ message_id }})"
                                            title="Copy debug context for Claude Code">
                                        <i class="fas fa-copy" style="font-size: 10px;"></i>
                                    </button>

                                    <!-- Re-extract Button -->
                                    <button class="button is-warning is-small"
                                            style="padding: 2px 6px; height: 20px; margin-right: 4px;"
                                            @click.stop="reextractStatement({{ message_id }}, '{{ component_id }}')"
                                            title="Re-extract with current prompts">
                                        <i class="fas fa-sync" style="font-size: 10px;"></i>
                                    </button>

<!-- Test Prompts Button -->
                                    <button class="button is-info is-small" 
                                            style="padding: 2px 6px; height: 20px; margin-right: 4px;" 
                                            @click.stop="window.open('/training/prompts/?statement_id={{ message_id }}', '_blank')" 
                                            title="Test prompts with this extraction">
                                        <i class="fas fa-flask" style="font-size: 10px;"></i>
                                    </button>
                                    
                                    {# AI Original Approval - HIDDEN: No current use case for approving AI extractions directly.
                                       May be re-enabled in future if we want to approve AI output without human edits. #}
                                    {#
                                    <template x-if="selectedIndex === -1 || typeof selectedIndex === 'undefined'">
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            <template x-if="approved">
                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                    <span class="is-size-7 has-text-success" style="font-weight: 500;">Approved</span>
                                                    <button class="tag is-success is-small approval-button"
                                                            style="padding: 2px 6px; height: 20px; border: none; cursor: pointer; transition: background-color 0.2s;"
                                                            @click.stop="unapproveStatement({{ message_id }})"
                                                            @mouseenter="$el.style.backgroundColor = '#f14668'; $el.style.color = '#fff'; $el.querySelector('i').className = 'fas fa-times'"
                                                            @mouseleave="$el.style.backgroundColor = '#48c78e'; $el.style.color = '#fff'; $el.querySelector('i').className = 'fas fa-check'"
                                                            title="Click to unapprove AI extraction">
                                                        <i class="fas fa-check" style="font-size: 10px;"></i>
                                                    </button>
                                                </div>
                                            </template>
                                            <template x-if="!approved">
                                                <button class="button is-success is-small" style="padding: 2px 6px; height: 20px;" @click.stop="approveStatement({{ message_id }})" title="Approve extraction">
                                                    <i class="fas fa-check" style="font-size: 10px;"></i>
                                                </button>
                                            </template>
                                        </div>
                                    </template>
                                    #}

                                    <!-- Approval status (read-only). Use "Approve All" button to manage approvals. -->
                                    <template x-if="selectedIndex >= 0 && selectedFeedback && selectedFeedback.approved">
                                        <span class="is-size-7 has-text-success" style="font-weight: 500;">Approved</span>
                                    </template>
                                    {% endif %}
                                    
                                    <!-- Delete button (Editable mode only, for non-AI auditor codes) -->
                                    {% if editable_mode and current_auditor %}
                                    <template x-if="editedExtraction && (editedExtraction.people?.length > 0 || editedExtraction.events?.length > 0) && !submitted && (typeof selectedIndex === 'undefined' || selectedIndex === -1 || (selectedFeedback && selectedFeedback.auditor_id === '{{ current_auditor }}'))">
                                        <button class="button is-danger is-small" style="padding: 2px 6px; height: 20px;" @click.stop="clearCorrections()" title="Delete my codes for this statement">
                                            <i class="fas fa-times" style="font-size: 10px;"></i>
                                        </button>
                                    </template>
                                    {% endif %}
                                </div>
                                
                            </div>
                            {% if editable_mode %}
                            <!-- <template x-if="!extractedData.people || extractedData.people.length === 0">
                                <div class="has-text-centered has-text-grey-light py-3">
                                    <p class="is-size-7">No people yet. </p>
                                </div>
                            </template> -->
                            {% endif %}
                            <template x-if="extractedData.people && extractedData.people.length > 0">
                                <template x-for="(person, index) in extractedData.people" :key="index">
                                <div class="person-item mb-1 p-2"
                                     :class="{
                                         'has-background-warning-light': {{ 'true' if is_cumulative else 'false' }},
                                         'has-background-light': {{ 'true' if not is_cumulative else 'false' }}
                                     }"
                                     style="position: relative;">
                                    <!-- Person ID for debugging - floating in lower-right -->
                                    <span class="person-id-debug" x-show="person.id" x-text="person.id"></span>

                                    <!-- System Person Badge -->
                                    <template x-if="person.id === 2">
                                        <span class="system-person-badge is-success">ðŸ¤– Assistant</span>
                                    </template>

                                    <!-- Person Name Row -->
                                    <div class="is-flex is-align-items-center mb-2">
                                        {% if editable_mode %}
                                        <!-- User name is editable, Assistant is read-only -->
                                        <template x-if="person.id === 1">
                                            <strong class="is-size-7 editable-field person-name"
                                                    @mouseenter="hoveredField = 'person-' + index + '-name'"
                                                    @mouseleave="hoveredField = null"
                                                    @click.stop="startEdit('person-' + index + '-name', person.name || 'User')">
                                                <span x-show="!isEditing('person-' + index + '-name')" x-text="person.name || 'User'"></span>
                                                <input x-show="isEditing('person-' + index + '-name')" 
                                                       :value="editingValue"
                                                       @input="editingValue = $event.target.value"
                                                       @blur="savePersonName(index, $event.target.value)"
                                                       @keydown.enter="savePersonName(index, $event.target.value); $event.target.blur()"
                                                       @keydown.escape="cancelEdit(); $event.target.blur()"
                                                       class="inline-edit-input"
                                                       type="text">
                                            </strong>
                                        </template>
                                        <template x-if="person.id === 2">
                                            <strong class="is-size-7 has-text-grey-dark" title="Assistant name cannot be changed" x-text="person.name || 'Assistant'"></strong>
                                        </template>
                                        <!-- Regular person (not system) -->
                                        <template x-if="![1, 2].includes(person.id)">
                                            <strong class="is-size-7 editable-field person-name"
                                                    @mouseenter="hoveredField = 'person-' + index + '-name'"
                                                    @mouseleave="hoveredField = null"
                                                    @click.stop="startEdit('person-' + index + '-name', person.name || 'Unnamed')">
                                                <span x-show="!isEditing('person-' + index + '-name')" x-text="person.name || 'Unnamed'"></span>
                                                <input x-show="isEditing('person-' + index + '-name')" 
                                                       :value="editingValue"
                                                       @input="editingValue = $event.target.value"
                                                       @blur="savePersonName(index, $event.target.value)"
                                                       @keydown.enter="savePersonName(index, $event.target.value); $event.target.blur()"
                                                       @keydown.escape="cancelEdit(); $event.target.blur()"
                                                       class="inline-edit-input"
                                                       type="text">
                                            </strong>
                                        </template>
                                        {% else %}
                                        <strong class="is-size-7" x-text="person.name || 'Unnamed'"></strong>
                                        {% endif %}
                                        {% if editable_mode %}
                                        <span x-show="canEdit" class="delete-variable ml-auto" @click.stop="removePerson(index)" title="Remove delta">
                                            <i class="fas fa-times"></i>
                                        </span>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Person Kind (cumulative view - read only) -->
                                    <div class="sarf-field-row" x-show="person.gender">
                                        <span class="sarf-label">Kind:</span>
                                        <span class="sarf-value">
                                            <span class="event-kind-indicator" x-text="person.gender || '-'"></span>
                                        </span>
                                    </div>

                                    <!-- Confidence Row (only show for AI extractions, not cumulative/human-reviewed data) -->
                                    {% if not is_cumulative %}
                                    <div class="sarf-field-row" x-show="person.confidence && person.confidence < 0.999">
                                        <span class="sarf-label">Confidence:</span>
                                        <span class="sarf-value" x-text="(person.confidence * 100).toFixed(0) + '%'"></span>
                                    </div>
                                    {% endif %}

                                    <!-- Person Parents -->
                                    <template x-if="person.parents">
                                        <div class="sarf-field-row">
                                            <span class="sarf-label">Parents:</span>
                                            <span class="sarf-value">
                                                <span class="person-tag">
                                                    <span x-text="getPairBondName(person.parents, personDataVersion)"></span>
                                                </span>
                                            </span>
                                        </div>
                                    </template>
                                </div>
                                </template>
                            </template>
                        </div>
                    </template>
                    
                    <!-- Events Section -->
                    <template x-if="extractedData && ((extractedData.events && extractedData.events.length > 0) || {{ 'true' if editable_mode else 'false' }} || {{ 'true' if is_cumulative else 'false' }})">
                        <div class="events-section mb-2">
                            <div class="section-header is-size-7 has-text-weight-bold {{ 'has-text-link' if is_cumulative else '' }}">
                                {% if not is_cumulative %}<span class="icon is-small"><i class="fas fa-calendar-alt"></i></span>{% endif %}
                                Events
                                {% if editable_mode %}
                                <span x-show="canEdit" style="display: inline-flex; gap: 4px; position: relative;">
                                    <span class="add-element create-event-button" style="opacity: 1;" @click.stop="showCreateEventMenu($event)" title="Create New Event">
                                        <i class="fas fa-plus-circle"></i>
                                    </span>
                                    <span class="add-element edit-event-button" style="opacity: 1;" @click.stop="editEvent($event)" title="Edit Existing Event">
                                        <i class="fas fa-edit"></i>
                                    </span>
                                </span>
                                {% endif %}
                            </div>
                            {% if editable_mode %}
                            <!-- <template x-if="!extractedData.events || extractedData.events.length === 0">
                                <div class="has-text-centered has-text-grey-light py-3">
                                    <p class="is-size-7">No events yet. Click <i class="fas fa-plus-circle"></i> above to add.</p>
                                </div>
                            </template> -->
                            {% endif %}
                                <template x-for="(event, index) in (extractedData.events || [])" :key="index">
                                <div class="event-item mb-2 p-2 {{ 'has-background-link-light' if is_cumulative else 'has-background-light' }}" style="position: relative;">
                                    {% if editable_mode %}
                                    <span x-show="canEdit" class="delete-event" @click.stop="removeEvent(index)" title="Remove event">
                                        <i class="fas fa-times"></i>
                                    </span>
                                    {% endif %}
                                    <!-- Event ID for debugging - floating in lower-right -->
                                    <span class="event-id-debug" x-show="event.id" x-text="event.id"></span>
                                    <div class="event-header">
                                        <div class="event-metadata is-size-7 has-text-grey mt-1 mb-1">
                                            <span x-show="event.confidence && event.confidence < 0.999">
                                                Confidence: <span x-text="(event.confidence * 100).toFixed(0) + '%'"></span>
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Event Kind -->
                                    <div class="sarf-field-row">
                                        <span class="sarf-label">Event Kind:</span>
                                        <span class="sarf-value">
                                            {% if editable_mode %}
                                            <select x-show="canEdit"
                                                    :value="event.kind || 'shift'"
                                                    @change="saveEventKind(index, $event.target.value)"
                                                    class="inline-select-visible">
                                                <option value="shift">shift</option>
                                                <option value="birth">birth</option>
                                                <option value="adopted">adopted</option>
                                                <option value="bonded">bonded</option>
                                                <option value="married">married</option>
                                                <option value="separated">separated</option>
                                                <option value="divorced">divorced</option>
                                                <option value="moved">moved</option>
                                                <option value="death">death</option>
                                            </select>
                                            <span x-show="!canEdit" class="event-kind-indicator" x-text="event.kind || 'shift'"></span>
                                            {% else %}
                                            <span class="event-kind-indicator" x-text="event.kind || 'shift'"></span>
                                            {% endif %}
                                        </span>
                                    </div>

                                    <div class="sarf-divider"></div>

                                    <!-- Event Person -->
                                    <template x-if="event.person || {{ 'true' if editable_mode else 'false' }}">
                                        <div class="sarf-field-row">
                                            <span class="sarf-label" x-text="getPersonLabel(event.kind, event.relationship)"></span>
                                            <span class="sarf-value">
                                                <template x-if="event.person">
                                                    <span class="person-tag"
                                                          :style="{ cursor: canEdit ? 'pointer' : 'default' }"
                                                          :class="{'editable': {{ 'true' if editable_mode else 'false' }} && canEdit}"
                                                          @click="{{ 'canEdit && editEventPerson(index, event.person)' if editable_mode else '' }}">
                                                        <span x-text="getPersonName(event.person, personDataVersion)"></span>
                                                        {% if editable_mode %}
                                                        <span x-show="canEdit" style="margin-left: 4px; color: #ff4444; cursor: pointer; font-weight: bold;"
                                                              @click.stop="clearEventPerson(index)">Ã—</span>
                                                        {% endif %}
                                                    </span>
                                                </template>
                                                <template x-if="!event.person && {{ 'true' if editable_mode else 'false' }} && canEdit">
                                                    <span class="add-element edit-event-person-button" style="opacity: 1;" @click.stop="editEventPerson($event, index)" title="Select Existing Person for Event">
                                                        <i class="fas fa-edit"></i>
                                                    </span>
                                                </template>
                                            </span>
                                        </div>
                                    </template>

                                    <!-- Event Spouse -->
                                    <template x-if="(['bonded', 'married', 'separated', 'divorced', 'moved', 'birth', 'adopted'].includes(event.kind) && (event.spouse || {{ 'true' if editable_mode else 'false' }})) || (event.spouse && {{ 'true' if editable_mode else 'false' }})">
                                        <div class="sarf-field-row">
                                            <span class="sarf-label" x-text="(event.kind === 'birth' || event.kind === 'adopted') ? 'Parent 2:' : (event.kind === 'moved') ? 'Partner:' : 'Partner 2:'"></span>
                                            <span class="sarf-value">
                                                <template x-if="event.spouse">
                                                    <span class="person-tag"
                                                          :style="{ cursor: canEdit ? 'pointer' : 'default' }"
                                                          :class="{'editable': {{ 'true' if editable_mode else 'false' }} && canEdit}"
                                                          @click="{{ 'canEdit && editEventSpouse(index, event.spouse)' if editable_mode else '' }}">
                                                        <span x-text="getPersonName(event.spouse, personDataVersion)"></span>
                                                        {% if editable_mode %}
                                                        <span x-show="canEdit" style="margin-left: 4px; color: #ff4444; cursor: pointer; font-weight: bold;"
                                                              @click.stop="clearEventSpouse(index)">Ã—</span>
                                                        {% endif %}
                                                    </span>
                                                </template>
                                                <template x-if="!event.spouse && {{ 'true' if editable_mode else 'false' }} && canEdit">
                                                    <span class="add-element edit-event-spouse-button" style="opacity: 1;" @click.stop="editEventSpouse($event, index)" title="Select Existing Spouse for Event">
                                                        <i class="fas fa-edit"></i>
                                                    </span>
                                                </template>
                                            </span>
                                        </div>
                                    </template>

                                    <!-- Event Child -->
                                    <template x-if="(['birth', 'adopted'].includes(event.kind) && (event.child || {{ 'true' if editable_mode else 'false' }})) || (event.child && {{ 'true' if editable_mode else 'false' }})">
                                        <div class="sarf-field-row">
                                            <span class="sarf-label">Child:</span>
                                            <span class="sarf-value">
                                                <template x-if="event.child">
                                                    <span class="person-tag"
                                                          :style="{ cursor: canEdit ? 'pointer' : 'default' }"
                                                          :class="{'editable': {{ 'true' if editable_mode else 'false' }} && canEdit}"
                                                          @click="{{ 'canEdit && editEventChild(index, event.child)' if editable_mode else '' }}">
                                                        <span x-text="getPersonName(event.child, personDataVersion)"></span>
                                                        {% if editable_mode %}
                                                        <span x-show="canEdit" style="margin-left: 4px; color: #ff4444; cursor: pointer; font-weight: bold;"
                                                              @click.stop="clearEventChild(index)">Ã—</span>
                                                        {% endif %}
                                                    </span>
                                                </template>
                                                <template x-if="!event.child && {{ 'true' if editable_mode else 'false' }} && canEdit">
                                                    <span class="add-element edit-event-child-button" style="opacity: 1;" @click.stop="editEventChild($event, index)" title="Select Existing Child for Event">
                                                        <i class="fas fa-edit"></i>
                                                    </span>
                                                </template>
                                            </span>
                                        </div>
                                    </template>

                                    <!-- Event Description (for shift and death events) -->
                                    <template x-if="!event.kind || event.kind === 'shift' || event.kind === 'death'">
                                        <div class="sarf-field-row">
                                            <span class="sarf-label" x-text="event.kind === 'death' ? 'Cause:' : 'Description:'"></span>
                                            <span class="sarf-value">
                                                {% if editable_mode %}
                                                <span class="event-description"
                                                      :class="{'editable-field': canEdit}"
                                                      @mouseenter="canEdit && (hoveredField = 'event-' + index + '-description')"
                                                      @mouseleave="hoveredField = null"
                                                      @click.stop="canEdit && startEdit('event-' + index + '-description', event.description || '')">
                                                    <span x-show="!isEditing('event-' + index + '-description')" x-text="event.description || 'Not set'"></span>
                                                    <input x-show="isEditing('event-' + index + '-description')"
                                                           :value="editingValue"
                                                           @input="editingValue = $event.target.value"
                                                           @blur="saveEventDescription(index, $event.target.value)"
                                                           @keydown.enter="saveEventDescription(index, $event.target.value); $event.target.blur()"
                                                           @keydown.escape="cancelEdit(); $event.target.blur()"
                                                           class="inline-edit-input"
                                                           type="text">
                                                </span>
                                                {% else %}
                                                <span x-text="event.description || 'Not specified'"></span>
                                                {% endif %}
                                            </span>
                                        </div>
                                    </template>

                                    <div class="sarf-divider"></div>

                                    <!-- Event DateTime -->
                                    <template x-if="(event.dateTime && event.dateTime.trim() !== '') || {{ 'true' if editable_mode else 'false' }}">
                                        <div class="sarf-field-row">
                                            <span class="sarf-label">Date/Time:</span>
                                            <span class="sarf-value">
                                                {% if editable_mode %}
                                                <span class="event-datetime"
                                                      :class="{'editable-field': canEdit}"
                                                      @mouseenter="canEdit && (hoveredField = 'event-' + index + '-dateTime')"
                                                      @mouseleave="hoveredField = null"
                                                      @click.stop="canEdit && startEdit('event-' + index + '-dateTime', event.dateTime || '')">
                                                    <span x-show="!isEditing('event-' + index + '-dateTime')" x-text="formatDate(event.dateTime) || 'Not set'"></span>
                                                    <input x-show="isEditing('event-' + index + '-dateTime')"
                                                           :value="editingValue"
                                                           @input="editingValue = $event.target.value"
                                                           @blur="saveEventDateTime(index, $event.target.value)"
                                                           @keydown.enter="saveEventDateTime(index, $event.target.value); $event.target.blur()"
                                                           @keydown.escape="cancelEdit(); $event.target.blur()"
                                                           class="inline-edit-input"
                                                           type="date"
                                                           style="width: 150px;">
                                                </span>
                                                {% else %}
                                                <span x-text="formatDate(event.dateTime) || 'Not specified'"></span>
                                                {% endif %}
                                            </span>
                                            <span class="sarf-actions">
                                                {% if editable_mode %}
                                                <select x-show="canEdit"
                                                        :value="event.dateCertainty || 'approximate'"
                                                        @change="saveDateCertainty(index, $event.target.value)"
                                                        class="inline-select-visible">
                                                    <option value="approximate">approximate</option>
                                                    <option value="certain">certain</option>
                                                    <option value="unknown">unknown</option>
                                                </select>
                                                <span x-show="!canEdit" class="date-certainty-indicator" x-text="event.dateCertainty || 'approximate'"></span>
                                                {% else %}
                                                <span class="date-certainty-indicator" x-text="event.dateCertainty || 'approximate'"></span>
                                                {% endif %}
                                            </span>
                                        </div>
                                    </template>

                                    <div class="sarf-divider" x-show="!event.kind || event.kind === 'shift'"></div>

                                    <!-- SARF Variables (only shown for 'shift' events) -->
                                    <div class="sarf-variables-section"
                                         x-show="!event.kind || event.kind === 'shift'"
                                         {% if editable_mode %}@click.stop{% endif %}>
                                        <!-- Symptom Variable -->
                                        <div class="sarf-field-row" :class="{ 'has-text-grey-light': !event.symptom }">
                                            <span class="sarf-label">Symptom:</span>
                                            <span class="sarf-value">
                                                <template x-if="event.symptom">
                                                    {% if editable_mode %}
                                                    <span class="shift-indicator is-small" :class="'shift-' + event.symptom">
                                                        <select x-show="canEdit"
                                                                :value="event.symptom"
                                                                @change="saveShift(index, 'symptom', $event.target.value)"
                                                                class="inline-select-visible">
                                                            <option value="up">up</option>
                                                            <option value="down">down</option>
                                                            <option value="same">same</option>
                                                        </select>
                                                        <span x-show="!canEdit" x-text="event.symptom"></span>
                                                    </span>
                                                    {% else %}
                                                    <span class="shift-indicator is-small" :class="'shift-' + event.symptom" x-text="event.symptom"></span>
                                                    {% endif %}
                                                </template>
                                                <template x-if="!event.symptom && {{ 'true' if editable_mode else 'false' }} && canEdit">
                                                    <span class="add-element" @click.stop="addVariable(index, 'symptom')" title="Add symptom variable">
                                                        <i class="fas fa-plus-circle"></i>
                                                    </span>
                                                </template>
                                                <template x-if="!event.symptom && !canEdit">
                                                    <span>-</span>
                                                </template>
                                            </span>
                                            <span class="sarf-actions">
                                                {% if editable_mode %}
                                                <span class="delete-variable"
                                                      x-show="canEdit && event.symptom"
                                                      @click.stop="removeVariable(index, 'symptom')"
                                                      title="Remove symptom">
                                                    <i class="fas fa-times"></i>
                                                </span>
                                                {% endif %}
                                            </span>
                                        </div>
                                        <!-- Anxiety Variable -->
                                        <div class="sarf-field-row" :class="{ 'has-text-grey-light': !event.anxiety }">
                                            <span class="sarf-label">Anxiety:</span>
                                            <span class="sarf-value">
                                                <template x-if="event.anxiety">
                                                    {% if editable_mode %}
                                                    <span class="shift-indicator is-small" :class="'shift-' + event.anxiety">
                                                        <select x-show="canEdit"
                                                                :value="event.anxiety"
                                                                @change="saveShift(index, 'anxiety', $event.target.value)"
                                                                class="inline-select-visible">
                                                            <option value="up">up</option>
                                                            <option value="down">down</option>
                                                            <option value="same">same</option>
                                                        </select>
                                                        <span x-show="!canEdit" x-text="event.anxiety"></span>
                                                    </span>
                                                    {% else %}
                                                    <span class="shift-indicator is-small" :class="'shift-' + event.anxiety" x-text="event.anxiety"></span>
                                                    {% endif %}
                                                </template>
                                                <template x-if="!event.anxiety && {{ 'true' if editable_mode else 'false' }} && canEdit">
                                                    <span class="add-element" @click.stop="addVariable(index, 'anxiety')" title="Add anxiety variable">
                                                        <i class="fas fa-plus-circle"></i>
                                                    </span>
                                                </template>
                                                <template x-if="!event.anxiety && !canEdit">
                                                    <span>-</span>
                                                </template>
                                            </span>
                                            <span class="sarf-actions">
                                                {% if editable_mode %}
                                                <span class="delete-variable"
                                                      x-show="canEdit && event.anxiety"
                                                      @click.stop="removeVariable(index, 'anxiety')"
                                                      title="Remove anxiety">
                                                    <i class="fas fa-times"></i>
                                                </span>
                                                {% endif %}
                                            </span>
                                        </div>
                                        <!-- Relationship Variable -->
                                        <div class="sarf-field-row" :class="{ 'has-text-grey-light': !event.relationship }">
                                            <span class="sarf-label">Relationship:</span>
                                            <span class="sarf-value">
                                                <template x-if="event.relationship">
                                                    {% if editable_mode %}
                                                    <span class="shift-indicator shift-relationship is-small">
                                                        <select x-show="canEdit"
                                                                :value="event.relationship"
                                                                @change="saveRelationshipKind(index, $event.target.value)"
                                                                class="inline-select-visible">
                                                            <option value="conflict">conflict</option>
                                                            <option value="distance">distance</option>
                                                            <option value="overfunctioning">overfunctioning</option>
                                                            <option value="underfunctioning">underfunctioning</option>
                                                            <option value="projection">projection</option>
                                                            <option value="defined-self">defined-self</option>
                                                            <option value="toward">toward</option>
                                                            <option value="away">away</option>
                                                            <option value="inside">inside</option>
                                                            <option value="outside">outside</option>
                                                            <option value="cutoff">cutoff</option>
                                                        </select>
                                                        <span x-show="!canEdit" x-text="event.relationship"></span>
                                                    </span>
                                                    {% else %}
                                                    <span class="shift-indicator shift-relationship is-small" x-text="event.relationship"></span>
                                                    {% endif %}
                                                </template>
                                                <template x-if="!event.relationship && {{ 'true' if editable_mode else 'false' }} && canEdit">
                                                    <span class="add-element" @click.stop="addVariable(index, 'relationship')" title="Add relationship variable">
                                                        <i class="fas fa-plus-circle"></i>
                                                    </span>
                                                </template>
                                                <template x-if="!event.relationship && !canEdit">
                                                    <span>-</span>
                                                </template>
                                            </span>
                                            <span class="sarf-actions">
                                                {% if editable_mode %}
                                                <span class="delete-variable"
                                                      x-show="canEdit && event.relationship"
                                                      @click.stop="removeVariable(index, 'relationship')"
                                                      title="Remove relationship">
                                                    <i class="fas fa-times"></i>
                                                </span>
                                                {% endif %}
                                            </span>
                                        </div>
                                        <!-- Relationship Details - Shown below the main variable row -->
                                        <template x-if="event.relationship">
                                            <div class="relationship-details-content" style="margin-left: 1em;">
                                                <!-- Relationship Targets - shown for all relationship types -->
                                                <template x-if="(event.relationshipTargets && event.relationshipTargets.length > 0) || {{ 'true' if editable_mode else 'false' }}">
                                                    <div class="sarf-field-row">
                                                        <span class="sarf-label" x-text="getTargetsLabel(event.relationship)"></span>
                                                        <span class="sarf-value">
                                                            <span style="display: inline-flex; flex-wrap: wrap; align-items: center; gap: 2px;">
                                                                <template x-for="(personId, idx) in (event.relationshipTargets || [])" :key="personId + '-' + idx">
                                                                    <span class="person-tag"
                                                                          :style="{ cursor: canEdit ? 'pointer' : 'default' }"
                                                                          :class="{'editable': {{ 'true' if editable_mode else 'false' }} && canEdit}"
                                                                          @click="{{ 'canEdit && editRelationshipPerson($event, index, \'targets\', idx)' if editable_mode else '' }}">
                                                                        <span x-text="getPersonName(personId, personDataVersion)"></span>
                                                                        {% if editable_mode %}
                                                                        <span x-show="canEdit" style="margin-left: 4px; color: #ff4444; cursor: pointer; font-weight: bold;"
                                                                              @click.stop="removeRelationshipPerson(index, 'targets', idx)">Ã—</span>
                                                                        {% endif %}
                                                                    </span>
                                                                </template>
                                                                {% if editable_mode %}
                                                                <span x-show="canEdit" class="add-element add-relationship-person-button"
                                                                      @click.stop="addRelationshipPerson($event, index, 'targets')"
                                                                      title="Select existing person"
                                                                      style="opacity: 1;">
                                                                    <i class="fas fa-edit"></i>
                                                                </span>
                                                                {% endif %}
                                                            </span>
                                                        </span>
                                                    </div>
                                                </template>

                                                <!-- Relationship Triangles - ONLY shown for inside/outside -->
                                                <template x-if="['inside', 'outside'].includes(event.relationship)">
                                                    <template x-if="(event.relationshipTriangles && event.relationshipTriangles.length > 0) || {{ 'true' if editable_mode else 'false' }}">
                                                        <div class="sarf-field-row">
                                                            <span class="sarf-label" x-text="getTrianglesLabel(event.relationship)"></span>
                                                            <span class="sarf-value">
                                                                <span style="display: inline-flex; flex-wrap: wrap; align-items: center; gap: 2px;">
                                                                    <template x-for="(personId, idx) in (event.relationshipTriangles || [])" :key="personId + '-' + idx">
                                                                        <span class="person-tag"
                                                                              style="display: inline-block; padding: 2px 8px; margin: 2px; background: #ffe8e8; border: 1px solid #ffb3b3; border-radius: 4px; font-size: 0.85rem; white-space: nowrap; cursor: pointer;"
                                                                              :class="{'editable': {{ 'true' if editable_mode else 'false' }} && canEdit}"
                                                                              @click="{{ 'canEdit && editRelationshipPerson($event, index, \'triangles\', idx)' if editable_mode else '' }}">
                                                                            <span x-text="getPersonName(personId, personDataVersion)"></span>
                                                                            {% if editable_mode %}
                                                                            <span x-show="canEdit" style="margin-left: 4px; color: #ff4444; cursor: pointer; font-weight: bold;"
                                                                                  @click.stop="removeRelationshipPerson(index, 'triangles', idx)">Ã—</span>
                                                                            {% endif %}
                                                                        </span>
                                                                    </template>
                                                                    {% if editable_mode %}
                                                                    <span x-show="canEdit" class="add-element add-relationship-person-button"
                                                                          @click.stop="addRelationshipPerson($event, index, 'triangles')"
                                                                          title="Select existing person"
                                                                          style="opacity: 1;">
                                                                        <i class="fas fa-edit"></i>
                                                                    </span>
                                                                    {% endif %}
                                                                </span>
                                                            </span>
                                                        </div>
                                                    </template>
                                                </template>
                                            </div>
                                        </template>

                                        <!-- Subtle divider before Functioning -->
                                        <div class="variable-divider"></div>

                                        <!-- Functioning Variable -->
                                        <div class="sarf-field-row" :class="{ 'has-text-grey-light': !event.functioning }">
                                            <span class="sarf-label">Functioning:</span>
                                            <span class="sarf-value">
                                                <template x-if="event.functioning">
                                                    {% if editable_mode %}
                                                    <span class="shift-indicator is-small" :class="'shift-functioning-' + event.functioning">
                                                        <select x-show="canEdit"
                                                                :value="event.functioning"
                                                                @change="saveShift(index, 'functioning', $event.target.value)"
                                                                class="inline-select-visible">
                                                            <option value="up">up</option>
                                                            <option value="down">down</option>
                                                            <option value="same">same</option>
                                                        </select>
                                                        <span x-show="!canEdit" x-text="event.functioning"></span>
                                                    </span>
                                                    {% else %}
                                                    <span class="shift-indicator is-small"
                                                          :class="'shift-functioning-' + event.functioning"
                                                          x-text="event.functioning"></span>
                                                    {% endif %}
                                                </template>
                                                <!-- Rationale display for Functioning -->
                                                <template x-if="event.functioning && event.functioning.rationale">
                                                    <span class="is-size-7 has-text-grey is-italic" x-text="'â†’ ' + event.functioning.rationale"></span>
                                                </template>
                                                <template x-if="!event.functioning && {{ 'true' if editable_mode else 'false' }} && canEdit">
                                                    <span class="add-element" @click.stop="addVariable(index, 'functioning')" title="Add functioning variable">
                                                        <i class="fas fa-plus-circle"></i>
                                                    </span>
                                                </template>
                                                <template x-if="!event.functioning && !canEdit">
                                                    <span>-</span>
                                                </template>
                                            </span>
                                            <span class="sarf-actions">
                                                {% if editable_mode %}
                                                <span class="delete-variable"
                                                      x-show="canEdit && event.functioning"
                                                      @click.stop="removeVariable(index, 'functioning')"
                                                      title="Remove functioning">
                                                    <i class="fas fa-times"></i>
                                                </span>
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                </template>
                        </div>
                    </template>

                    <!-- Deletes Section -->
                    <template x-if="extractedData && ((extractedData.delete && extractedData.delete.length > 0) || {{ 'true' if editable_mode else 'false' }})">
                        <div class="deletes-section mb-2">
                            <div class="section-header is-size-7 has-text-weight-bold has-text-danger">
                                <span class="icon is-small"><i class="fas fa-trash"></i></span>
                                Deletes
                                {% if editable_mode %}
                                <span x-show="canEdit" class="add-element add-delete-button" style="opacity: 1; margin-left: 8px; position: relative;" @click.stop="showDeleteDropdown($event)" title="Add Delete">
                                    <i class="fas fa-edit"></i>
                                </span>
                                {% endif %}
                            </div>
                            <template x-if="extractedData.delete && extractedData.delete.length > 0">
                                <template x-for="(deleteId, index) in extractedData.delete" :key="index">
                                <div class="delete-item mb-1 p-2 has-background-warning-light" style="position: relative;">
                                    <!-- Delete ID Row -->
                                    <div class="is-flex is-align-items-center">
                                        <strong class="is-size-7">ID: </strong>
                                        {% if editable_mode %}
                                        <select x-show="canEdit"
                                                :value="deleteId"
                                                @change="saveDeleteId(index, parseInt($event.target.value))"
                                                class="inline-select-visible ml-1">
                                            <template x-for="availableId in getAllAvailableIds()" :key="availableId.id">
                                                <option :value="availableId.id" x-text="availableId.label"></option>
                                            </template>
                                        </select>
                                        <span x-show="!canEdit" class="is-size-7 ml-1" x-text="deleteId"></span>
                                        <span x-show="canEdit" class="delete-variable ml-auto" @click.stop="removeDelete(index)" title="Remove delete">
                                            <i class="fas fa-times"></i>
                                        </span>
                                        {% else %}
                                        <span class="is-size-7 ml-1" x-text="deleteId"></span>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Show what this ID refers to -->
                                    <div class="is-size-7 has-text-grey mt-1">
                                        <span x-text="getItemDescription(deleteId)"></span>
                                    </div>
                                </div>
                                </template>
                            </template>
                        </div>
                    </template>
                </div>
                
                {% if show_feedback and not editable_mode %}
                <!-- Data Feedback Controls -->
                <div class="mt-3 p-3 {% if feedback_data %}feedback-submitted{% endif %}" onclick="event.stopPropagation()">                                    
                    {% if feedback_data %}
                    <div class="notification is-success is-light is-small">
                        <strong>Your feedback:</strong><br>
                        {{ 'ðŸ‘Ž Needs work' if feedback_data.thumbs_down else 'ðŸ‘ Good' }}<br>
                        {% if feedback_data.comment %}
                        <small>{{ feedback_data.comment }}</small>
                        {% endif %}
                        
                        {% if feedback_data.edited_extraction %}
                        <div class="mt-2">
                            <div class="has-text-weight-bold is-size-7 mb-1">Your Expected Extraction:</div>
                            <div class="auditor-corrected-data" x-data='{ correctedData: {{ feedback_data.edited_extraction|tojson }} }'>
                                {% include "components/extracted_data_corrected.html" %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <button class="button is-small is-danger is-outlined mt-2" @click="deleteFeedback(feedbackId)">
                            Delete feedback
                        </button>
                    </div>
                    {% else %}
                    <!-- Feedback Form -->
                    <div class="extraction-feedback" x-show="!submitted">
                        <div class="field">
                            <label class="label is-small">Data Extraction Quality</label>
                            <div class="control">
                                <button class="thumbs-button is-small" 
                                        :class="{ 'is-active': !thumbsDown }"
                                        @click="thumbsDown = false" type="button">
                                    ðŸ‘
                                </button>
                                <button class="thumbs-button is-small" 
                                        :class="{ 'is-active': thumbsDown }"
                                        @click="thumbsDown = true" type="button">
                                    ðŸ‘Ž
                                </button>
                            </div>
                        </div>
                        
                        <div class="field" x-show="thumbsDown">
                            <label class="label is-small">Comments (optional)</label>
                            <div class="control">
                                <textarea class="textarea is-small" 
                                          placeholder="Comments on data extraction..."
                                          rows="2"
                                          id="extraction-comment-{{ message_id }}"></textarea>
                            </div>
                        </div>
                        
                        <div class="field">
                            <button class="button is-primary is-small"
                                    @click="submitExtractionFeedback({{ message_id|tojson if message_id else 'null' }}, thumbsDown, null)">
                                Submit
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                </div>{# close sarf-editor-content #}
            </div>
        </div>

    </div>
    {% endif %}

    {% else %}
    <!-- No Data View -->
    <div class="no-data-section">
        <div class="data-summary">
            <small class="has-text-grey">No data extracted</small>
        </div>
    </div>
    {% endif %}
</div>

<style>
/* In-place editor styles */
.editable-field {
    position: relative;
    display: inline-block;
    padding: 2px 4px;
    border-radius: 3px;
    transition: all 0.2s ease;
}

.editable-field:hover {
    background: rgba(0, 123, 255, 0.05);
    cursor: text;
}

.event-kind-indicator {
    display: inline-block;
    min-width: 50px;
    padding: 2px 8px;
    border-radius: 3px;
    background: #e9ecef;
    color: #495057;
    font-size: 0.75rem;
    font-weight: 500;
    text-align: center;
    text-transform: lowercase;
    transition: all 0.2s ease;
    border: 1px solid #ced4da;
}

.event-kind-indicator.editable-field {
    cursor: pointer;
}

.event-kind-indicator.editable-field:hover {
    background: #d3d9df;
    border-color: #adb5bd;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.15);
}

/* Dark mode styles for event-kind-indicator */
[data-theme="dark"] .event-kind-indicator {
    background: #3a3837;
    color: #e0e0e0;
    border-color: #5a5a5a;
}

[data-theme="dark"] .event-kind-indicator.editable-field:hover {
    background: #4a4847;
    border-color: #6a6a6a;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3);
}

.date-certainty-indicator {
    display: inline-block;
    min-width: 50px;
    padding: 2px 8px;
    border-radius: 3px;
    background: #e9ecef;
    color: #495057;
    font-size: 0.75rem;
    font-weight: 500;
    text-align: center;
    text-transform: lowercase;
    transition: all 0.2s ease;
    border: 1px solid #ced4da;
}

.date-certainty-indicator.editable-field {
    cursor: pointer;
}

.date-certainty-indicator.editable-field:hover {
    background: #d3d9df;
    border-color: #adb5bd;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.15);
}

[data-theme="dark"] .date-certainty-indicator {
    background: #3a3837;
    color: #e0e0e0;
    border-color: #5a5a5a;
}

[data-theme="dark"] .date-certainty-indicator.editable-field:hover {
    background: #4a4847;
    border-color: #6a6a6a;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3);
}

.editable-shift {
    position: relative;
    transition: all 0.2s ease;
}

.editable-shift:hover {
    opacity: 0.8;
    cursor: pointer;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
}

.editable-relationship {
    position: relative;
    transition: all 0.2s ease;
}

.editable-relationship:hover {
    opacity: 0.8;
    cursor: pointer;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
}

.inline-edit-input,
.inline-edit-select {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 20;
    min-width: 100%;
    border: 1px solid #007bff;
    background: white;
    padding: 2px 4px;
    font-size: inherit;
    font-weight: inherit;
    border-radius: 3px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Remove left padding specifically for event description inputs */
.event-description .inline-edit-input {
    padding-left: 0 !important;
}

/* Remove left padding from event description editable field */
.event-description .editable-field {
    padding-left: 0 !important;
}

/* Reset button positioned in top right corner */
.reset-button {
    position: absolute;
    top: auto;
    right: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    padding: 0;
    margin-top: -6px;
    margin-right: -8px;
    border: 1px solid #3273dc;
    background: white;
    color: #3273dc;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.75rem;
    transition: all 0.2s ease;
    z-index: 10;
}

.reset-button:hover {
    background: #3273dc;
    color: white;
}

/* Event ID debug info - floating in lower-right corner */
.event-id-debug,
.person-id-debug {
    position: absolute;
    bottom: 4px;
    right: 4px;
    background: #ddd;
    color: #444444;
    padding: 1px 4px;
    font-size: 0.65rem;
    border-radius: 2px;
    font-family: monospace;
    z-index: 5;
    opacity: 0.7;
    pointer-events: auto;
    user-select: text;
}

[data-theme="dark"] .event-id-debug,
[data-theme="dark"] .person-id-debug {
    background: #3a3837;
    color: #e0e0e0;
}

.add-element {
    display: inline-block;
    opacity: 0.7;
    transition: opacity 0.2s;
    color: #6c757d;
    font-size: 0.85em;
    cursor: pointer;
    margin-left: 8px;
}

.add-element:hover {
    opacity: 1 !important;
    color: #007bff;
}

.delete-variable {
    display: inline-block;
    opacity: 0.6;
    transition: opacity 0.2s;
    color: #dc3545;
    font-size: 0.85em;
    font-weight: bold;
    cursor: pointer;
    padding: 2px 4px;
    border-radius: 2px;
}


.delete-variable:hover {
    opacity: 1 !important;
    background: rgba(220, 53, 69, 0.1);
}

.field-modified {
    background: rgba(40, 167, 69, 0.1);
    border-left: 2px solid #28a745;
}

.field-added {
    background: rgba(0, 123, 255, 0.1);
    border-left: 2px solid #007bff;
}

.field-removed {
    background: rgba(220, 53, 69, 0.1);
    text-decoration: line-through;
    opacity: 0.6;
}


/* Delete event button - positioned absolutely in upper right corner */
.delete-event {
    position: absolute;
    top: 8px;
    right: 8px;
    display: inline-block;
    opacity: 0.6;
    transition: opacity 0.2s;
    color: #dc3545;
    font-size: 0.85em;
    font-weight: bold;
    cursor: pointer;
    padding: 4px 6px;
    border-radius: 3px;
    z-index: 10;
}

.delete-event:hover {
    opacity: 1;
    background: rgba(220, 53, 69, 0.1);
}


/* Semantic shift colors for variables */
.shift-up {
    background-color: #e74c3c !important; /* Red - bad by default */
    color: white !important;
}

.shift-down {
    background-color: #27ae60 !important; /* Green - good by default */
    color: white !important;
}

.shift-same {
    background-color: #95a5a6 !important; /* Gray - neutral */
    color: white !important;
}

/* Functioning has opposite semantics - up is good, down is bad */
.shift-functioning-up {
    background-color: #27ae60 !important; /* Green - good for functioning */
    color: white !important;
}

.shift-functioning-down {
    background-color: #e74c3c !important; /* Red - bad for functioning */
    color: white !important;
}

/* Enhanced select styling - while we can't style options, we can improve the select itself */
.inline-edit-select {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 20;
    min-width: 100%;
    border: 1px solid #007bff;
    background: white;
    padding: 2px 4px;
    font-size: inherit;
    font-weight: inherit;
    border-radius: 3px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    cursor: pointer;
}

/* Always-visible select that looks like text until clicked */
.inline-select-visible {
    position: relative;
    border: 1px solid #676767;
    border-radius: 3px;
    background: transparent;
    padding: 1px 2px;
    font-size: inherit;
    font-weight: inherit;
    cursor: pointer;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    color: inherit;
}

/* Remove border when select is inside a colored shift-indicator */
.shift-indicator .inline-select-visible {
    border: none;
}

.inline-select-visible:focus {
    outline: none;
    border-color: #007bff;
    border-radius: 3px;
    background: white;
}

[data-theme="dark"] .inline-select-visible:focus {
    background: #2d2b2a;
}

[data-theme="dark"] .inline-select-visible option {
    background: #2d2b2a;
    color: #ffffff;
}

.inline-edit-select:focus {
    outline: none;
    border-color: #0056b3;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
}

.inline-edit-select option {
    color: #333 !important;
    background: white !important;
}

.shift-relationship .inline-edit-select {
    color: #333 !important;
}

/* Dark mode styles for select elements */
[data-theme="dark"] .inline-edit-select {
    background: #2d2b2a;
    color: #ffffff;
    border-color: #4a4a4a;
}

[data-theme="dark"] .inline-edit-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3);
}

[data-theme="dark"] .inline-edit-select option {
    color: #ffffff !important;
    background: #2d2b2a !important;
}

[data-theme="dark"] .shift-relationship .inline-edit-select {
    color: #ffffff !important;
}

/* Relationship hierarchy styles */
.relationship-header {
    padding-bottom: 4px;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

/* Ensure all relationship tables respect column widths */
.relationship-details-content table {
    table-layout: fixed !important;
}

.relationship-details-content table td:first-child {
    width: 80px !important;
    min-width: 80px !important;
    max-width: 80px !important;
}

.mechanism-details, .triangle-details {
    padding-left: 16px;
    margin-top: 4px;
}

.mechanism-field, .triangle-field {
    margin-bottom: 4px;
    line-height: 1.5;
    display: flex;
    align-items: center;
    gap: 8px;
}

.mechanism-field .field-label,
.triangle-field .field-label {
    white-space: nowrap;
    flex-shrink: 0;
}

.relationship-people-container {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    flex-wrap: wrap;
}

/* Make template elements not affect layout */
.relationship-people-container template {
    display: contents;
}

.person-tag {
    display: inline-flex !important;
    align-items: center;
    gap: 2px;
    background-color: #e3f2fd !important;
    border: 1px solid #bbdefb !important;
    border-radius: 3px !important;
    padding: 0.25rem 0.5em !important;
    margin: 1px 2px 1px 0 !important;
    font-size: 0.75rem !important;
    line-height: 1.5;
    max-width: 100% !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    color: #1565c0;
    white-space: nowrap;
    min-width: 50px;
    height: 1.5em;
    text-align: center;
    justify-content: center;
    box-sizing: border-box;
}

/* First person tag in each row aligns with shift indicator */
.person-tag:first-child {
    margin-left: 0 !important;
}

.person-tag.editable {
    cursor: pointer;
    transition: all 0.2s ease;
}

.person-tag.editable:hover {
    background-color: #bbdefb;
    border-color: #90caf9;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.person-tag .delete-person {
    color: #dc3545;
    cursor: pointer;
    margin-left: 4px;
    font-size: 0.65rem;
}

.person-tag .delete-person:hover {
    color: #a71d2a;
}

.relationship-details .field-label {
    font-weight: 600;
    color: #495057;
    margin-right: 6px;
}

.relationship-details .person-tag {
    background-color: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 12px;
    padding: 2px 8px;
    font-size: 0.75rem;
    color: #1565c0;
    margin-right: 4px;
    display: inline-block;
}

.person-tags-inline {
    display: inline-flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-left: 6px;
}

.person-tag-inline {
    background-color: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 12px;
    padding: 2px 8px;
    font-size: 0.75rem;
    color: #1565c0;
    display: inline-block;
}

/* Delete item styling */
.delete-item {
    border-radius: 4px;
    border: 1px solid #ffc107;
}

.delete-id .inline-edit-select {
    min-width: 200px; /* Wider dropdown for better readability */
}

.deletes-section .section-header {
    color: #856404 !important;
}

.delete-item:hover {
    background-color: #fff3cd !important;
}

/* Variable rationale styling */
.variable-rationale {
    margin-top: 2px;
    margin-left: 8px;
    line-height: 1.2;
    max-width: 100%;
    word-wrap: break-word;
}

.variable-rationale span {
    font-size: 0.7rem !important;
    opacity: 0.8;
    font-style: italic !important;
    color: #666 !important;
}

/* System person styling */
.system-person-badge {
    position: absolute;
    top: 4px;
    right: 4px;
    font-size: 0.7rem !important;
    padding: 2px 6px;
    border-radius: 12px;
    font-weight: 600;
    z-index: 6;
    opacity: 0.9;
}

.system-person-badge.is-primary {
    background: #3273dc;
    color: white;
}

.system-person-badge.is-success {
    background: #23d160;
    color: white;
}

.system-person-lock {
    display: inline-block;
    opacity: 0.7;
    font-size: 0.85em;
    cursor: not-allowed;
    padding: 2px 4px;
}

.system-person-lock:hover {
    opacity: 0.9;
}

.admin-tabbed-data {
    border: 1px solid #dbdbdb;
    border-radius: 6px;
    background: white;
    max-width: 100%;
}

.admin-tabbed-data .tabs {
    margin-bottom: 0;
    overflow-x: auto;
    overflow-y: hidden;
}

.admin-tabbed-data .tabs ul {
    border-bottom: 1px solid #dbdbdb;
    margin-bottom: 0;
    white-space: nowrap;
    min-width: max-content;
    flex-wrap: nowrap;
}

.admin-tabbed-data .tabs ul li {
    flex-shrink: 0;
}

.tab-content-area {
    border-radius: 0 0 6px 6px;
    background: white;
}

.admin-controls {
    background: #fafafa;
    border-bottom: 1px solid #dbdbdb;
}

.admin-tabbed-data .expanded-data-section {
    border: none;
    background: none;
}

.admin-tabbed-data .data-content {
    background: white;
    border: none;
    border-radius: 0;
    padding: 1rem;
}

/* All data content styling - no borders, let parent container handle it */
.expanded-data-section .data-content {
    border: none;
    border-radius: 0;
    background: transparent;
    padding: 0;
}

/* Expanded data section provides the visual container */
.expanded-data-section {
    border: 1px solid #dbdbdb;
    border-radius: 6px;
    background: white;
    padding: 1rem;
}


.tabs.is-boxed a {
    border-radius: 4px 4px 0 0;
}

.tabs.is-boxed li.is-active a {
    background: white;
    border-color: #dbdbdb;
    border-bottom-color: white;
}

/* Dark mode styling - Family Diagram style */
[data-theme="dark"] .person-tag {
    background-color: rgba(232, 244, 255, 0.15) !important;
    border-color: rgba(179, 217, 255, 0.3) !important;
    color: var(--color-accent-fg) !important;
}

[data-theme="dark"] .person-tag.editable:hover {
    background-color: rgba(232, 244, 255, 0.25) !important;
    border-color: rgba(179, 217, 255, 0.5) !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

[data-theme="dark"] .person-tag .delete-person {
    color: rgba(255, 107, 107, 0.9);
}

[data-theme="dark"] .person-tag .delete-person:hover {
    color: rgb(255, 107, 107);
}

[data-theme="dark"] .relationship-details .field-label {
    color: var(--color-fg-muted);
}

[data-theme="dark"] .relationship-details .person-tag,
[data-theme="dark"] .person-tag-inline {
    background-color: rgba(232, 244, 255, 0.15);
    border-color: rgba(179, 217, 255, 0.3);
    color: var(--color-accent-fg);
}

[data-theme="dark"] .delete-item {
    border-color: rgba(255, 193, 7, 0.5);
}

[data-theme="dark"] .deletes-section .section-header {
    color: rgba(255, 193, 7, 0.9) !important;
}

[data-theme="dark"] .delete-item:hover {
    background-color: rgba(255, 193, 7, 0.15) !important;
}

[data-theme="dark"] .variable-rationale span {
    color: var(--color-fg-muted) !important;
}

[data-theme="dark"] .admin-tabbed-data {
    border-color: var(--color-border-default);
    background: var(--color-card-bg);
}

[data-theme="dark"] .admin-tabbed-data .tabs ul {
    border-bottom-color: var(--color-border-default);
}

[data-theme="dark"] .tab-content-area {
    background: var(--color-card-bg);
}

[data-theme="dark"] .admin-controls {
    background: var(--color-canvas-subtle);
    border-bottom-color: var(--color-border-default);
}

[data-theme="dark"] .admin-tabbed-data .data-content {
    background: var(--color-card-bg);
}

[data-theme="dark"] .expanded-data-section {
    border-color: var(--color-border-default);
    background: var(--color-card-bg);
}

[data-theme="dark"] .tabs.is-boxed li.is-active a {
    background: var(--color-card-bg);
    border-color: var(--color-border-default);
    border-bottom-color: var(--color-card-bg);
}
</style>

