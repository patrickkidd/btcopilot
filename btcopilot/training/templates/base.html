<!DOCTYPE html>
<html data-theme="{{ theme }}">
<head>
    <title>BTCopilot Training App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="version" content="{{ version }}">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html@3.4.47/bundles/css/diff2html.min.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/sse.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/diff2html@3.4.47/bundles/js/diff2html.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <style>
        /* GitHub-style Dark Mode Theme */
        :root {
            /* Light theme colors (default) */
            --color-canvas-default: #ffffff;
            --color-canvas-subtle: #f6f8fa;
            --color-canvas-inset: #f6f8fa;
            --color-border-default: #d0d7de;
            --color-border-muted: #e1e4e8;
            --color-fg-default: #24292f;
            --color-fg-muted: #57606a;
            --color-fg-subtle: #6e7781;
            --color-accent-fg: #0969da;
            --color-accent-emphasis: #0969da;
            --color-success-fg: #1a7f37;
            --color-success-emphasis: #2da44e;
            --color-danger-fg: #cf222e;
            --color-danger-emphasis: #cf222e;
            --color-attention-fg: #9a6700;
            --color-attention-emphasis: #bf8700;
            --color-done-fg: #8250df;
            --color-done-emphasis: #8250df;

            /* Message specific */
            --color-message-user-bg: #ddf4ff;
            --color-message-user-border: #0969da;
            --color-message-ai-bg: #f6f8fa;
            --color-message-ai-border: #2da44e;

            /* Navbar gradient */
            --navbar-gradient-start: #667eea;
            --navbar-gradient-end: #764ba2;

            /* Cards and containers */
            --color-card-bg: #ffffff;
            --color-card-border: #d0d7de;
            --color-card-header-bg: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);

            /* Buttons */
            --color-btn-hover-bg: #f3f4f6;
            --color-btn-active-bg: #e5e7eb;
        }

        [data-theme="dark"] {
            /* Dark theme colors - matching Family Diagram app */
            --color-canvas-default: #1e1e1e;  /* WINDOW_BG */
            --color-canvas-subtle: #2d2b2a;   /* QML_ITEM_ALTERNATE_BG */
            --color-canvas-inset: #323232;    /* QML_HEADER_BG */
            --color-border-default: #4d4c4c;  /* QML_ITEM_BORDER_COLOR */
            --color-border-muted: #373534;    /* slightly lighter than item bg */
            --color-fg-default: #ffffff;      /* TEXT_COLOR (white) */
            --color-fg-muted: #b0b0b0;        /* lighter gray for muted text */
            --color-fg-subtle: #767676;       /* GRID_COLOR */
            --color-accent-fg: #fcf5c9;       /* NODAL_COLOR (yellow) */
            --color-accent-emphasis: #fcf5c9; /* NODAL_COLOR */
            --color-success-fg: #90ee90;      /* light green */
            --color-success-emphasis: #2da44e;
            --color-danger-fg: #ff6b6b;       /* light red */
            --color-danger-emphasis: #cf222e;
            --color-attention-fg: #fcf5c9;    /* NODAL_COLOR (yellow) */
            --color-attention-emphasis: #d4a017;
            --color-done-fg: #b19cd9;         /* light purple */
            --color-done-emphasis: #8957e5;

            /* Message specific */
            --color-message-user-bg: #373534;  /* QML_ITEM_BG */
            --color-message-user-border: #fcf5c9;
            --color-message-ai-bg: #2d2b2a;    /* QML_ITEM_ALTERNATE_BG */
            --color-message-ai-border: #90ee90;

            /* Navbar gradient - using Family Diagram colors */
            --navbar-gradient-start: #373534;
            --navbar-gradient-end: #2d2b2a;

            /* Cards and containers */
            --color-card-bg: #373534;          /* QML_ITEM_BG */
            --color-card-border: #4d4c4c;      /* QML_ITEM_BORDER_COLOR */
            --color-card-header-bg: linear-gradient(90deg, rgba(55, 53, 52, 0.8) 0%, rgba(50, 50, 50, 0.8) 100%);

            /* Buttons */
            --color-btn-hover-bg: #2d2b2a;     /* QML_ITEM_ALTERNATE_BG */
            --color-btn-active-bg: #424040;    /* slightly lighter */
        }

        /* Apply theme variables */
        html {
            background-color: var(--color-canvas-default);
        }

        body {
            background-color: var(--color-canvas-default);
            color: var(--color-fg-default);
        }

        .section {
            background-color: var(--color-canvas-default);
        }

        /* Dark mode text color overrides - ensure all text is visible */
        [data-theme="dark"] h1,
        [data-theme="dark"] h2,
        [data-theme="dark"] h3,
        [data-theme="dark"] h4,
        [data-theme="dark"] h5,
        [data-theme="dark"] h6,
        [data-theme="dark"] .title,
        [data-theme="dark"] .subtitle {
            color: var(--color-fg-default) !important;
        }

        [data-theme="dark"] p,
        [data-theme="dark"] span,
        [data-theme="dark"] div {
            color: var(--color-fg-default);
        }

        [data-theme="dark"] a {
            color: var(--color-accent-fg);
        }

        [data-theme="dark"] a:hover {
            color: var(--color-accent-emphasis);
        }

        [data-theme="dark"] strong,
        [data-theme="dark"] b {
            color: var(--color-fg-default);
        }

        [data-theme="dark"] small {
            color: var(--color-fg-muted);
        }

        [data-theme="dark"] .is-danger.is-light {
            background-color: #634646;
            color: var(--color-danger-fg);
        }

        .level-item .title {
            margin-bottom: 2rem;
            color: var(--color-fg-default);
        }
        .message-user {
            background-color: var(--color-message-user-bg);
            margin-right: 15%;
            border-left: 4px solid var(--color-message-user-border);
        }
        .message-ai {
            background-color: var(--color-message-ai-bg);
            margin-left: 15%;
            border-left: 4px solid var(--color-message-ai-border);
        }
        .feedback-submitted {
            opacity: 0.6;
            pointer-events: none;
            background-color: var(--color-canvas-subtle);
        }
        .feedback-submitted .button {
            pointer-events: auto;
        }
        .thumbs-button {
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.75rem;
            border: none;
            border-radius: 4px;
            background: transparent;
            transition: all 0.2s ease;
            color: var(--color-fg-default);
        }
        .thumbs-button:hover {
            background-color: var(--color-btn-hover-bg);
        }
        .thumbs-button.is-active {
            background-color: var(--color-danger-emphasis);
            color: var(--color-canvas-default);
        }
        .json-field {
            margin-bottom: 0.75rem;
        }
        .json-viewer {
            background: var(--color-canvas-subtle);
            padding: 1rem;
            border-radius: 4px;
            border: 1px solid var(--color-border-default);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: var(--color-fg-default);
        }
        .variable-section {
            border: 1px solid var(--color-border-default);
            border-radius: 4px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--color-canvas-subtle);
        }
        .variable-header {
            font-weight: bold;
            color: var(--color-fg-default);
            margin-bottom: 0.5rem;
            text-transform: capitalize;
        }
        .relationship-kind {
            display: inline-block;
            background: var(--color-accent-emphasis);
            color: var(--color-canvas-default);
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }
        .person-ref {
            background: var(--color-success-emphasis);
            color: var(--color-canvas-default);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.8rem;
            margin: 0.1rem;
            display: inline-block;
        }
        .shift-indicator {
            font-weight: bold;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.8rem;
        }
        .shift-up { background: var(--color-attention-emphasis); color: var(--color-canvas-default); }
        .shift-down { background: var(--color-danger-emphasis); color: var(--color-canvas-default); }
        .shift-same { background: var(--color-fg-muted); color: var(--color-canvas-default); }
        .shift-relationship { background: var(--color-attention-emphasis); color: var(--color-canvas-default); }
        .audit-stats {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--color-card-bg);
            padding: 0.5rem;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border: 1px solid var(--color-border-default);
            font-size: 0.8rem;
        }

        /* Audit Table Layout */
        .audit-table-container {
            padding: 0.5rem;
        }
        .audit-messages-table {
            margin-bottom: 0;
            background-color: var(--color-card-bg);
        }
        .audit-messages-table thead th {
            border-bottom: 2px solid var(--color-border-default);
            font-weight: 600;
            padding: 0.75rem;
            background-color: var(--color-canvas-subtle);
            color: var(--color-fg-default);
        }
        .audit-header {
            color: var(--color-fg-default);
            font-size: 1rem;
            font-weight: 600;
            text-align: left;
            vertical-align: middle;
        }
        
        /* Column-specific widths */
        .audit-header:nth-child(1),
        .audit-messages-table td:nth-child(1) {
            width: 30%; /* Conversational Flow */
        }
        
        .audit-header:nth-child(2),
        .audit-messages-table td:nth-child(2) {
            width: 30%; /* Extracted Data */
        }
        
        .audit-header:nth-child(3),
        .audit-messages-table td:nth-child(3) {
            width: 30%; /* Cumulative Notes */
        }

        /* Don't show [RENAMED] boxed label since prompts aren't really files. */
        .d2h-moved-tag {
            display: none;
        }
        
        /* Table Cell Styles */
        .chat-cell, .data-cell {
            vertical-align: top;
            padding: 0.75rem;
            border-bottom: 1px solid var(--color-border-muted);
            background-color: var(--color-card-bg);
        }
        .chat-cell {
            border-right: 1px solid var(--color-border-default);
        }
        /* Chat Message Layout */
        .chat-message-container {
            display: flex;
            align-items: flex-end;
            margin-bottom: 0.5rem;
            gap: 0.5rem;
        }
        .user-message-container {
            justify-content: flex-end;
        }
        .ai-message-container {
            justify-content: flex-start;
        }
        
        /* Message Bubbles */
        .user-message-bubble {
            background: var(--color-accent-emphasis);
            color: var(--color-canvas-default);
            padding: 0.75rem 1rem;
            border-radius: 18px 18px 4px 18px;
            max-width: 70%;
            font-size: 0.9rem;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .ai-message-bubble {
            background: var(--color-canvas-subtle);
            color: var(--color-fg-default);
            padding: 0.75rem 1rem;
            border-radius: 18px 18px 18px 4px;
            max-width: 70%;
            font-size: 0.9rem;
            line-height: 1.4;
            word-wrap: break-word;
            border: 1px solid var(--color-border-default);
        }
        .ai-message-bubble.expanded {
            max-width: 85%;
            background: var(--color-card-bg);
            border: 2px solid var(--color-success-emphasis);
        }
        .ai-message-bubble.is-clickable:hover {
            background: var(--color-btn-hover-bg);
            border-color: var(--color-success-emphasis);
        }
        
        /* Message Content */
        .ai-message-content {
            margin-bottom: 0;
        }
        .ai-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-border-default);
        }
        .ai-message-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            justify-content: flex-end;
        }
        
        /* Timestamps */
        .timestamp-left, .timestamp-right {
            min-width: 3rem;
            display: flex;
            align-items: flex-end;
        }
        .timestamp-left {
            justify-content: flex-end;
            padding-right: 0.5rem;
        }
        .timestamp-right {
            justify-content: flex-start;
            padding-left: 0.5rem;
        }
        
        /* Data Column Styles */
        .collapsed-data-section, .expanded-data-section {
            background: var(--color-card-bg);
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            padding: 0.75rem;
            font-size: 0.875rem;
        }
        .collapsed-data-section, .expanded-data-section {
            border-left: 3px solid var(--color-attention-emphasis);
        }
        .user-data-placeholder {
            padding: 1rem;
            text-align: center;
            background: var(--color-canvas-subtle);
            border-radius: 6px;
            color: var(--color-fg-muted);
        }

        /* Message Headers */
        .message-header, .data-header {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--color-fg-default);
        }
        .message-header .toggle-icon, .data-header .toggle-icon {
            margin-left: auto;
            transition: transform 0.2s ease;
        }
        .is-clickable:hover {
            background-color: var(--color-btn-hover-bg);
        }

        /* Message Content */
        .message-content {
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--color-fg-default);
        }
        
        /* Data Summary Styles */
        .data-summary {
            font-size: 0.8rem;
        }
        .variable-summary {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }
        .shift-indicator.is-small {
            font-size: 0.7rem;
            padding: 0.15rem 0.3rem;
        }
        
        /* Data Details Styles */
        .data-details {
            font-size: 0.8rem;
        }
        .section-header {
            color: var(--color-fg-default);
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-border-default);
            padding-bottom: 0.25rem;
        }
        .person-item, .event-item {
            background: var(--color-canvas-subtle);
            border-radius: 4px;
            font-size: 0.8rem;
        }
        .variables-compact {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.25rem;
        }
        .variable-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        /* Feedback Controls */
        .conversation-feedback, .data-feedback {
            background: var(--color-canvas-subtle);
            border-radius: 4px;
            border: 1px solid var(--color-border-default);
        }
        .conversation-feedback {
            border-left: 3px solid var(--color-accent-emphasis);
        }
        .data-feedback {
            border-left: 3px solid var(--color-attention-emphasis);
        }
        .thumbs-button.is-small {
            font-size: 1rem;
            padding: 0.5rem;
        }
        .textarea.is-small {
            font-size: 0.8rem;
        }
        .notification.is-small {
            padding: 0.75rem;
            font-size: 0.8rem;
        }
        
        /* Prompt editor button styles */
        .button.is-ghost {
            background: none;
            border: none;
            color: var(--color-fg-muted);
            padding: 0.25rem;
        }

        .button.is-ghost:hover {
            background-color: var(--color-btn-hover-bg);
            color: var(--color-fg-default);
        }

        
        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .audit-columns .column {
                font-size: 0.8rem;
            }
            .message-content {
                font-size: 0.8rem;
            }
        }
        
        /* Custom header theme matching login gradient */
        .navbar.is-primary {
            background: linear-gradient(135deg, var(--navbar-gradient-start) 0%, var(--navbar-gradient-end) 100%) !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .navbar.is-primary .navbar-brand > .navbar-item,
        .navbar.is-primary .navbar-brand .navbar-link {
            color: rgba(255, 255, 255, 0.95);
        }

        .navbar.is-primary .navbar-brand > a.navbar-item:focus,
        .navbar.is-primary .navbar-brand > a.navbar-item:hover,
        .navbar.is-primary .navbar-brand .navbar-link:focus,
        .navbar.is-primary .navbar-brand .navbar-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .navbar.is-primary .navbar-item,
        .navbar.is-primary .navbar-link {
            color: rgba(255, 255, 255, 0.95);
        }

        .navbar.is-primary a.navbar-item:focus,
        .navbar.is-primary a.navbar-item:hover,
        .navbar.is-primary .navbar-link:focus,
        .navbar.is-primary .navbar-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .navbar.is-primary a.navbar-item.is-active {
            background-color: transparent !important;
            color: #ffdd00 !important;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 221, 0, 0.9), 0 0 20px rgba(255, 221, 0, 0.6), 0 0 30px rgba(255, 221, 0, 0.3);
        }

        .navbar.is-primary .navbar-burger {
            color: rgba(255, 255, 255, 0.95);
        }

        .navbar.is-primary .navbar-burger span {
            background-color: rgba(255, 255, 255, 0.95);
        }

        [data-theme="dark"] .navbar.is-primary .navbar-burger span {
            background-color: rgba(255, 255, 255, 0.95) !important;
        }

        @media screen and (max-width: 1023px) {
            .navbar.is-primary .navbar-menu {
                background: linear-gradient(135deg, var(--navbar-gradient-start) 0%, var(--navbar-gradient-end) 100%);
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            }
        }
        
        /* Card headers with gradient accent */
        .card-header {
            background: var(--color-card-header-bg);
            border-bottom: 1px solid var(--color-border-default);
        }

        .card-header-title {
            color: var(--color-accent-fg);
            font-weight: 600;
        }

        /* Card body */
        .card {
            background-color: var(--color-card-bg);
            border: 1px solid var(--color-card-border);
        }

        .card-content {
            background-color: var(--color-card-bg);
            color: var(--color-fg-default);
        }

        /* Breadcrumb */
        .breadcrumb {
            background-color: var(--color-canvas-subtle) !important;
            border-bottom: 1px solid var(--color-border-default) !important;
        }

        .breadcrumb a {
            color: var(--color-accent-fg);
        }

        .breadcrumb a:not([href]) {
            color: var(--color-fg-default);
            cursor: default;
            text-decoration: none;
        }

        .breadcrumb li.is-active a {
            color: var(--color-fg-default);
        }
        
        /* Custom button styling to match theme */
        .button.is-success {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
            transition: all 0.2s ease;
        }
        
        .button.is-success:hover,
        .button.is-success.is-hovered {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
            transform: translateY(-1px);
        }
        
        .button.is-success:active,
        .button.is-success.is-active {
            background: linear-gradient(135deg, #4e5ec6 0%, #5e377e 100%);
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.4);
            transform: translateY(0);
        }
        
        /* Progress bars with gradient */
        .progress.is-success::-webkit-progress-value {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .progress.is-success::-moz-progress-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* Tags with theme colors */
        .tag.is-success {
            background: var(--color-success-emphasis);
            color: var(--color-canvas-default);
        }

        /* Approval badges should be green, not purple theme */
        .meta-controls .tag.is-success {
            background-color: var(--color-success-emphasis) !important;
            background: var(--color-success-emphasis) !important;
            color: #fff !important;
            width: 20px !important;
            height: 20px !important;
            min-width: 20px !important;
            min-height: 20px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 0 !important;
        }

        /* Hover effects for approval buttons to show unapproval */
        .meta-controls .tag.is-success:hover {
            background-color: var(--color-danger-emphasis) !important;
            background: var(--color-danger-emphasis) !important;
            color: #fff !important;
        }

        .tag.is-success.is-light {
            background: rgba(102, 126, 234, 0.1);
            color: var(--color-accent-fg);
        }

        /* Footer */
        .footer {
            background-color: var(--color-canvas-subtle);
            color: var(--color-fg-muted);
        }

        /* Dark mode toggle button */
        .theme-toggle {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.95);
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
        }

        .theme-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Bulma overrides for dark mode */
        [data-theme="dark"] .table {
            background-color: var(--color-card-bg);
            color: var(--color-fg-default);
        }

        [data-theme="dark"] .table td,
        [data-theme="dark"] .table th {
            border-color: var(--color-border-default);
            color: var(--color-fg-default);
        }

        /* Striped table alternating rows - Family Diagram style */
        [data-theme="dark"] .table.is-striped tbody tr:not(.is-selected):nth-child(odd) {
            background-color: var(--color-canvas-subtle); /* #2d2b2a - QML_ITEM_ALTERNATE_BG */
        }

        [data-theme="dark"] .table.is-striped tbody tr:not(.is-selected):nth-child(even) {
            background-color: var(--color-card-bg); /* #373534 - QML_ITEM_BG */
        }

        [data-theme="dark"] .table.is-striped tbody tr:hover {
            background-color: rgba(252, 245, 201, 0.1) !important; /* Subtle yellow hover */
        }

        [data-theme="dark"] .notification {
            background-color: var(--color-canvas-subtle);
            color: var(--color-fg-default);
        }

        [data-theme="dark"] .notification.is-info.is-light {
            background-color: rgba(252, 245, 201, 0.15);
            color: var(--color-accent-fg);
        }

        [data-theme="dark"] .notification.is-success.is-light {
            background-color: rgba(144, 238, 144, 0.15);
            color: var(--color-success-fg);
        }

        [data-theme="dark"] .notification.is-warning.is-light {
            background-color: rgba(252, 245, 201, 0.15);
            color: var(--color-attention-fg);
        }

        [data-theme="dark"] .input,
        [data-theme="dark"] .textarea,
        [data-theme="dark"] input,
        [data-theme="dark"] textarea,
        [data-theme="dark"] .select select {
            background-color: var(--color-canvas-subtle);
            border-color: var(--color-border-default);
            color: var(--color-fg-default);
        }

        [data-theme="dark"] .button {
            background-color: var(--color-canvas-subtle);
            border-color: var(--color-border-default);
            color: var(--color-fg-default);
        }

        [data-theme="dark"] .button:hover {
            background-color: var(--color-btn-hover-bg);
        }

        [data-theme="dark"] .modal-background {
            background-color: rgba(10, 10, 10, 0.86);
        }

        [data-theme="dark"] .modal-card {
            background-color: var(--color-card-bg);
        }

        [data-theme="dark"] .modal-card-head,
        [data-theme="dark"] .modal-card-foot {
            background-color: var(--color-canvas-subtle);
            border-color: var(--color-border-default);
        }

        [data-theme="dark"] .modal-card-title {
            color: var(--color-fg-default);
        }

        [data-theme="dark"] .modal-card-body {
            background-color: var(--color-card-bg);
            color: var(--color-fg-default);
        }

        [data-theme="dark"] .box {
            background-color: var(--color-card-bg);
            color: var(--color-fg-default);
            border-color: var(--color-border-default);
        }

        [data-theme="dark"] .dropdown-content {
            background-color: var(--color-card-bg);
            border-color: var(--color-border-default);
        }

        [data-theme="dark"] .dropdown-item {
            color: var(--color-fg-default);
        }

        [data-theme="dark"] .dropdown-item:hover {
            background-color: var(--color-btn-hover-bg);
        }

        [data-theme="dark"] .admin-tabbed-data,
        [data-theme="dark"] .tab-content-area {
            background-color: var(--color-card-bg);
            color: var(--color-fg-default);
        }

        [data-theme="dark"] .ai-message-bubble {
            background-color: var(--color-canvas-subtle) !important;
            color: var(--color-fg-default);
            border-color: var(--color-border-default);
        }

        [data-theme="dark"] .ai-message-bubble.expanded {
            background-color: var(--color-card-bg) !important;
            color: var(--color-fg-default);
        }

        [data-theme="dark"] .ai-message-bubble.is-clickable:hover {
            background-color: var(--color-btn-hover-bg) !important;
            border-color: var(--color-success-emphasis);
        }

        [data-theme="dark"] .expanded-data-section {
            background-color: var(--color-card-bg);
            color: var(--color-fg-default);
        }

        [data-theme="dark"] .has-background-light {
            background-color: var(--color-canvas-subtle) !important;
        }

        [data-theme="dark"] .has-background-link-light {
            background-color: var(--color-canvas-subtle) !important;
        }

        [data-theme="dark"] .has-background-white {
            background-color: var(--color-card-bg) !important;
        }

        [data-theme="dark"] .has-background-warning-light {
            background-color: rgba(252, 245, 201, 0.15) !important;
        }

        [data-theme="dark"] .has-background-success-light {
            background-color: rgba(144, 238, 144, 0.15) !important;
        }

        [data-theme="dark"] .has-background-info-light {
            background-color: rgba(252, 245, 201, 0.15) !important;
        }

        [data-theme="dark"] .inline-edit-input {
            background-color: var(--color-canvas-subtle);
            border-color: var(--color-border-default);
            color: var(--color-fg-default);
        }

        [data-theme="dark"] .tabs {
            border-color: var(--color-border-default);
        }

        [data-theme="dark"] .tabs a {
            color: var(--color-fg-default);
            border-color: var(--color-border-default);
        }

        [data-theme="dark"] .tabs a:hover {
            background-color: var(--color-btn-hover-bg);
            border-color: var(--color-border-default);
        }

        [data-theme="dark"] .tabs li.is-active a {
            background-color: var(--color-card-bg);
            border-color: var(--color-accent-emphasis);
            color: var(--color-accent-fg);
        }

        [data-theme="dark"] .tag.is-light {
            background-color: var(--color-canvas-subtle);
            color: var(--color-fg-default);
        }

        [data-theme="dark"] .tag.is-success.is-light {
            background-color: rgba(144, 238, 144, 0.2);
            color: var(--color-success-fg);
        }

        [data-theme="dark"] .tag.is-warning.is-light {
            background-color: rgba(252, 245, 201, 0.2);
            color: var(--color-attention-fg);
        }

        [data-theme="dark"] .tag.is-info {
            background-color: var(--color-accent-emphasis);
            color: var(--color-canvas-default);
        }

        [data-theme="dark"] .tag.is-warning {
            background-color: var(--color-attention-emphasis);
            color: var(--color-canvas-default);
        }

        [data-theme="dark"] .tag.is-success {
            background-color: var(--color-success-emphasis);
            color: var(--color-canvas-default);
        }

        [data-theme="dark"] .has-text-centered {
            color: var(--color-fg-default);
        }

        [data-theme="dark"] .has-text-grey {
            color: var(--color-fg-muted) !important;
        }

        [data-theme="dark"] .has-text-grey-light {
            color: var(--color-fg-subtle) !important;
        }

        [data-theme="dark"] .artifact-display {
            background-color: var(--color-card-bg);
            color: var(--color-fg-default);
            border-color: var(--color-border-default);
        }

        [data-theme="dark"] .chat-interface {
            background-color: var(--color-card-bg);
            color: var(--color-fg-default);
        }

        [data-theme="dark"] .select select:focus,
        [data-theme="dark"] .input:focus,
        [data-theme="dark"] .textarea:focus {
            border-color: var(--color-accent-emphasis);
        }

        [data-theme="dark"] .label {
            color: var(--color-fg-default);
        }

        [data-theme="dark"] .help {
            color: var(--color-fg-muted);
        }

        [data-theme="dark"] .thread-messages {
            background-color: var(--color-card-bg);
            color: var(--color-fg-default);
        }

        [data-theme="dark"] .results {
            background-color: var(--color-card-bg);
            color: var(--color-fg-default);
        }

        [data-theme="dark"] pre {
            background-color: var(--color-canvas-subtle);
            color: var(--color-fg-default);
        }

        [data-theme="dark"] code {
            background-color: var(--color-canvas-subtle);
            color: var(--color-accent-fg);
        }
    </style>
    {% block head %}{% endblock %}
</head>
<body>
    <nav class="navbar is-primary">
        <div class="navbar-brand">
            <a class="navbar-item" href="{{ url_for('training.training_root') }}">
                <strong>btcopilot | Family Diagram</strong>
            </a>
            
            <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarMenu">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>
        
        <div id="navbarMenu" class="navbar-menu">
            <div class="navbar-start">
                {% if current_user and current_user.has_role(btcopilot.ROLE_AUDITOR) %}
                <a class="navbar-item {% if request.endpoint and (request.endpoint.startswith('training.audit') or request.endpoint.startswith('training.discussions') or request.endpoint.startswith('training.analysis')) %}is-active{% endif %}" href="{{ url_for('training.audit.index') }}">
                    <span class="icon">
                        <i class="fas fa-tags"></i>
                    </span>
                    <span>Coding</span>
                </a>
                {% endif %}
                {% if current_user and current_user.has_role(btcopilot.ROLE_ADMIN) %}
                <a class="navbar-item {% if request.endpoint and request.endpoint.startswith('training.synthetic') %}is-active{% endif %}" href="{{ url_for('training.synthetic.index') }}">
                    <span class="icon">
                        <i class="fas fa-robot"></i>
                    </span>
                    <span>Synthetic</span>
                </a>
                <a class="navbar-item {% if request.endpoint and request.endpoint.startswith('training.prompts') %}is-active{% endif %}" href="{{ url_for('training.prompts.index') }}">
                    <span class="icon">
                        <i class="fas fa-flask"></i>
                    </span>
                    <span>Lab</span>
                </a>
                {% endif %}
                {% if current_user and current_user.has_role(btcopilot.ROLE_AUDITOR) %}
                <span class="navbar-item" style="border-left: 1px solid rgba(255,255,255,0.3); padding-left: 0; margin-left: 0.5rem;"></span>
                <a class="navbar-item {% if request.endpoint == 'training.account' %}is-active{% endif %}" href="{{ url_for('training.account') }}">
                    <span class="icon">
                        <i class="fas fa-user-circle"></i>
                    </span>
                    <span>Account</span>
                </a>
                {% endif %}
                {% if current_user and current_user.has_role(btcopilot.ROLE_ADMIN) %}
                <a class="navbar-item {% if request.endpoint and request.endpoint.startswith('training.admin') %}is-active{% endif %}" href="{{ url_for('training.admin.index') }}">
                    <span class="icon">
                        <i class="fas fa-shield-alt"></i>
                    </span>
                    <span>Admin</span>
                </a>
                {% endif %}
            </div>
        </div>

        <div class="navbar-end">
            {% if current_user %}
            <div class="navbar-item">
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">
                    <span class="icon">
                        <i class="fas fa-moon" id="theme-icon"></i>
                    </span>
                </button>
            </div>
            <div class="navbar-item">
                <span class="icon">
                    <i class="fas fa-user"></i>
                </span>
                <span>{{ current_user.username }}</span>
            </div>
            <div class="navbar-item">
                <form method="POST" action="{{ url_for('training.auth.logout') }}" style="display: inline;">
                    <button type="submit" class="navbar-item" style="background: none; border: none; color: white; cursor: pointer; padding: 0.5rem 0.75rem;">
                        <span class="icon">
                            <i class="fas fa-sign-out-alt"></i>
                        </span>
                        <span>Logout</span>
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
    </nav>
    
    <!-- Breadcrumb Navigation -->
    {% if breadcrumbs %}
    <nav class="breadcrumb has-arrow-separator" aria-label="breadcrumbs" style="padding: 0.75rem 1.5rem; background-color: var(--color-canvas-subtle); border-bottom: 1px solid var(--color-border-default);">
        <div class="container">
            <ul>
                {% for breadcrumb in breadcrumbs %}
                <li{% if loop.last %} class="is-active"{% endif %}>
                    {% if breadcrumb.url and not loop.last %}
                    <a href="{{ breadcrumb.url }}">{{ breadcrumb.title }}</a>
                    {% else %}
                    <a>{{ breadcrumb.title }}</a>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
    </nav>
    {% endif %}
    
    <section class="section">
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </section>
    
    <!-- Real-time updates via SSE (DISABLED) -->
    <!-- <div hx-ext="sse" sse-connect="/training/stream" sse-swap="none"></div> -->
    
    <script>
        // Mobile navbar toggle
        document.addEventListener('DOMContentLoaded', function() {
            // Get all "navbar-burger" elements
            const navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
            
            // Check if there are any navbar burgers
            if (navbarBurgers.length > 0) {
                // Add a click event on each of them
                navbarBurgers.forEach(el => {
                    el.addEventListener('click', () => {
                        // Get the target from the "data-target" attribute
                        const target = el.dataset.target;
                        const targetElement = document.getElementById(target);
                        
                        // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
                        el.classList.toggle('is-active');
                        targetElement.classList.toggle('is-active');
                    });
                });
            }
            
            // Debug HTMX SSE connection
            console.log('DOM loaded, checking HTMX SSE connection...');
            
            // Check if HTMX is loaded
            if (typeof htmx !== 'undefined') {
                console.log('HTMX is loaded');
            } else {
                console.error('HTMX is not loaded!');
            }
            
            // Add HTMX event listeners for SSE debugging
            document.body.addEventListener('htmx:sseConnect', function(event) {
                console.log('HTMX SSE connected:', event);
            });
            
            document.body.addEventListener('htmx:sseError', function(event) {
                console.error('HTMX SSE error:', event);
            });
            
            document.body.addEventListener('htmx:sseClose', function(event) {
                console.log('HTMX SSE closed:', event);
            });
            
            // Force HTMX to process the SSE element
            setTimeout(function() {
                const sseElement = document.getElementById('sse-connection');
                if (sseElement) {
                    console.log('Processing SSE element:', sseElement);
                    
                    // Check if SSE extension is loaded
                    if (typeof htmx.ext !== 'undefined' && htmx.ext.sse) {
                        console.log('HTMX SSE extension is loaded');
                    } else {
                        console.error('HTMX SSE extension is NOT loaded!');
                    }
                    
                    htmx.process(sseElement);
                    
                    // Add direct SSE event listener to the element
                    sseElement.addEventListener('sse:message', function(event) {
                        console.log('Direct SSE message on element:', event.detail);
                    });
                    
                    // Try to manually trigger SSE connection
                    console.log('Attempting to manually trigger SSE connection...');
                    htmx.trigger(sseElement, 'htmx:load');
                }
                
                // Fallback: Create native EventSource connection (DISABLED)
                // console.log('Creating fallback EventSource connection...');
                // try {
                //     const eventSource = new EventSource('/training/stream');
                //     
                //     eventSource.onopen = function(event) {
                //         console.log('Native EventSource connected:', event);
                //         showNotification('Real-time updates connected (native)', 'is-success');
                //     };
                //     
                //     eventSource.onmessage = function(event) {
                //         console.log('Native EventSource message:', event.data);
                //         try {
                //             const data = JSON.parse(event.data);
                //             handleSSEMessage(data);
                //         } catch (e) {
                //             console.log('Native EventSource parse error:', e);
                //         }
                //     };
                //     
                //     eventSource.onerror = function(event) {
                //         console.error('Native EventSource error:', event);
                //         if (eventSource.readyState === EventSource.CLOSED) {
                //             console.log('Native EventSource connection closed');
                //         }
                //     };
                //     
                // } catch (e) {
                //     console.error('Failed to create native EventSource:', e);
                // }
            }, 500);
        });

        // Alpine.js store for audit messages
        document.addEventListener('alpine:init', () => {
            Alpine.store('audit', {
                newMessages: [],
                addMessages(messages) {
                    console.log('Adding messages to Alpine store:', messages);
                    this.newMessages.push(...messages);
                    console.log('Alpine store now has', this.newMessages.length, 'new messages');
                }
            });
        });

        // Common SSE message handler
        function handleSSEMessage(data) {
            console.log('Handling SSE message:', data);
            if (data.type === 'new_feedback') {
                // Show notification
                showNotification('New feedback submitted', 'is-info');
                console.log('New feedback notification shown');
            } else if (data.type === 'new_message_pair') {
                // Append new message pair (user + AI) live if we're viewing that thread
                console.log('New message pair in discussion:', data.discussion_id);
                const currentDiscussionId = getCurrentDiscussionId();
                if (currentDiscussionId && currentDiscussionId == data.discussion_id) {
                    showNotification('New messages detected - adding to view...', 'is-info');
                    // Add to Alpine store
                    Alpine.store('audit').addMessages([
                        {
                            message: data.user_message,
                            has_conv_feedback: false,
                            has_ext_feedback: false,
                            pdp_deltas: null
                        },
                        {
                            message: data.ai_message,
                            has_conv_feedback: false,
                            has_ext_feedback: false,
                            pdp_deltas: data.ai_message.pdp_deltas
                        }
                    ]);
                    showNotification('New messages added to audit view', 'is-success');
                } else {
                    showNotification('New messages in another thread', 'is-info');
                }
            } else if (data.type === 'ping') {
                console.log('SSE ping received - connection alive');
            } else if (data.type === 'connected') {
                console.log('SSE connection established:', data.message);
                showNotification('Real-time updates connected', 'is-success');
            } else if (data.type === 'test') {
                console.log('SSE test message received:', data);
                showNotification('Test message received via SSE', 'is-info');
            } else {
                console.log('Unknown SSE message type:', data.type);
            }
        }

        // Handle SSE messages (HTMX)
        document.body.addEventListener('sse:message', function(event) {
            console.log('HTMX SSE message received:', event.detail);
            try {
                const data = JSON.parse(event.detail.data);
                handleSSEMessage(data);
            } catch (e) {
                console.log('HTMX SSE message parse error:', e, event.detail.data);
            }
        });

        function getCurrentDiscussionId() {
            const match = window.location.pathname.match(/\/thread\/(\d+)/);
            return match ? parseInt(match[1]) : null;
        }
        function showNotification(message, type = 'is-info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type} is-light`;
            notification.style.cssText = 'position: fixed; top: 70px; right: 20px; z-index: 1000; min-width: 300px;';
            notification.innerHTML = `
                <button class="delete" onclick="this.parentElement.remove()"></button>
                ${message}
            `;
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
    </script>
    
    <!-- Extraction Progress Scripts -->
    <script src="{{ url_for('training.audit.static', filename='js/extraction-progress.js') }}"></script>
    
    <!-- Version Footer -->
    <footer class="footer mt-6" style="padding: 1rem 1.5rem;">
        <div class="content has-text-centered">
            <p class="has-text-grey-light">
                <small>Version: {{ version }}</small>
            </p>
        </div>
    </footer>
    
    <script>
        // Configure HTMX to include CSRF token in all requests
        document.body.addEventListener('htmx:configRequest', function(evt) {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            evt.detail.headers['X-CSRFToken'] = csrfToken;
        });
        
        // Configure fetch requests to include CSRF token
        const originalFetch = window.fetch;
        window.fetch = function(url, options = {}) {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            if (!options.headers) {
                options.headers = {};
            }

            // Check if this is an external URL
            const isExternal = url.startsWith('http://') || url.startsWith('https://');
            const isSameOrigin = isExternal ? new URL(url).origin === window.location.origin : true;

            // Only add CSRF token to same-origin POST, PUT, PATCH, DELETE requests
            if (options.method && ['POST', 'PUT', 'PATCH', 'DELETE'].includes(options.method.toUpperCase())) {
                if (!isExternal || isSameOrigin) {
                    options.headers['X-CSRFToken'] = csrfToken;
                }
            }

            return originalFetch(url, options);
        };

        // Dark mode theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            document.cookie = `theme=${newTheme};path=/;max-age=31536000;SameSite=Lax`;

            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('theme-icon');
            if (icon) {
                if (theme === 'dark') {
                    icon.className = 'fas fa-sun';
                } else {
                    icon.className = 'fas fa-moon';
                }
            }
        }

        // Initialize theme icon on page load (theme already set server-side on <html>)
        (function initTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            updateThemeIcon(currentTheme);
        })();
    </script>
</body>
</html>