<div class="statement-analysis-row box mb-2 py-3" id="statement-{{ item.statement.id }}" data-statement-id="{{ item.statement.id }}">
    <div class="columns is-mobile mb-0">
        <!-- Column 1: Statement Text (25%) -->
        <div class="column is-3 py-2">
            <p class="heading is-size-7 mb-1">STATEMENT {{ item.statement.id }}</p>
            <a href="{{ url_for('training.discussions.audit', discussion_id=item.statement.discussion_id) }}#statement-{{ item.statement.id }}" class="statement-link">
                <div class="statement-preview {% if item.statement.speaker.type.value == 'subject' %}user-message-bubble speaker-{{ subject_speaker_map[item.statement.speaker.id] if item.statement.speaker and item.statement.speaker.id in subject_speaker_map else 1 }}{% else %}ai-message-bubble speaker-{{ expert_speaker_map[item.statement.speaker.id] if item.statement.speaker and item.statement.speaker.id in expert_speaker_map else 1 }}{% endif %}">
                    {{ item.statement.text }}
                </div>
            </a>
            <span class="tag is-info is-small">F1: {{ "%.2f"|format(item.breakdown.f1_metrics.aggregate_micro_f1) }}</span>
        </div>

        <!-- Columns 2-3: Side-by-side Expert and AI SARF Editor Blocks -->
        <div class="column is-6 py-2 analysis-column-divider">
            <div class="is-flex mb-2" style="gap: 0.5rem;">
                <div style="flex: 1;">
                    <div class="section-header is-size-7 has-text-weight-bold">EXPERT GROUND TRUTH</div>
                </div>
                <div class="analysis-column-divider" style="flex: 1; padding-left: 0.5rem;">
                    <div class="section-header is-size-7 has-text-weight-bold">AI EXTRACTION</div>
                </div>
            </div>

            <!-- PEOPLE SECTION -->
            {% if item.display_blocks.people %}
            <div class="analysis-section mb-3">
                <div class="section-header is-size-7 has-text-weight-bold mb-2 section-label">
                    <span class="icon is-small"><i class="fas fa-users"></i></span> People
                </div>
                {% for person in item.display_blocks.people %}
                <div class="is-flex mb-1" style="gap: 0.5rem;">
                    <!-- GT Person -->
                    <div style="flex: 1;">
                        {% if person.gt_person %}
                        <span class="tag is-success is-light is-small">{{ person.person_name }}</span>
                        {% endif %}
                    </div>
                    <!-- AI Person -->
                    <div class="analysis-column-divider" style="flex: 1; padding-left: 0.5rem;">
                        {% if person.ai_person %}
                        <span class="tag {% if person.match_type == 'TP' %}is-success{% elif person.match_type == 'FP' %}is-warning{% else %}is-light{% endif %} is-small">{{ person.person_name }}</span>
                        {% elif person.gt_person %}
                        <span class="has-text-danger is-size-7">❌ missed</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- EVENTS SECTION -->
            {% if item.display_blocks.events %}
            <div class="analysis-section">
                <div class="section-header is-size-7 has-text-weight-bold mb-2 section-label">
                    <span class="icon is-small"><i class="fas fa-calendar-alt"></i></span> Events
                </div>
                {% for event in item.display_blocks.events %}
                <div class="is-flex mb-2" style="gap: 0.5rem;">
                    <!-- GT Event Box -->
                    <div style="flex: 1;">
                        {% if event.gt_event %}
                        <div class="event-item p-2 has-background-light">
                            <table class="is-size-7" style="width: 100%; border: none; border-collapse: collapse;">
                                <tr>
                                    <td class="sarf-label">Kind:</td>
                                    <td class="sarf-value" title="{{ event.gt_event.kind or 'shift' }}">{{ (event.gt_event.kind or 'shift')|string|replace('EventKind.', '') }}</td>
                                </tr>
                                <tr>
                                    <td class="sarf-label">Person:</td>
                                    <td class="sarf-value">{{ event.person_name }}</td>
                                </tr>
                                {% if event.gt_event.dateTime %}
                                <tr>
                                    <td class="sarf-label">Date:</td>
                                    <td class="sarf-value">{{ event.gt_event.dateTime }}</td>
                                </tr>
                                {% endif %}
                                {% for sarf in event.gt_sarf %}
                                <tr>
                                    <td class="sarf-label">{{ sarf.variable_name|capitalize }}:</td>
                                    <td class="sarf-value" title="{{ sarf.value }}">{{ sarf.value|string|replace('RelationshipKind.', '') }}</td>
                                </tr>
                                    {% if sarf.variable_name == 'relationship' and sarf.targets %}
                                <tr>
                                    <td class="sarf-indent">→ Targets:</td>
                                    <td class="sarf-value">{{ sarf.targets|join(', ') }}</td>
                                </tr>
                                    {% endif %}
                                {% endfor %}
                            </table>
                        </div>
                        {% else %}
                        <div class="event-item p-2 has-background-light has-text-grey-light is-size-7">
                            (no GT event)
                        </div>
                        {% endif %}
                    </div>

                    <!-- AI Event Box -->
                    <div class="analysis-column-divider" style="flex: 1; padding-left: 0.5rem;">
                        {% if event.ai_event %}
                        <div class="event-item p-2 has-background-light">
                            <table class="is-size-7" style="width: 100%; border: none; border-collapse: collapse;">
                                <tr>
                                    <td class="sarf-label">Kind:</td>
                                    <td class="sarf-value" title="{{ event.ai_event.kind or 'shift' }}">
                                        <span class="{% if event.match_type == 'TP' %}has-text-success{% elif event.match_type == 'FP' %}has-text-danger{% endif %}">{{ (event.ai_event.kind or 'shift')|string|replace('EventKind.', '') }}</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="sarf-label">Person:</td>
                                    <td class="sarf-value">
                                        <span class="{% if event.match_type == 'TP' %}has-text-success{% elif event.match_type == 'FP' %}has-text-danger{% endif %}">{{ event.person_name }}</span>
                                    </td>
                                </tr>
                                {% if event.ai_event.dateTime %}
                                <tr>
                                    <td class="sarf-label">Date:</td>
                                    <td class="sarf-value">
                                        <span class="{% if event.match_type == 'TP' %}has-text-success{% elif event.match_type == 'FP' %}has-text-danger{% endif %}">{{ event.ai_event.dateTime }}</span>
                                    </td>
                                </tr>
                                {% endif %}
                                {% for sarf in event.ai_sarf %}
                                <tr>
                                    <td class="sarf-label">{{ sarf.variable_name|capitalize }}:</td>
                                    <td class="sarf-value" title="{{ sarf.value }}">
                                        <span class="{% if event.match_type == 'TP' %}has-text-success{% elif event.match_type == 'FP' %}has-text-danger{% endif %}">{{ sarf.value|string|replace('RelationshipKind.', '') }}</span>
                                    </td>
                                </tr>
                                    {% if sarf.variable_name == 'relationship' and sarf.targets %}
                                <tr>
                                    <td class="sarf-indent">→ Targets:</td>
                                    <td class="sarf-value"><span class="{% if event.match_type == 'TP' %}has-text-success{% elif event.match_type == 'FP' %}has-text-danger{% endif %}">{{ sarf.targets|join(', ') }}</span></td>
                                </tr>
                                    {% endif %}
                                {% endfor %}
                            </table>
                        </div>
                        {% elif event.gt_event %}
                        <div class="event-item p-2 has-background-light">
                            <span class="has-text-danger is-size-7">❌ missed</span>
                        </div>
                        {% else %}
                        <div class="event-item p-2 has-background-light has-text-grey-light is-size-7">
                            (no AI event)
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Column 4: Match Breakdown (25%) -->
        <div class="column is-3 py-2 analysis-column-divider">
            <p class="heading is-size-7 mb-1">MATCH BREAKDOWN</p>
            <div class="is-size-7">
                {% set people_tp = item.breakdown.people_matches|selectattr('match_type', 'equalto', 'TP')|list|length %}
                {% set people_fp = item.breakdown.people_matches|selectattr('match_type', 'equalto', 'FP')|list|length %}
                {% set people_fn = item.breakdown.people_matches|selectattr('match_type', 'equalto', 'FN')|list|length %}
                {% set events_tp = item.breakdown.event_matches|selectattr('match_type', 'equalto', 'TP')|list|length %}
                {% set events_fp = item.breakdown.event_matches|selectattr('match_type', 'equalto', 'FP')|list|length %}
                {% set events_fn = item.breakdown.event_matches|selectattr('match_type', 'equalto', 'FN')|list|length %}

                <div class="mb-1">
                    {% if people_tp > 0 %}<span class="tag is-success is-small mr-1">{{ people_tp }} People TP</span>{% endif %}
                    {% if people_fp > 0 %}<span class="tag is-warning is-small mr-1">{{ people_fp }} FP</span>{% endif %}
                    {% if people_fn > 0 %}<span class="tag is-danger is-small mr-1">{{ people_fn }} FN</span>{% endif %}
                </div>
                <div class="mb-2">
                    {% if events_tp > 0 %}<span class="tag is-success is-small mr-1">{{ events_tp }} Events TP</span>{% endif %}
                    {% if events_fp > 0 %}<span class="tag is-warning is-small mr-1">{{ events_fp }} FP</span>{% endif %}
                    {% if events_fn > 0 %}<span class="tag is-danger is-small mr-1">{{ events_fn }} FN</span>{% endif %}
                </div>

                <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.25rem 0.5rem; font-size: 0.75rem;">
                    <span class="has-text-weight-bold">S:</span><span>{{ "%.2f"|format(item.breakdown.f1_metrics.symptom_hierarchical.detection_f1) }}</span>
                    <span class="has-text-weight-bold">A:</span><span>{{ "%.2f"|format(item.breakdown.f1_metrics.anxiety_hierarchical.detection_f1) }}</span>
                    <span class="has-text-weight-bold">R:</span><span>{{ "%.2f"|format(item.breakdown.f1_metrics.relationship_hierarchical.detection_f1) }}</span>
                    <span class="has-text-weight-bold">F:</span><span>{{ "%.2f"|format(item.breakdown.f1_metrics.functioning_hierarchical.detection_f1) }}</span>
                </div>

                {% set has_errors = (people_fp + people_fn + events_fp + events_fn) > 0 %}
                {% if has_errors %}
                <details class="mt-2">
                    <summary class="is-size-7 has-text-link" style="cursor: pointer;">View Details</summary>
                    <ul class="is-size-7 mt-1 ml-3" style="list-style-type: disc;">
                        {% for match in item.breakdown.people_matches %}
                            {% if match.match_type in ['FP', 'FN'] %}
                                <li><strong>{{ match.match_type }}:</strong> {{ match.mismatch_reasons[0][:50] if match.mismatch_reasons else 'Unknown' }}</li>
                            {% endif %}
                        {% endfor %}
                        {% for match in item.breakdown.event_matches %}
                            {% if match.match_type in ['FP', 'FN'] %}
                                <li><strong>{{ match.match_type }}:</strong> {{ match.mismatch_reasons[0][:50] if match.mismatch_reasons else 'Unknown' }}</li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </details>
                {% endif %}
            </div>
        </div>
    </div>
</div>
