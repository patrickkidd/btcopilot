# T4-3: Add Discussion.status state machine

**Status:** Implemented, tests pass
**Date:** 2026-02-20

## Changes

Added `DiscussionStatus` enum with 6 states: `Pending`, `Generating`, `Failed`, `PendingExtraction`, `Extracting`, `Ready`.

### Model
- `btcopilot/personal/models/discussion.py`: Added `DiscussionStatus(StrEnum)` and `status` column with `server_default="pending"`
- `btcopilot/personal/models/__init__.py`: Exported `DiscussionStatus`

### Migration
- `alembic/versions/d4e5f6a7b8c9_add_discussion_status.py`: Creates enum type and adds column

### Status Transitions
- **Pending → Generating**: `ConversationSimulator` sets on Discussion creation (`synthetic.py`)
- **Generating → Ready**: `generate_synthetic_discussion` sets after successful run (`tasks.py`)
- **→ Extracting**: Set alongside `extracting=True` in `extract_discussion_statements` (`tasks.py`), manual extract trigger (`discussions.py:1163`), and re-extract all (`discussions.py:1332`)
- **Extracting → Ready**: Set alongside `extracting=False` when no remaining statements (`discussions.py:213`)
- **→ PendingExtraction**: Set when admin clears AI extracted data (`discussions.py:1512`)

### Test
- `test_extraction_sets_ready_status` in `test_background_extraction.py`: Verifies status transitions from Extracting → Ready when extraction completes

## Not Implemented
- `Failed` status: Would require Celery `on_failure` callback — deferred to when error recovery UX is needed
- `PendingExtraction` on normal discussion creation: Normal discussions start as `Pending` and go straight to `Extracting` when triggered

## Verification
- All 6 background extraction tests pass
- All 27 discussion route tests pass
- All 9 personal discussion tests pass
